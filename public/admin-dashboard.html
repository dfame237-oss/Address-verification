<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Locator â€” Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    
    <script>
        // Custom Tailwind config using the consistent 'tf-' palette
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ðŸ’œ Smart Locator/Teleforce Style Palette
                        'tf-primary': '#5F3DC4', // Deep Violet/Purple (New Primary)
                        'tf-secondary': '#A437C1', // Vibrant Magenta/Pink Accent (New Secondary)
                        'tf-dark': '#1f2937',
                        'tf-text': '#E2E8F0',
                        'tf-card': '#1E293B',
                        'tf-light': '#F1FFfa',
                        'tf-bg-light': '#F8FAFC',
                        'alert-dark': '#DC2626',
                        'tf-primary-light': '#EFE7FF',
                        'whatsapp-green': '#25D366',
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>

    <style>
        /* General Styles - Modernized Look (Inter is default font) */
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; }
        .dashboard-container { max-width: 1400px; margin: 30px auto; padding: 35px; background-color: white; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #E5E7EB; }
        .header h1 { font-size: 2.25rem; font-weight: 800; color: #1f2937; }

        /* Controls */
        .controls { display: flex; gap: 15px; align-items: center; }
        /* ðŸŸ£ CUSTOM INBOX ICON STYLE */
        #notification-icon {
            cursor: pointer; position: relative; 
            font-size: 20px; 
            color: #5F3DC4; /* Icon color */
            padding: 8px 12px; 
            border: 2px solid #EFE7FF; /* Light border */
            background-color: white;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        #notification-icon:hover { background-color: #EFE7FF; /* Light hover */ }

        .badge { position: absolute; top: -8px; right: -8px; background-color: #DC2626; color: white; border-radius: 50%; padding: 4px 8px; font-size: 11px; font-weight: 700; border: 2px solid white; }

        /* Tab Navigation - Critical Style Overrides */
        .nav-tabs { display: flex; border-bottom: 2px solid #E5E7EB; margin-bottom: 30px; }
        .tab-button { padding: 12px 20px; cursor: pointer; border: none; background: none; font-weight: 600; color: #64748B; border-bottom: 2px solid transparent; transition: color 0.3s, border-bottom 0.3s; }
        .tab-button.active { color: #5F3DC4; border-bottom: 2px solid #5F3DC4; }
        .tab-content { padding: 15px 0; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Action Buttons Overrides */
        .action-btn { background-color: #5F3DC4; color: white; padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: background-color 0.2s, transform 0.1s; margin-right: 5px; }
        .action-btn:hover { background-color: #4d2e97; transform: translateY(-1px); }
        .action-btn.delete { background-color: #DC2626; }
        .action-btn.delete:hover { background-color: #B91C1C; }
        .action-btn.modal-button { background-color: #A437C1; }
        .action-btn.modal-button:hover { background-color: #86259d; }
        .add-client-btn { background-color: #A437C1; color: white; padding: 10px 20px; border-radius: 8px; font-weight: 600; transition: background-color 0.2s; }
        .add-client-btn:hover { background-color: #86259d; }

        /* Table Styling */
        .client-table { width: 100%; border-collapse: separate; border-spacing: 0; background-color: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .client-table th, .client-table td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .client-table th { background-color: #F8FAFC; color: #374151; font-weight: 700; text-transform: uppercase; font-size: 0.85rem; }
        .client-table tbody tr:last-child td { border-bottom: none; }

        /* Statuses */
        .status-online-dot { color: #25D366; font-size: 10px; margin-right: 4px; }
        .status-enabled { background-color: #EFE7FF; color: #5F3DC4; padding: 4px 10px; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; }
        .status-disabled { background-color: #fee2e2; color: #DC2626; padding: 4px 10px; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; }
        .plan-credit-display { font-size: 1.8rem; font-weight: 800; color: #5F3DC4; }
        /* Modal Styles */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; display: none; }
        .modal-content { background-color: white; padding: 35px; border-radius: 12px; width: 90%; max-width: 720px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
        .modal-close { float: right; font-size: 1.8rem; cursor: pointer; color: #6b7280; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: #5F3DC4; box-shadow: 0 0 0 2px rgba(95, 61, 196, 0.12); }
        @media (max-width: 900px) {
            .client-table-wrapper { overflow-x: auto; width: 100%; }
            .client-table { min-width: 880px; }
        }
        /* --- INBOX STYLES --- */
        .message-card { 
            border: 1px solid #e5e7eb; padding: 15px; border-radius: 10px; margin-bottom: 12px; 
            cursor: pointer; transition: background-color 0.2s; 
            position: relative;
        }
        .message-card.unread { 
            background-color: #f7f3ff; 
            border-left: 6px solid #5F3DC4; /* Primary Brand Bar */
            box-shadow: 0 1px 5px rgba(95, 61, 196, 0.1);
        }
        .message-actions-container {
            position: absolute;
            top: 10px;
            right: 15px;
            display: flex;
            gap: 8px;
            opacity: 0; 
            transition: opacity 0.2s;
        }
        .message-card:hover .message-actions-container {
            opacity: 1;
        }
        .message-card-details {
             padding-right: 100px;
        }
        .inbox-tab-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 5px;
        }
        .inbox-tab-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            font-weight: 700;
            padding: 8px 0;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.2s, border-bottom 0.2s;
        }
        .inbox-tab-btn.active {
            color: #5F3DC4;
            border-bottom: 3px solid #5F3DC4;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="header">
            <h1><span class="text-tf-primary">Smart Locator</span> Admin Panel</h1>
            <div class="controls">
                <div id="notification-icon" title="Inbox" onclick="toggleInbox('support')">
                    <i class="fas fa-envelope-open-text"></i>
                    <span id="notification-badge" class="badge" style="display: none;">0</span>
                </div>
                <button onclick="logout()" class="action-btn delete">Logout</button>
            </div>
        </header>

        <div class="nav-tabs">
            <button id="tab-overview-btn" class="tab-button active" onclick="showTab('admin-overview', this)"><i class="fas fa-tachometer-alt mr-2"></i> Dashboard Overview</button>
            <button id="tab-clients-btn" class="tab-button" onclick="showTab('client-management', this)"><i class="fas fa-users-cog mr-2"></i> Manage Clients (CRM)</button>
            <button id="tab-inbox-btn" class="tab-button" onclick="showTab('inbox-support', this)"><i class="fas fa-headset mr-2"></i> Inbox & Support</button>
        </div>

        <div id="admin-overview" class="tab-content" style="display: block;">
            <h2 class="text-2xl font-bold mb-4 text-tf-primary border-b pb-2">System Metrics & Overview</h2>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6">
                <div class="bg-tf-primary-light p-6 rounded-xl border border-tf-primary/30">
                    <p class="text-gray-600 font-semibold mb-1">Total Clients</p>
                    <div id="metric-total-clients" class="plan-credit-display text-tf-primary">0</div>
                </div>
                <div class="bg-tf-primary-light p-6 rounded-xl border border-tf-primary/30">
                    <p class="text-gray-600 font-semibold mb-1">Clients Online Now</p>
                    <div id="metric-online-clients" class="plan-credit-display text-whatsapp-green">0</div>
                </div>
                <div class="bg-tf-primary-light p-6 rounded-xl border border-tf-primary/30">
                    <p class="text-gray-600 font-semibold mb-1">New Demo Requests</p>
                    <div id="metric-new-requests" class="plan-credit-display text-tf-secondary">0</div>
                </div>
                <div class="bg-tf-primary-light p-6 rounded-xl border border-tf-primary/30">
                    <p class="text-gray-600 font-semibold mb-1">Total Credits Issued (Est.)</p>
                    <div id="metric-credits-issued" class="plan-credit-display text-gray-500">N/A</div>
                </div>
            </div>
            
            <div class="mt-8 p-6 bg-white border rounded-xl shadow-md">
                 <h3 class="text-xl font-bold mb-3 text-tf-primary">Quick Actions</h3>
                 <button class="action-btn modal-button bg-tf-primary hover:bg-[#4d2e97] mr-3" onclick="openAddClientModal()">
                    <i class="fas fa-plus-circle mr-2"></i> Add New Client
                 </button>
                 <button class="action-btn bg-tf-secondary hover:bg-[#86259d] mr-3" onclick="showTab('client-management', document.getElementById('tab-clients-btn'))">
                    <i class="fas fa-list-alt mr-2"></i> View Client List
                 </button>
                 <button class="action-btn modal-button bg-tf-secondary hover:bg-[#86259d]" onclick="showTab('inbox-support', document.getElementById('tab-inbox-btn'))">
                    <i class="fas fa-inbox mr-2"></i> Check Inbox
                 </button>
            </div>

            <div class="mt-8 p-6 bg-white border rounded-xl shadow-md">
                <h3 class="text-xl font-bold mb-3 text-gray-700">Credit Consumption Rate </h3>
                <p class="text-sm text-gray-500">Visualization helps track subscription health and growth.</p>
            </div>
        </div>

        <div id="client-management" class="tab-content" style="display: none;">
            <div class="management-header">
                <h2 class="text-2xl font-bold text-gray-700 border-l-4 border-tf-secondary pl-3">Client Management & CRM</h2>
                <div>
                    <button class="add-client-btn" onclick="openAddClientModal()">
                        <i class="fas fa-plus-circle mr-2"></i> Add New Client
                    </button>
                    <button class="action-btn" onclick="loadClients()">
                        <i class="fas fa-sync-alt mr-1"></i> Refresh List
                    </button>
                </div>
            </div>

            <div class="client-table-wrapper">
                <table class="client-table">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Name / Contact</th>
                            <th>Plan / Credits</th>
                            <th>Status / Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="client-list">
                        <tr><td colspan="5" class="text-center text-gray-500 py-4">Click Refresh to load client data.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="inbox-support" class="tab-content" style="display: none;">
            <h2 class="text-2xl font-bold mb-4 text-tf-primary border-b pb-2">Inbox & Support</h2>
            
            <div class="inbox-tab-buttons">
                <button id="tab-messages-btn" class="inbox-tab-btn active" onclick="switchInboxTab('messages')"><i class="fas fa-envelope-open mr-2"></i> Client Messages</button>
                <button id="tab-support-btn" class="inbox-tab-btn" onclick="switchInboxTab('support')"><i class="fas fa-headset mr-2"></i> Demo Requests</button>
            </div>

            <div id="inbox-messages-container" class="max-h-[60vh] overflow-y-auto">
                <p class="text-center text-gray-500">Select a tab to load messages.</p>
            </div>
            
            <div id="reply-form" class="mt-6 p-4 bg-gray-50 border rounded-lg" style="display: none;">
                <h3 class="font-semibold text-xl mb-3">Send Reply to <span id="reply-to-client" class="text-tf-primary"></span></h3>
                <div class="form-group">
                    <input type="text" id="reply-subject" placeholder="Subject (Optional)">
                </div>
                <div class="form-group">
                    <textarea id="reply-body" rows="3" placeholder="Your reply message"></textarea>
                </div>
                <button class="action-btn modal-button w-full" onclick="sendMessage()">Send Reply</button>
                <p id="reply-status" class="mt-3 text-sm text-center"></p>
            </div>
        </div>


        <div id="update-client-modal" class="modal" aria-hidden="true">
            <div class="modal-content">
                <span class="modal-close" onclick="closeUpdateModal()">&times;</span>
                <h2 class="text-2xl font-bold mb-4 text-tf-primary">Update Client</h2>
                <form id="update-client-form">
                    <input type="hidden" id="update-client-id">
                    <div class="form-group">
                        <label for="update-plan"><i class="fas fa-tag mr-2"></i> Plan Name, Price & Credits</label>
                        <select id="update-plan" required></select>
                    </div>
                    <div class="form-group">
                        <label for="update-validity"><i class="fas fa-calendar-alt mr-2"></i> Validity End Date</label>
                        <input type="date" id="update-validity" required>
                    </div>
                    <div class="form-group">
                        <label for="update-password"><i class="fas fa-key mr-2"></i> New Password (leave blank to keep current)</label>
                        <input type="password" id="update-password">
                    </div>
                    <div class="form-group">
                        <label for="update-status"><i class="fas fa-toggle-on mr-2"></i> Account Status</label>
                        <select id="update-status" required>
                            <option value="true">Enabled</option>
                            <option value="false">Disabled</option>
                        </select>
                    </div>
                    <button type="submit" class="action-btn modal-button w-full">Apply Changes</button>
                    <p id="update-status-msg" class="mt-3 text-sm text-center"></p>
                </form>
            </div>
        </div>

        <div id="add-client-modal" class="modal" aria-hidden="true">
            <div class="modal-content">
                <span class="modal-close" onclick="closeAddClientModal()">&times;</span>
                <h2 class="text-2xl font-bold mb-4 text-tf-primary">Add New Client</h2>
                <form id="add-client-form">
                    <div class="form-group">
                        <label for="add-username"><i class="fas fa-user mr-2"></i> Username</label>
                        <input type="text" id="add-username" required>
                    </div>
                    <div class="form-group">
                        <label for="add-password"><i class="fas fa-lock mr-2"></i> Password</label>
                        <input type="password" id="add-password" required>
                    </div>
                    <div class="form-group">
                        <label for="add-clientName"><i class="fas fa-id-card mr-2"></i> Client Name</label>
                        <input type="text" id="add-clientName">
                    </div>
                    <div class="form-group">
                        <label for="add-email"><i class="fas fa-envelope mr-2"></i> Email</label>
                        <input type="email" id="add-email">
                    </div>
                    <div class="form-group">
                        <label for="add-mobile"><i class="fas fa-phone mr-2"></i> Mobile</label>
                        <input type="tel" id="add-mobile">
                    </div>
                    <div class="form-group">
                        <label for="add-plan"><i class="fas fa-tag mr-2"></i> Plan Name, Price & Credits</label>
                        <select id="add-plan" required></select>
                    </div>
                    <div class="form-group">
                        <label for="add-validity"><i class="fas fa-calendar-alt mr-2"></i> Validity End Date</label>
                        <input type="date" id="add-validity" required>
                    </div>
                    <div class="form-group">
                        <label for="add-initial-credits"><i class="fas fa-coins mr-2"></i> Initial Credits (optional override)</label>
                        <input type="text" id="add-initial-credits" placeholder="e.g., 10000 or Unlimited">
                    </div>
                    <button type="submit" class="action-btn modal-button w-full">Create Client</button>
                    <p id="add-status-msg" class="mt-3 text-sm text-center"></p>
                </form>
            </div>
        </div>

        <div id="topup-modal" class="modal" aria-hidden="true">
            <div class="modal-content">
                <span class="modal-close" onclick="closeTopupModal()">&times;</span>
                <h2 class="text-2xl font-bold mb-4 text-tf-primary">Top-up / Set Credits</h2>
                <div class="form-group">
                    <label for="topup-action">Action</label>
                    <select id="topup-action">
                        <option value="add">Add credits</option>
                        <option value="set">Set credits / Unlimited</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="topup-value">Value (number for add, number or 'Unlimited' for set)</label>
                    <input type="text" id="topup-value" placeholder="e.g., 10000 or Unlimited">
                </div>
                <div class="form-group">
                    <button class="action-btn modal-button w-full" onclick="confirmTopup()">Apply</button>
                </div>
                <p id="topup-status" class="text-center text-sm"></p>
            </div>
        </div>
    </div>

    <script>
        // --- PLAN & PRICING DATA MODEL (source: pubic pricing data js) ---
        const PLANS = [
            { name: 'Growth Starter', basePrice: 1000, credits: '10,000' },
            { name: 'Business Pro', basePrice: 2000, credits: '25,000' },
            { name: 'Enterprise Max', basePrice: 5000, credits: 'Unlimited' },
        ];
        const DURATIONS = [
            { months: 1, label: "1 Month", discount: 0 },
            { months: 3, label: "3 Months", discount: 0.20 },
            { months: 6, label: "6 Months", discount: 0.30 },
            { months: 12, label: "1 Year", discount: 0.40 },
        ];
        function calculatePrice(basePrice, months, discount) {
            const monthlyTotal = basePrice * months;
            const discountedTotal = monthlyTotal * (1 - discount);
            return Math.round(discountedTotal * 1.18); // 18% GST
        }

        // --- CONSTANTS AND STATE ---
        const API_BASE = '/api';
        const API_ADMIN = `${API_BASE}/admin/index`; 
        const AUTH_TOKEN = localStorage.getItem('adminToken');
        const ADMIN_ID = 'admin';
        let activeClients = [];
        let selectedClientId = null;
        let selectedClientUsername = null;
        let topupTargetClientId = null;
        let currentInboxTab = 'messages';
        const ONLINE_THRESHOLD_MS = 300000;

        // Redirect if no admin token
        if (!AUTH_TOKEN) {
            window.location.href = 'admin-login.html';
        }

        function logout() {
            localStorage.removeItem('adminToken');
            window.location.href = 'admin-login.html';
        }

        // --- UI / Plan helpers (Omitted for brevity) ---
        function generatePlanOptions() {
            const options = [];
            PLANS.forEach(plan => {
                DURATIONS.forEach(duration => {
                    const finalPrice = calculatePrice(plan.basePrice, duration.months, duration.discount);
                    const value = `${plan.name}_${finalPrice}_${duration.months}_Month_${plan.credits}`;
                    const label = `${plan.name} (${plan.credits} Credits) - â‚¹${finalPrice} (${duration.label}${duration.discount > 0 ? ` - ${duration.discount*100}% OFF` : ''})`;
                    options.push(`<option value="${value}">${label}</option>`);
                });
            });
            return options.join('');
        }

        function populatePlanDropdowns() {
            const optionsHtml = generatePlanOptions();
            document.getElementById('add-plan').innerHTML = optionsHtml;
            document.getElementById('update-plan').innerHTML = optionsHtml;

            document.getElementById('add-plan').addEventListener('change', (e) => updateValidityDate(e.target.value, 'add-validity'));
            document.getElementById('update-plan').addEventListener('change', (e) => updateValidityDate(e.target.value, 'update-validity'));

            const defaultAddPlanValue = document.getElementById('add-plan').value;
            if (defaultAddPlanValue) updateValidityDate(defaultAddPlanValue, 'add-validity');
        }

        // Calculate and set validity date based on plan value (e.g., Plan_1180_1_Month_10,000)
        function updateValidityDate(planValue, dateInputId) {
            if (!planValue) return;
            const parts = planValue.split('_');
            const durationMonths = parseInt(parts[2], 10);
            if (isNaN(durationMonths) || durationMonths === 0) return;

            const dateInput = document.getElementById(dateInputId);
            const now = new Date();
            const expirationDate = new Date(now.getFullYear(), now.getMonth() + durationMonths, now.getDate());
            if (expirationDate.getDate() !== now.getDate()) expirationDate.setDate(0);

            const year = expirationDate.getFullYear();
            const month = String(expirationDate.getMonth() + 1).padStart(2, '0');
            const day = String(expirationDate.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;
        }

        // --- Auth fetch wrapper for admin ---
        async function authFetch(url, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${AUTH_TOKEN}`,
            };
            const response = await fetch(url, { ...options, headers: { ...defaultHeaders, ...options.headers }});
            if (response.status === 401 || response.status === 403) {
                logout();
                throw new Error('Session expired');
            }
            return response;
        }

        // --- CLIENT MANAGEMENT LOGIC ---
        async function loadClients() {
            const clientListBody = document.getElementById('client-list');
            
            // 1. Silent fetch for data needed for metrics and background updates
            if (document.getElementById('client-management').style.display !== 'block') {
                try {
                    const response = await authFetch(`${API_ADMIN}?action=client`);
                    const result = await response.json();
                    if (result.status === "Success") {
                        activeClients = result.data;
                        updateOverviewMetrics(activeClients);
                    }
                } catch (e) {
                    // Ignore silent fetch errors
                }
                return;
            }

            // 2. Only update the table if we are on the Client Management tab
            clientListBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">Loading clients...</td></tr>';
            try {
                const response = await authFetch(`${API_ADMIN}?action=client`);
                const result = await response.json();
                if (result.status === "Success") {
                    activeClients = result.data;
                    renderClients(activeClients);
                    updateOverviewMetrics(activeClients); // Update metrics after loading clients
                } else {
                    clientListBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-4">Failed to load clients: ${result.message}</td></tr>`;
                }
            } catch (error) {
                console.error('Error loading clients:', error);
                clientListBody.innerHTML = `<tr><td colspan="5" class="text-center text-red-500 py-4">Network Error: ${error.message}</td></tr>`;
            }
        }

        function updateOverviewMetrics(clients) {
            const totalClients = clients.length;
            const activeClientsCount = clients.filter(c => c.isActive).length;
            const onlineClientsCount = clients.filter(c => c.lastActivityAt && (Date.now() - new Date(c.lastActivityAt).getTime() < ONLINE_THRESHOLD_MS)).length;
            
            const totalEl = document.getElementById('metric-total-clients');
            const activeEl = document.getElementById('metric-active-clients');
            const onlineEl = document.getElementById('metric-online-clients');
            const issuedEl = document.getElementById('metric-credits-issued');
            
            if (totalEl) totalEl.textContent = totalClients.toLocaleString();
            if (activeEl) activeEl.textContent = activeClientsCount.toLocaleString();
            if (onlineEl) onlineEl.textContent = onlineClientsCount.toLocaleString();
            if (issuedEl) issuedEl.textContent = 'â€”'; 
        }

        function formatLastActive(lastActivityAt) {
            if (!lastActivityAt) {
                return '<span class="status-offline-dot"><i class="far fa-circle"></i></span> <span class="status-offline-text">Never Logged In</span>';
            }
            const lastActiveTime = new Date(lastActivityAt).getTime();
            const now = Date.now();
            const difference = now - lastActiveTime;
            if (difference < ONLINE_THRESHOLD_MS) {
                return '<span class="status-online-dot"><i class="fas fa-circle"></i></span> <span class="status-online-text">Online Now</span>';
            } else {
                const formattedTime = new Date(lastActivityAt).toLocaleString();
                return `<span class="status-offline-dot"><i class="far fa-circle"></i></span> <span class="status-offline-text">Last seen: ${formattedTime}</span>`;
            }
        }

        function renderClients(clients) {
            const clientListBody = document.getElementById('client-list');
            clientListBody.innerHTML = ''; 
            if (!clients || clients.length === 0) {
                clientListBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No clients found.</td></tr>';
                return;
            }

            clients.forEach(client => {
                const isActive = client.isActive;
                const statusBadge = isActive ? `<span class="status-enabled">Enabled</span>` : `<span class="status-disabled">Disabled</span>`;
                const onlineStatusHtml = formatLastActive(client.lastActivityAt);

                const planParts = client.planName ? client.planName.split('_') : ['N/A','N/A','N/A','N/A','N/A'];
                const planDisplay = planParts[0];
                const creditsDisplay = planParts[4] || client.initialCredits || 'N/A';
                const remainingDisplay = client.remainingCredits == null ? 'â€”' : (client.remainingCredits === 'Unlimited' ? 'Unlimited' : Number(client.remainingCredits).toLocaleString());

                const row = `
                    <tr class="transition duration-150 ease-in-out hover:bg-gray-50">
                        <td class="font-semibold text-gray-900">${client.username}</td>
                        <td>${client.clientName || 'N/A'}<br><span class="text-sm text-gray-500">${client.email || 'N/A'} â€¢ ${client.mobile || 'â€”'}</span></td>
                        <td>${planDisplay} (${creditsDisplay})<br><span class="text-xs text-gray-500">Valid: ${client.validityEnd ? new Date(client.validityEnd).toLocaleDateString() : 'â€”'}</span><br><span class="text-sm text-gray-600">Remaining: <strong>${remainingDisplay}</strong></span></td>
                        <td>${statusBadge}<br><span class="text-sm font-medium flex items-center">${onlineStatusHtml}</span></td>
                        <td>
                            <button class="action-btn" onclick="openUpdateModal('${client._id}')"><i class="fas fa-edit mr-1"></i> Edit</button>
                            <button class="action-btn delete" onclick="deleteClient('${client._id}')"><i class="fas fa-trash-alt mr-1"></i> Remove</button>
                            <button class="action-btn modal-button" onclick="openReplyForm('${client._id}', '${client.username || ''}')"><i class="fas fa-reply mr-1"></i> Message</button>
                            <button class="action-btn" onclick="openTopupModal('${client._id}')"><i class="fas fa-coins mr-1"></i> Top-up</button>
                            <button class="action-btn modal-button" onclick="clearSession('${client._id}')"><i class="fas fa-sign-out-alt mr-1"></i> Clear Session</button>
                            <button class="action-btn" onclick="toggleActive('${client._id}', ${client.isActive ? 'false' : 'true'})">${client.isActive ? 'Disable' : 'Enable'}</button>
                        </td>
                    </tr>
                `;
                clientListBody.insertAdjacentHTML('beforeend', row);
            });
        }

        async function deleteClient(clientId) {
            const shouldDelete = await showConfirmModal("Are you sure you want to permanently delete this client?");
            if (!shouldDelete) return;
            try {
                const response = await authFetch(`${API_ADMIN}?action=client&clientId=${clientId}`, { method: 'DELETE' });
                const result = await response.json();
                if (response.ok && result.status === 'Success') {
                    showMessageModal('Client deleted successfully.', 'success');
                    loadClients();
                } else {
                    showMessageModal(`Deletion failed: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showMessageModal(`Network error: ${error.message}`, 'error');
            }
        }

        // --- Confirm & Message modal utilities ---
        let confirmResolve;
        function showConfirmModal(message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                const modalHtml = `
                    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1001]">
                        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
                            <p class="text-lg font-semibold text-gray-800 mb-6">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button id="confirm-no" class="py-2 px-4 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition">Cancel</button>
                                <button id="confirm-yes" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition">Delete</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                document.getElementById('confirm-yes').onclick = () => { document.getElementById('confirm-modal').remove(); confirmResolve(true); };
                document.getElementById('confirm-no').onclick = () => { document.getElementById('confirm-modal').remove(); confirmResolve(false); };
            });
        }

        function showMessageModal(message, type) {
            const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            const messageBox = document.createElement('div');
            messageBox.className = "fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50";
            messageBox.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-2xl w-80 text-center transform scale-100 transition-transform duration-300"><p class="font-bold text-lg text-white ${bgColor} p-3 rounded-lg">${message}</p></div>`;
            document.body.appendChild(messageBox);
            setTimeout(() => messageBox.remove(), 2500);
        }

        // --- Add client modal logic (Omitted for brevity) ---
        function openAddClientModal() { /* ... */ }
        function closeAddClientModal() { /* ... */ }
        // document.getElementById('add-client-form').addEventListener('submit', async (e) => { ... });

        // --- Update client modal logic (Omitted for brevity) ---
        function openUpdateModal(clientId) { /* ... */ }
        function closeUpdateModal() { /* ... */ }
        // document.getElementById('update-client-form').addEventListener('submit', async (e) => { ... });

        // --- Top-up modal logic (Omitted for brevity) ---
        function openTopupModal(clientId) { /* ... */ }
        function closeTopupModal() { /* ... */ }
        async function confirmTopup() { /* ... */ }

        // --- Clear session & toggle active (Omitted for brevity) ---
        async function clearSession(clientId) { /* ... */ }
        async function toggleActive(clientId, setActive) { /* ... */ }


        // --- Inbox & messaging logic ---
        async function loadInboxCounts() {
            let totalUnread = 0;
            // Get unread counts from client messages
            try {
                const msgResponse = await authFetch(`${API_BASE}/inbox/message`);
                const msgResult = await msgResponse.json();
                if (msgResult.status === "Success") {
                    const adminReceivedMessages = msgResult.messages.filter(m => m.receiverId === ADMIN_ID);
                    const unreadClientCount = adminReceivedMessages.filter(m => m.isRead === false).length;
                    totalUnread += unreadClientCount;
                }
            } catch (e) { console.error("Failed to load client message counts:", e); }

            // Get unread counts from demo requests
            try {
                const supportResponse = await authFetch(`${API_ADMIN}?action=support`);
                const supportResult = await supportResponse.json();
                if (supportResult.status === "Success") {
                    totalUnread += supportResult.unreadCount || 0;
                    // Update metric on the Overview tab if it exists
                    const reqEl = document.getElementById('metric-new-requests');
                    if (reqEl) reqEl.textContent = (supportResult.unreadCount || 0).toLocaleString();
                }
            } catch (e) { console.error("Failed to load support message counts:", e); }

            const badgeElement = document.getElementById('notification-icon').querySelector('.badge');
            if (totalUnread > 0) {
                badgeElement.textContent = totalUnread;
                badgeElement.style.display = 'block';
            } else {
                badgeElement.style.display = 'none';
            }
        }

        function showTab(tabId, button) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            if (button) button.classList.add('active');

            if (tabId === 'client-management') {
                loadClients(); 
            } else if (tabId === 'inbox-support') {
                loadInboxCounts();
                switchInboxTab('support'); 
            } else if (tabId === 'admin-overview') {
                 loadClients(); 
            }
        }

        // --- Inbox/Messaging Functions ---
        function switchInboxTab(tabType) {
            currentInboxTab = tabType;
            document.getElementById('tab-messages-btn').classList.remove('active');
            document.getElementById('tab-support-btn').classList.remove('active');
            if (tabType === 'messages') { 
                document.getElementById('tab-messages-btn').classList.add('active'); 
                loadClientMessages(); 
            }
            else { 
                document.getElementById('tab-support-btn').classList.add('active'); 
                loadSupportMessages(); 
            }
        }
        
        async function loadClientMessages() { 
            const msgContainer = document.getElementById('inbox-messages-container');
            msgContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Loading client messages...</p>';
            
            try {
                const response = await authFetch(`${API_BASE}/inbox/message`);
                const result = await response.json();
                
                if (result.status === "Success") {
                    const receivedMessages = result.messages.filter(m => m.receiverId === ADMIN_ID);
                    msgContainer.innerHTML = '';
                    if (receivedMessages.length === 0) { msgContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No authenticated messages from clients.</p>'; return; }
                    
                    receivedMessages.forEach(msg => {
                        const isUnread = !msg.isRead;
                        const clientName = activeClients.find(c => c._id === msg.senderId)?.username || 'Unknown Client';
                        const messageHtml = `
                             <div class="message-card p-4 border border-gray-200 rounded-lg ${isUnread ? 'unread bg-tf-primary-light' : 'bg-white'}">
                                <div class="message-card-details">
                                     <p class="text-md font-bold">${msg.subject || '(No Subject)'} 
                                         ${isUnread ? '<span class="text-sm font-extrabold text-tf-primary ml-2">(NEW)</span>' : ''}
                                     </p>
                                     <p class="text-sm text-gray-600">From: <strong>${clientName}</strong> &bull; ${new Date(msg.timestamp).toLocaleString()}</p>
                                </div>
                                <div class="message-actions-container">
                                     <button onclick="viewClientMessage('${msg._id}', '${(msg.subject||'').replace(/'/g,"\\'")}', \`${(msg.body||'').replace(/`/g,'\\`')}\`, '${msg.senderId}', '${clientName}', ${isUnread}, '${msg.timestamp}')" 
                                             class="action-btn modal-button bg-tf-primary hover:bg-[#4d2e97]"><i class="fas fa-eye"></i></button>
                                     <button onclick="deleteMessage('${msg._id}', 'client')" 
                                             class="action-btn delete"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                        msgContainer.insertAdjacentHTML('beforeend', messageHtml);
                    });
                } else {
                    msgContainer.innerHTML = `<p class="text-center text-red-500 py-4">Failed to load client inbox: ${result.message}</p>`;
                }
            } catch (error) {
                msgContainer.innerHTML = `<p class="text-center text-red-500 py-4">Network Error: ${error.message}</p>`;
            }
        }

        async function loadSupportMessages() { 
            const msgContainer = document.getElementById('inbox-messages-container');
            msgContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Loading demo requests...</p>';
            
            try {
                const response = await authFetch(`${API_ADMIN}?action=support`);
                const result = await response.json();
                
                if (result.status === "Success") {
                    const supportMessages = result.messages || [];
                    msgContainer.innerHTML = '';
                    if (supportMessages.length === 0) { msgContainer.innerHTML = '<p class="text-center text-gray-500 py-4">No demo requests or public inquiries.</p>'; return; }
                    
                    supportMessages.forEach(msg => {
                        const isUnread = !msg.isRead;
                        const senderInfo = `${msg.clientName || 'N/A'} (${msg.clientEmail || 'N/A'})`;
                        const messageHtml = `
                            <div class="message-card p-4 border border-gray-200 rounded-lg ${isUnread ? 'unread bg-tf-primary-light' : 'bg-white'}">
                                <div class="message-card-details">
                                    <p class="text-md font-bold text-tf-secondary">
                                        Inquiry from: ${msg.clientName || 'N/A'} 
                                        ${isUnread ? '<span class="text-sm font-extrabold text-tf-primary ml-2">(NEW)</span>' : ''}
                                    </p>
                                    <p class="text-sm text-gray-600 truncate">
                                        Requirement: ${String(msg.messageText||'').substring(0,60)}...
                                    </p>
                                    <small class="text-gray-500 block mt-1">Email: ${msg.clientEmail} &bull; ${new Date(msg.receivedAt).toLocaleString()}</small>
                                </div>
                                <div class="message-actions-container">
                                    <button onclick="viewSupportMessage('${msg._id}', \`${(msg.messageText||'').replace(/`/g,'\\`')}\', '${(msg.clientName||'').replace(/'/g,"\\'")}', '${(msg.clientEmail||'').replace(/'/g,"\\'")}', '${(msg.clientMobile||'').replace(/'/g,"\\'")}', ${isUnread}, '${msg.receivedAt}')" 
                                            class="action-btn modal-button bg-tf-primary hover:bg-[#4d2e97]"><i class="fas fa-eye"></i></button>
                                    <button onclick="deleteMessage('${msg._id}', 'support')" 
                                            class="action-btn delete"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                        `;
                        msgContainer.insertAdjacentHTML('beforeend', messageHtml);
                    });
                } else {
                    msgContainer.innerHTML = `<p class="text-center text-red-500 py-4">Failed to load requests: ${result.message}</p>`;
                }
            } catch (error) {
                msgContainer.innerHTML = `<p class="text-center text-red-500 py-4">Network Error: ${error.message}</p>`;
            }
        }
        
        // FIX: Separated view function logic to avoid the 'Cannot read properties of null (reading style)' error
        function viewClientMessage(messageId, subject, body, senderId, clientUsername, isUnread, timestamp) {
            // Mark as read immediately (client message uses inbox API)
            if (isUnread) authFetch(`${API_BASE}/inbox/message?messageId=${messageId}`, { method: 'PUT' }).catch(()=>{});
            setTimeout(loadClientMessages, 200); // Refresh list
            
            const messageContent = `
                <div id="message-view-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1001]">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                        <h3 class="text-xl font-bold mb-2 text-tf-primary">Client Message: ${subject}</h3>
                        <p class="text-sm text-gray-600 mb-3">From: <strong>${clientUsername}</strong> | Date: ${new Date(timestamp).toLocaleString()}</p>
                        <div class="p-4 bg-gray-50 border rounded whitespace-pre-wrap">${body}</div>
                        <div class="mt-4 flex justify-end">
                            <button onclick="document.querySelector('#message-view-modal').remove()" class="action-btn delete">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', messageContent);
            openReplyForm(senderId, clientUsername); // Open reply form in the background
        }

        function viewSupportMessage(messageId, messageText, clientName, clientEmail, clientMobile, isUnread, receivedAt) {
            // Mark as read immediately (support request uses admin API)
            if (isUnread) authFetch(`${API_ADMIN}?action=support&messageId=${messageId}`, { method: 'PUT' }).catch(()=>{});
            setTimeout(loadSupportMessages, 200); // Refresh list
            
            const messageContent = `
                <div id="message-view-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[1001]">
                    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
                        <h3 class="text-xl font-bold mb-2 text-tf-secondary">Demo/Support Request</h3>
                        <p class="text-sm text-gray-600">Name: <strong>${clientName || 'N/A'}</strong></p>
                        <p class="text-sm text-gray-600">Email: <strong>${clientEmail || 'N/A'}</strong></p>
                        <p class="text-sm text-gray-600 mb-3">Mobile: <strong>${clientMobile || 'N/A'}</strong> | Received: ${new Date(receivedAt).toLocaleString()}</p>
                        <div class="p-4 bg-gray-50 border rounded whitespace-pre-wrap">${messageText}</div>
                        <div class="mt-4 flex justify-end">
                            <a href="mailto:${clientEmail}" target="_blank" class="action-btn modal-button mr-2 bg-tf-primary hover:bg-indigo-600">Reply via Email</a>
                            <a href="https://wa.me/91${clientMobile}" target="_blank" class="action-btn modal-button mr-2 bg-whatsapp-green hover:bg-green-600">WhatsApp</a>
                            <button onclick="document.querySelector('#message-view-modal').remove()" class="action-btn delete">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', messageContent);
        }

        function openReplyForm(clientId, username) {
            selectedClientId = clientId; selectedClientUsername = username;
            // The modal is already open, just switch the content
            document.getElementById('inbox-title').textContent = `Send Reply`;
            document.getElementById('reply-to-client').textContent = username;
            document.getElementById('reply-form').style.display = 'block';
            document.getElementById('inbox-messages-container').style.display = 'none';
            document.getElementById('reply-subject').value = '';
            document.getElementById('reply-body').value = '';
            document.getElementById('reply-status').textContent = '';
        }
        
        async function sendMessage() { /* ... */ } // Logic omitted for brevity
        async function deleteClient(clientId) { /* ... */ } // Logic omitted for brevity
        async function clearSession(clientId) { /* ... */ } // Logic omitted for brevity
        async function toggleActive(clientId, setActive) { /* ... */ } // Logic omitted for brevity
        async function confirmTopup() { /* ... */ } // Logic omitted for brevity
        function openUpdateModal(clientId) { /* ... */ } // Logic omitted for brevity
        function closeUpdateModal() { /* ... */ } // Logic omitted for brevity
        function openAddClientModal() { /* ... */ } // Logic omitted for brevity
        function closeAddClientModal() { /* ... */ } // Logic omitted for brevity
        
        async function deleteMessage(messageId, type) {
            let endpoint;
            let confirmMessage;
            
            if (type === 'support') {
                endpoint = `${API_ADMIN}?action=support&messageId=${messageId}`;
                confirmMessage = "Are you sure you want to delete this Demo Request permanently?";
            } else {
                endpoint = `${API_BASE}/inbox/message?messageId=${messageId}`; 
                confirmMessage = "Are you sure you want to delete this Client Message permanently?";
            }
            
            const shouldDelete = await showConfirmModal(confirmMessage);
            if (!shouldDelete) return;

            try {
                // FIX: Use DELETE method for deletion, addressing 405 error
                const response = await authFetch(endpoint, { method: 'DELETE' }); 
                const result = await response.json().catch(() => ({ message: "Delete failed (non-JSON response)." }));

                if (response.ok && result.status === 'Success') {
                    showMessageModal('Message deleted.', 'success');
                    switchInboxTab(currentInboxTab); 
                } else {
                    showMessageModal(`Deletion failed: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showMessageModal(`Network error: ${error.message}`, 'error');
            }
        }

        // --- Initialization ---
        window.onload = () => {
            populatePlanDropdowns();
            // Default to loading the Dashboard Overview and fetching data
            showTab('admin-overview', document.getElementById('tab-overview-btn'));
            setInterval(loadClients, 30000); 
            setInterval(loadInboxCounts, 60000);
        };
    </script>
</body>
</html>