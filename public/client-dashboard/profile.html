<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Locator â€” Profile & Plan Status</title>
    
    <link rel="stylesheet" href="../style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            'tf-primary': '#5F3DC4', 
                            'tf-secondary': '#A437C1', 
                            'tf-dark': '#0F172A',
                            'tf-text': '#E2E8F0',
                            'tf-card': '#1E293B',
                            'tf-light': '#F1F5F9',
                            'whatsapp-green': '#25D366',
                            'alert-dark': '#EF4444',
                            'alert-light': '#FEE2E2',
                            'success-light': '#D1FAE5',
                            'tf-primary-light': '#EFE7FF',
                        },
                        fontFamily: {
                            sans: ['Inter', 'sans-serif'],
                        },
                    }
                }
            }
        };
    </script>
    <style>
        /* CSS from client-dashboard.html needed for consistent modular page styling */
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; }
        .dashboard-container { max-width: 1200px; margin: 30px auto; padding: 35px; background-color: white; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); padding-bottom: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #E5E7EB; }
        .main-dashboard-layout { display: grid; grid-template-columns: 240px 1fr; gap: 30px; }
        .sidebar-nav { background-color: #F8FAFC; padding: 15px 0; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: fit-content; }
        .sidebar-header { padding: 0 20px 10px; border-bottom: 1px solid #E2E8F0; }
        .sidebar-section-title { font-size: 0.8rem; font-weight: 700; color: #64748B; margin-top: 20px; margin-bottom: 5px; padding: 0 20px; text-transform: uppercase; }
        .nav-tabs { display: block; border-bottom: none; margin-bottom: 0; }
        .nav-tabs .nav-link, .nav-tabs .tab-button { display: flex; align-items: center; width: 100%; text-align: left; padding: 12px 20px; border-left: 4px solid transparent; color: #1E293B; font-weight: 500; transition: background-color 0.2s, border-left 0.2s; text-decoration: none; }
        .nav-tabs .nav-link:hover, .nav-tabs .tab-button:hover { background-color: #EFE7FF; }
        .nav-tabs .nav-link.active, .nav-tabs .tab-button.active { color: #5F3DC4; background-color: #EFE7FF; border-left: 4px solid #5F3DC4; font-weight: 700; }
        .tab-content-area { padding-bottom: 35px; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .profile-card, .plan-card { background-color: #F8FAFC; padding: 30px; border-radius: 12px; border: 1px solid #E2E8F0; transition: box-shadow 0.2s; }
        .action-btn { background-color: #5F3DC4 !important; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
        .action-btn.logout { background-color: #DC2626 !important; }
        .plan-status-badge { display: inline-block; padding: 6px 14px; border-radius: 9999px; font-size: 0.85rem; font-weight: 700; }
        .status-enabled { background-color: #EFE7FF; color: #5F3DC4; }
        .status-disabled { background-color: #FEE2E2; color: #DC2626; }
        /* Include modal styles and other shared definitions here */
    </style>
</head>
<body>
    <div class="dashboard-container text-gray-800">
        <header class="header">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Welcome, <span id="client-name-display" class="text-tf-primary">Client</span></h1>
                <div class="text-sm text-gray-500 mt-1">Manage your address verifications and plan here.</div>
            </div>
            <div class="controls">
                <button id="inbox-header-btn" onclick="toggleInbox()" aria-label="Open Inbox" role="button">
                    <i class="fas fa-envelope-open-text"></i><span id="inbox-badge" class="badge" style="display:none;">0</span>
                </button>
                <button onclick="logout()" class="action-btn logout" aria-label="Logout" role="button">Logout</button>
            </div>
        </header>
        
        <div class="main-dashboard-layout">
            
            <aside id="sidebar" class="sidebar-nav">
                <div class="sidebar-header"><h4 class="text-lg font-bold text-tf-dark">Dashboard Menu</h4></div>
                <div class="nav-tabs vertical" role="tablist">
                    
                    <h5 class="sidebar-section-title">Core Operations</h5>
                    
                    <a href="../client-dashboard.html" class="nav-link" role="tab" aria-selected="false"><i class="fas fa-file-upload mr-2"></i> Bulk Verification</a>
                    <a href="in-progress.html" class="nav-link" role="tab" aria-selected="false"><i class="fas fa-hourglass-half mr-2"></i> In Progress</a>
                    <a href="completed.html" class="nav-link" role="tab" aria-selected="false"><i class="fas fa-check-circle mr-2"></i> Completed</a>
                    
                    <h5 class="sidebar-section-title">Analytics & Account</h5>
                    
                    <a href="reports.html" class="nav-link" role="tab" aria-selected="false"><i class="fas fa-chart-bar mr-2"></i> Key Metrics & Usage</a>
                    
                    <a href="profile.html" class="nav-link active" role="tab" aria-selected="true"><i class="fas fa-user-circle mr-2"></i> Profile & Plan Status</a>
                    
                    <a href="support.html" class="nav-link" role="tab" aria-selected="false"><i class="fas fa-headset mr-2"></i> Support</a>
                </div>
            </aside>
            
            <main id="main-content" class="tab-content-area">
                <div id="profile-plan" class="tab-content active" role="tabpanel">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Account Overview</h2>
                    
                    <div class="info-grid">
                        <div class="profile-card flex flex-col justify-between">
                            <h3 class="text-xl font-semibold text-tf-primary mb-4 flex items-center"><i class="fas fa-user-circle mr-2"></i> My Profile Details</h3>
                            <div class="space-y-3">
                                <div class="info-item"><p><strong>Username:</strong> <span id="profile-username"></span></p></div>
                                <div class="info-item"><p><strong>Email:</strong> <span id="profile-email"></span></p></div>
                                <div class="info-item"><p><strong>Mobile:</strong> <span id="profile-mobile"></span></p></div>
                                <div class="info-item"><p><strong>Access Code:</strong> <span id="profile-bulk-code"></span></p></div>
                            </div>
                            <button class="action-btn mt-6 w-full bg-gray-500 text-white hover:bg-gray-600" onclick="openPasswordModal()" role="button" aria-label="Change Account Password">Change Password</button>
                        </div>
                        
                        <div class="plan-card">
                            <h3 class="text-xl font-semibold text-tf-secondary mb-4 flex items-center"><i class="fas fa-award mr-2"></i> Plan Status</h3>
                            <div class="space-y-3">
                                <div class="info-item"><p><strong>Current Plan:</strong> <span id="plan-name" class="font-bold"></span></p></div>
                                <div class="info-item"><p><strong>Status:</strong> <span id="account-status"></span></p></div>
                                <div class="info-item"><p><strong>Valid Until:</strong> <span id="validity-end"></span></p></div>
                                <div class="info-item"><p><strong>Remaining Credits:</strong> <span id="plan-remaining-credits" class="font-bold text-tf-secondary">N/A</span></p></div>
                            </div>
                            <a href="support.html" class="action-btn mt-6 w-full bg-tf-secondary hover:bg-[#86259d]" role="button" aria-label="Contact support for renewal">Contact for Renewal</a>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="inbox-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="inbox-title">
        <div class="modal-content w-full max-w-lg rounded-xl shadow-2xl p-6 bg-white relative">
            <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeInbox()">&times;</span>
            <h2 class="text-3xl font-bold mb-6 text-tf-primary flex items-center" id="inbox-title">
                <i class="fas fa-envelope-open-text mr-3"></i> Client Inbox
            </h2>
            <div id="client-inbox-list" class="mt-4 max-h96 overflow-y-auto space-y-3">
                <p class="text-center text-gray-500 mt-5">Loading messages...</p>
            </div>
            <div id="full-message-detail" class="mt-6 pt-4" style="display:none;">
                <h3 id="full-message-subject" class="font-bold text-xl mb-1"></h3>
                <small id="full-message-date" class="text-gray-500 block mb-4"></small>
                <div id="full-message-body" class="p-4 border rounded bg-gray-50 whitespace-pre-wrap text-gray-700 max-h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>
    
    <div id="password-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="password-title">
        <div class="modal-content">
            <span class="modal-close" onclick="closePasswordModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-tf-primary" id="password-title">Change Your Password</h2>
            <form id="password-update-form" class="space-y-4">
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="newPassword" required minlength="6" class="w-full p-3 border rounded input-focus">
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" required minlength="6" class="w-full p-3 border rounded input-focus">
                </div>
                <button type="submit" id="updatePasswordBtn" class="action-btn w-full bg-red-600 hover:bg-red-700" role="button">Update & Log Out</button>
                <p id="password-update-status" class="mt-3 text-sm text-center text-gray-700"></p>
            </form>
            <p class="text-xs text-center text-gray-500 mt-4">Note: Changing your password will immediately log you out of all devices for security.</p>
        </div>
    </div>

    <div id="force-logout-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="force-logout-title">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="force-logout-title">Another device is logged in</h3>
            <p class="text-gray-700">It looks like your account is currently active on another device.
            You can force-logout that session and continue here, or cancel to remain logged out.</p>
            <div class="modal-actions">
                <button id="forceCancelBtn" class="py-2 px-4 bg-gray-200 rounded-lg" onclick="closeForceModal()" role="button">Cancel</button>
                <button id="forceConfirmBtn" class="py-2 px-4 bg-red-600 text-white rounded-lg" onclick="forceLogoutOtherDevice()" role="button">Logout other device & Continue</button>
            </div>
        </div>
    </div>
    
    <script src="../bulk_verification_logic.js"></script>
    <script>
        // --- CONSTANTS AND STATE ---
        const API_BASE = '/api';
        const API_CLIENT = `${API_BASE}/client/index`;
        const API_ENDPOINT = "/api/verify-single-address"; // used by single verification
        const LOGIN_PAGE = "../client-login.html"; // Corrected relative path for login page
        // API_BULK_JOBS is assumed to be defined globally in bulk_verification_logic.js.
        
        let planDetails = JSON.parse(localStorage.getItem('planDetails') || '{}');
        const CLIENT_NAME = localStorage.getItem('clientName') || planDetails.clientName || planDetails.username || 'Client';
        let isPlanValid = true;
        
        const initialToken = localStorage.getItem('clientToken');
        if (!initialToken) {
            window.location.href = LOGIN_PAGE;
        }

        let activeJobPollInterval; 
        let globalJobsData = { inProgress: [], completed: [] }; // Storage for filtering (NEW)

        // --- HEARTBEAT FUNCTION (PUBLIC) ---
        async function sendHeartbeat() {
            const currentToken = localStorage.getItem('clientToken');
            if (!currentToken) return;
            try {
                await authFetch(`${API_CLIENT}?action=activity`, { method: 'POST' });
            } catch (e) {
                console.warn("Heartbeat failed, session may be invalid:", e);
            }
        }

        // --- LOGOUT (PUBLIC) ---
        async function logout() {
            const tokenToNotify = localStorage.getItem('clientToken');
            try {
                if (tokenToNotify) {
                    await fetch(`${API_CLIENT}?action=logout`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${tokenToNotify}`,
                            'Content-Type': 'application/json'
                        }
                    });
                }
            } catch (error) {
                console.warn("Could not notify server of logout:", error);
            } finally {
                localStorage.clear();
                window.location.href = LOGIN_PAGE;
            }
        }

        // --- authFetch (PUBLIC) ---
        async function authFetch(url, options = {}) {
            const currentToken = localStorage.getItem('clientToken');
            if (!currentToken) {
                localStorage.clear();
                window.location.href = LOGIN_PAGE;
                throw new Error("Session expired. Please log in again.");
            }

            const defaultHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` };
            const resp = await fetch(url, { ...options, headers: { ...defaultHeaders, ...(options.headers || {}) } });
            if (resp.status === 401 || resp.status === 403) {
                let debugText = '';
                try { debugText = await resp.text(); } catch(e){}
                console.warn('authFetch got 401/403 from', url, 'server message:', debugText);
                localStorage.clear();
                window.location.href = LOGIN_PAGE;
                throw new Error("Session expired. Please log in again.");
            }
            return resp;
        }

        // --- Profile fetch (PUBLIC) ---
        async function fetchProfileData() {
            const currentToken = localStorage.getItem('clientToken');
            if (!currentToken) {
                localStorage.clear();
                window.location.href = LOGIN_PAGE;
                return;
            }

            try {
                const resp = await fetch(`${API_CLIENT}?action=profile`, {
                    method: 'GET',
                    headers: { 'Authorization': `Bearer ${currentToken}`, 'Content-Type': 'application/json' }
                });

                if (resp.status === 401) {
                    let bodyText = '';
                    try { bodyText = await resp.text(); } catch(e){}
                    console.warn('Profile fetch 401:', bodyText);
                    if (bodyText && bodyText.toLowerCase().includes('session invalidated')) {
                        openForceModal();
                        return;
                    }

                    updateUIFromLocalPlan();
                    return;
                }

                const json = await resp.json().catch(()=>null);
                if (!resp.ok || !json || json.status === 'Error') {
                    console.warn('Profile fetch failed', resp.status, json);
                    updateUIFromLocalPlan();
                    return;
                }

                const pd = json.planDetails || {};
                planDetails = Object.assign({}, planDetails, pd);
                localStorage.setItem('planDetails', JSON.stringify(planDetails));

                const rc = pd.remainingCredits;
                const creditsDisplay = rc === 'Unlimited' ? 'Unlimited' : (rc == null ? 'N/A' : Number(rc).toLocaleString());
                
                // --- FIX: Apply optional chaining to avoid crashing when elements don't exist ---
                document.getElementById('plan-remaining-credits')?.textContent = creditsDisplay;
                document.getElementById('client-name-display').textContent = pd.clientName || CLIENT_NAME; 
                document.getElementById('profile-username')?.textContent = pd.username || pd.clientName || CLIENT_NAME;
                document.getElementById('profile-email')?.textContent = pd.email || 'â€”';
                document.getElementById('profile-mobile')?.textContent = pd.mobile || 'â€”';
                document.getElementById('profile-bulk-code')?.textContent = pd.bulkAccessCode || 'N/A';
                document.getElementById('plan-name')?.textContent = (pd.planName || 'Not Set').split('_')[0];
                document.getElementById('validity-end')?.textContent = pd.validityEnd ? new Date(pd.validityEnd).toLocaleDateString() : 'N/A';
                const statusEl = document.getElementById('account-status');
                if (statusEl) {
                    const isActive = (typeof pd.isActive === 'undefined') ? true : pd.isActive;
                    statusEl.textContent = isActive ? 'Enabled' : 'Disabled';
                    statusEl.className = `plan-status-badge ${isActive ? 'status-enabled' : 'status-disabled'}`;
                }

                checkPlanValidity();
                
                // NOTE: Fetch usage data and render chart only if the canvas exists on the REPORTS page.
                if (document.getElementById('usage-chart')) { 
                    fetchUsageData().then(data => {
                        if (data) renderUsageChart(data);
                    }).catch(console.error);
                }

            } catch (e) {
                console.error('fetchProfileData error:', e);
                updateUIFromLocalPlan(); 
            }
        }

        // --- Update UI from Local Plan (PUBLIC) ---
        function updateUIFromLocalPlan() {
            const rc = planDetails.remainingCredits ?? 'N/A';
            const creditsDisplay = rc === 'Unlimited' ? 'Unlimited' : (rc === 'N/A' ? 'N/A' : Number(rc).toLocaleString());
            
            // --- FIX: Apply optional chaining to all lookups ---
            document.getElementById('plan-remaining-credits')?.textContent = creditsDisplay;
            document.getElementById('client-name-display').textContent = CLIENT_NAME; 
            document.getElementById('profile-username')?.textContent = planDetails.username || CLIENT_NAME;
            document.getElementById('profile-email')?.textContent = planDetails.email || 'â€”';
            document.getElementById('profile-mobile')?.textContent = planDetails.mobile || 'â€”';
            document.getElementById('profile-bulk-code')?.textContent = planDetails.bulkAccessCode || 'N/A';
            document.getElementById('plan-name')?.textContent = (planDetails.planName || 'Not Set').split('_')[0];
            document.getElementById('validity-end')?.textContent = planDetails.validityEnd ? new Date(planDetails.validityEnd).toLocaleDateString() : 'N/A';

            const statusEl = document.getElementById('account-status');
            if (statusEl) {
                const isActive = (typeof planDetails.isActive === 'undefined') ? true : planDetails.isActive;
                statusEl.textContent = isActive ? 'Enabled' : 'Disabled';
                statusEl.className = `plan-status-badge ${isActive ? 'status-enabled' : 'status-disabled'}`;
            }
        }

        // --- CHECK PLAN VALIDITY (PUBLIC) ---
        function checkPlanValidity() {
            const token = localStorage.getItem('clientToken');
            const planDetailsString = localStorage.getItem('planDetails');

            if (!token) {
                showAccessDenied("Please log in to access Bulk Address Verification.");
                isPlanValid = false;
                return false;
            }

            try {
                const validityEnd = planDetails.validityEnd ? new Date(planDetails.validityEnd) : null;
                const now = new Date();

                if (planDetails.isActive === false) {
                    showAccessDenied("Your account has been **disabled** by the administrator. Please contact support.");
                    isPlanValid = false;
                    return false;
                }

                if (validityEnd && validityEnd < now) {
                    showAccessDenied(`Your bulk plan expired on **${validityEnd.toLocaleDateString()}**. Please contact support to renew.`);
                    isPlanValid = false;
                    return false;
                }

                // OK
                document.getElementById('bulkContent')?.classList.remove('hidden');
                isPlanValid = true;
                return true;

            } catch (e) {
                console.error("Error parsing plan details:", e);
                showAccessDenied("Client authentication data is corrupted. Please log in again.");
                setTimeout(() => { localStorage.clear(); window.location.href = LOGIN_PAGE; }, 1500);
                isPlanValid = false;
                return false;
            }
        }

        // --- SHOW ACCESS DENIED (PUBLIC) ---
        function showAccessDenied(message) {
            const bulkContent = document.getElementById('bulkContent');
            const progressContainer = document.querySelector('#bulk-verification .progress-container');
            if (bulkContent) bulkContent.classList.add('hidden');
            if (progressContainer) progressContainer.classList.add('hidden');

            const existing = document.querySelector('#bulk-verification .access-denied-block');
            if (existing) return;
            const errorBlock = document.createElement('div');
            errorBlock.className = 'access-denied-block space-y-6 mt-6';
            errorBlock.innerHTML = `
                <div class="bg-red-50 p-8 rounded-xl border-l-4 border-alert-dark shadow-lg">
                    <p class="font-bold text-xl text-alert-dark mb-3 flex items-center">ðŸ›‘ Access Denied</p>
                    <p class="text-base text-gray-700 mb-6">${message.replace(/\*\*/g, '<strong>')}</p>
                </div>
                <a href="tel:+919193246219" class="block w-full py-3 bg-tf-secondary text-white text-center font-bold rounded-lg hover:bg-[#86259d] transition">Call Support / Renew Plan</a>
                <a href="https://wa.me/919193246219" target="_blank" class="block w-full py-3 bg-whatsapp-green text-white text-center font-bold rounded-lg hover:bg-green-600">ðŸŸ¢ WhatsApp Support</a>
            `;
            document.getElementById('bulk-verification')?.appendChild(errorBlock);
        }

        // --- PASSWORD MODAL LOGIC (PUBLIC) ---
        function openPasswordModal() {
            document.getElementById('password-modal')?.style.display = 'flex';
            document.getElementById('password-update-form')?.reset();
            document.getElementById('password-update-status')?.textContent = '';
        }

        function closePasswordModal() {
            document.getElementById('password-modal')?.style.display = 'none';
        }
        
        // --- FORCE-LOGOUT UI / helpers (PUBLIC) ---
        function openForceModal() {
            document.getElementById('force-logout-modal')?.style.display = 'flex';
        }
        function closeForceModal() {
            document.getElementById('force-logout-modal')?.style.display = 'none';
        }

        function getTokenPayload() {
            const token = localStorage.getItem('clientToken');
            if (!token) return null;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return payload;
            } catch (e) {
                return null;
            }
        }

        async function forceLogoutOtherDevice() {
            const payload = getTokenPayload();
            const clientId = payload && payload.clientId ? payload.clientId : (planDetails.id || planDetails.clientId);
            if (!clientId) {
                alert('Cannot determine clientId. Please log in again.');
                closeForceModal();
                window.location.href = LOGIN_PAGE;
                return;
            }

            try {
                const resp = await fetch(`${API_CLIENT}?action=force-logout`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ clientId })
                });
                const json = await resp.json().catch(()=>null);
                if (resp.ok && json && json.status === 'Success') {
                    closeForceModal();
                    localStorage.removeItem('clientToken');
                    alert('Other device logged out. Please log in again here.');
                    window.location.href = LOGIN_PAGE;
                } else {
                    console.warn('force-logout failed', resp.status, json);
                    alert('Could not force logout other device. Contact support.');
                    closeForceModal();
                }
            } catch (e) {
                console.error('force-logout error', e);
                alert('Network error. Try again or contact support.');
                closeForceModal();
            }
        }
        
        // --- INBOX FUNCTIONS (PUBLIC) ---
        async function loadInboxCounts() {
            try {
                const response = await authFetch(`${API_BASE}/inbox/message`);
                const result = await response.json();
                if (result.status === "Success" && result.unreadCount > 0) {
                    const badge = document.getElementById('inbox-badge');
                    badge.textContent = result.unreadCount;
                    badge.style.display = 'block';
                } else {
                    document.getElementById('inbox-badge').style.display = 'none';
                }
            } catch (e) {
                console.error("Failed to load client inbox counts:", e);
            }
        }

        async function loadClientInbox() {
            const msgContainer = document.getElementById('client-inbox-list');
            const detailView = document.getElementById('full-message-detail');
            msgContainer.innerHTML = '<p class="text-center text-gray-500 mt-5">Loading messages...</p>';
            detailView.style.display = 'none';
            try {
                const response = await authFetch(`${API_BASE}/inbox/message`);
                const result = await response.json();
                if (result.status === "Success") {
                    msgContainer.innerHTML = '';
                    if (!result.messages || result.messages.length === 0) {
                        msgContainer.innerHTML = '<p class="text-center text-gray-500 mt-5">No messages in your inbox.</p>';
                        return;
                    }
                    result.messages.forEach(msg => {
                        const isUnread = !msg.isRead && msg.senderId === 'admin';
                        const cardClass = isUnread ? 'unread' : '';
    
                        const icon = isUnread ? 'fa-envelope' : 'fa-envelope-open';
                        const sender = msg.senderId === 'admin' ? 'Admin' : 'You';
    
                        // FIX: Use JSON.stringify for subject/body when passing to onclick to handle quotes/special characters
                        const subjectSafe = JSON.stringify(msg.subject || '(No Subject)');
                        const bodySafe = JSON.stringify(msg.body || '');

                        const messageHtml = `
                            <div id="msg-${msg._id}" class="msg-card ${cardClass}" onclick="viewClientMessage('${msg._id}', ${subjectSafe}, ${bodySafe}, ${isUnread}, '${msg.timestamp}')">
                                <i class="fas ${icon} msg-icon"></i>
                                <div class="flex-grow">
                                    <p class="text-md truncate">${msg.subject || '(No Subject)'}</p>
                                    <small class="text-gray-500 block">From: ${sender} â€¢ ${new Date(msg.timestamp).toLocaleDateString()}</small>
                                </div>
                            </div>
                        `;
                        msgContainer.insertAdjacentHTML('beforeend', messageHtml);
                    });
                } else {
                    msgContainer.innerHTML = `<p class="text-center text-red-500 mt-5">Failed to load inbox: ${result.message}</p>`;
                }
            } catch (error) {
                msgContainer.innerHTML = `<p class="text-center text-red-500 mt-5">Network Error: ${error.message}</p>`;
            }
        }

        function toggleInbox() {
            document.getElementById('inbox-modal')?.style.display = 'flex';
            loadClientInbox();
        }

        function closeInbox() {
            document.getElementById('inbox-modal')?.style.display = 'none';
            loadInboxCounts();
        }

        function viewClientMessage(messageId, subject, body, isUnread, timestamp) {
            const detailView = document.getElementById('full-message-detail');
            document.getElementById('full-message-subject').textContent = subject;
            // FIX: Use innerText for body to avoid injection and respect whitespace
            document.getElementById('full-message-body').innerText = body;
            document.getElementById('full-message-date').textContent = new Date(timestamp).toLocaleString();
            detailView.style.display = 'block';
            if (isUnread) {
                authFetch(`${API_BASE}/inbox/message?messageId=${messageId}`, { method: 'PUT' }).catch(()=>{});
                const card = document.getElementById(`msg-${messageId}`);
                if (card) {
                    card.classList.remove('unread');
                    const iconEl = card.querySelector('.msg-icon');
                    if (iconEl) iconEl.classList.replace('fa-envelope', 'fa-envelope-open');
                }
                setTimeout(loadInboxCounts, 500);
            }
        }

        // --- TAB NAVIGATION (UPDATED and PUBLIC) ---
        // NOTE: showTab is now mostly obsolete due to modular navigation but kept for initialization simplicity.
        function showTab(tabId, button) {
            // Note: This logic only runs on the bulk-dashboard page now.
            
            // Highlight the active link (This logic is needed for visual feedback)
            document.querySelectorAll('.nav-tabs .nav-link').forEach(btn => btn.classList.remove('active'));
            if (button) button.classList.add('active');

            // --- DELEGATE LOGIC TO EXTERNAL FILES ---
            if (tabId === 'bulk-verification') {
                checkPlanValidity();
                if (typeof loadKpiData === 'function') loadKpiData(); 
            }
        }
        
        // --- JOB POLLING LOGIC (PUBLIC) ---
        // NOTE: This should now only be called from in-progress.html/completed.html
        function startJobPolling() {
            if (activeJobPollInterval) clearInterval(activeJobPollInterval);
            // NOTE: fetchAndUpdateJobStatus is assumed to be defined in bulk_verification_logic.js
            fetchAndUpdateJobStatus(); 
            activeJobPollInterval = setInterval(fetchAndUpdateJobStatus, 5000); // Poll every 5 seconds
            
            document.getElementById('in-progress-search')?.addEventListener('input', filterJobsList);
            document.getElementById('completed-search')?.addEventListener('input', filterJobsList);
        }

        // --- Enterprise Improvement: Job Filtering Logic ---
        // NOTE: These are placeholders/global hooks for the logic in bulk_verification_logic.js
        function filterJobsList() {
            if (typeof window.renderJobsList === 'function') {
                // Rely on the external script to handle the filtering and rendering
                window.renderJobsList(window.globalJobsData.inProgress, 'in-progress-list', document.getElementById('in-progress-search')?.value.toLowerCase() || '');
                window.renderJobsList(window.globalJobsData.completed, 'completed-list', document.getElementById('completed-search')?.value.toLowerCase() || '');
            }
        }

        // Reusable function to render job lists (NEW) - Placeholder, actual logic is external
        function renderJobsList() {} 

        
        async function fetchAndUpdateJobStatus() {
            // NOTE: This logic belongs to bulk_verification_logic.js in the modular setup, 
            // but we need a placeholder here for the initialization flow.
        }
        
        // --- Enterprise Improvement: KPI Data Logic (Placeholder) ---
        async function loadKpiData() {
            // ACTION: Hardcoded placeholders for the Bulk Verification KPIs
            document.getElementById('success-rate-kpi').textContent = 'â€”%';
            document.getElementById('total-volume-kpi').textContent = '0'; 
        }

        // --- AUTHENTICATED DOWNLOAD FUNCTION ---
        async function handleAuthenticatedDownload(jobId, jobFilename) {
            const safeFilename = `${jobFilename.replace('.csv', '').replace(/'/g, '').replace(/"/g, '')}_verified.csv`;
            const downloadUrl = `${API_BULK_JOBS}?action=download&jobId=${jobId}`; 

            try {
                const resp = await authFetch(downloadUrl, { method: 'GET' });

                const contentType = (resp.headers.get && resp.headers.get('content-type') || '').toLowerCase();
                if (contentType.includes('application/json')) {
                    let json = null;
                    try { json = await resp.json(); } catch (e) { /* ignore parse error */ }
                    const msg = (json && (json.message || json.error)) ? (json.message || json.error) : 'Server returned JSON instead of CSV.';
                    alert('Download failed: ' + msg);
                    return;
                }

                if (!resp.ok) {
                    const errorText = await resp.text();
                    try {
                        const errorJson = JSON.parse(errorText);
                        alert('Download failed: ' + (errorJson.message || errorJson.error || 'File unavailable.'));
                    } catch (e) {
                        alert('Download failed. Please try again later.');
                    }
                    return;
                }

                const blob = await resp.blob(); 
                
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = window.URL.createObjectURL(blob);
                a.download = safeFilename; 
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(a.href);
                a.remove();
                
            } catch (e) {
                console.error("Authenticated Download Failed:", e);
                alert('Download failed due to a network or authentication error.');
            }
        }
        
        // FIX: Expose global functions to window object
        window.showTab = showTab;
        window.logout = logout; 
        window.openPasswordModal = openPasswordModal;
        window.closePasswordModal = closePasswordModal;
        window.closeForceModal = closeForceModal;
        window.forceLogoutOtherDevice = forceLogoutOtherDevice;
        window.toggleInbox = toggleInbox;
        window.closeInbox = closeInbox;
        window.viewClientMessage = viewClientMessage;
        window.handleAuthenticatedDownload = handleAuthenticatedDownload;
        window.startJobPolling = startJobPolling;


        // --- PASSWORD UPDATE LISTENER (PUBLIC) ---
        document.getElementById('password-update-form')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const statusEl = document.getElementById('password-update-status');
            const updateBtn = document.getElementById('updatePasswordBtn');

            if (newPassword !== confirmPassword) {
                statusEl.textContent = 'Passwords do not match.';
                statusEl.className = 'text-red-600 mt-3';
                return;
            }
            if (newPassword.length < 6) {
                statusEl.textContent = 'Password must be at least 6 characters.';
                statusEl.className = 'text-red-600 mt-3';
                return;
            }

            updateBtn.disabled = true;
            updateBtn.textContent = 'Processing...';
            statusEl.textContent = 'Sending request to server...';
            statusEl.className = 'text-tf-primary mt-3';

            try {
                const resp = await authFetch(`${API_CLIENT}?action=update-password`, {
                    method: 'PUT',
                    body: JSON.stringify({ newPassword })
                });
                const result = await resp.json();

                if (resp.ok && result.status === 'Success') {
                    statusEl.textContent = 'Password changed successfully! Redirecting to login...';
                    statusEl.className = 'text-green-600 mt-3';
                    setTimeout(logout, 1500); 
                } else {
                    statusEl.textContent = result.message || 'Update failed.';
                    statusEl.className = 'text-red-600 mt-3';
                }
            } catch (error) {
                statusEl.textContent = 'Network error or session expired.';
                statusEl.className = 'text-red-600 mt-3';
                console.error('Password Update Error:', error);
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Update & Log Out';
            }
        });


        // --- INITIALIZATION ---
        window.onload = () => {
            // Try to fetch profile and then init bulk listeners (external)
            fetchProfileData().then(()=> {
                if (typeof initBulkListeners === 'function') {
                    initBulkListeners();
                } else {
                    console.error("Bulk listeners function not found. Make sure bulk_verification_logic.js is loaded.");
                }
            }).catch((e)=> {
                console.error('Error during profile init:', e);
                if (typeof initBulkListeners === 'function') initBulkListeners();
            });
            loadInboxCounts();

            setInterval(sendHeartbeat, 60000);
            setInterval(loadInboxCounts, 60000);
            
            // Initialize tab content based on URL
            document.querySelectorAll('.nav-tabs .nav-link').forEach(link => {
                const currentPath = window.location.pathname.endsWith('/') ? window.location.pathname : window.location.pathname.split('/').pop();
                const linkPath = link.href.split('/').pop();

                if (linkPath === currentPath) {
                    link.classList.add('active');
                    
                    // Trigger initialization logic specific to the current page
                    if (linkPath.includes('reports.html')) {
                        if (document.getElementById('usage-chart')) {
                            fetchUsageData().then(data => {
                                if (data) renderUsageChart(data);
                            }).catch(console.error);
                        }
                    } else if (linkPath.includes('in-progress.html') || linkPath.includes('completed.html')) {
                        if (typeof startJobPolling === 'function') startJobPolling();
                    }
                }
            });

            /* --- SMALL SAFE FALLBACK (non-invasive) --- */
            try {
                ensureProcessButtonFallback();
            } catch (e) {
                console.warn('Fallback init failed', e);
            }
        };

        // --- Time Formatting Helper (NEW) ---
        function formatISTTime(utcTimestamp) {
            if (!utcTimestamp) return 'N/A';
            const date = new Date(utcTimestamp);
            
            const options = {
                year: 'numeric',
                month: 'short',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Asia/Kolkata'
            };

            return date.toLocaleDateString('en-IN', options);
        }

        // placeholder for getRemainingCredits used in polling (assumes it's defined elsewhere)
        async function getRemainingCredits() {
            try {
                const resp = await authFetch(`${API_CLIENT}?action=remaining-credits`);
                const json = await resp.json().catch(()=>null);
                return json || { ok: false };
            } catch (e) {
                return { ok: false };
            }
        }

        /* -------------------------
            Fallback helper (tiny)
            ------------------------- */
        function ensureProcessButtonFallback() {
            const fileInput = document.getElementById('csvFileInput');
            const processBtn = document.getElementById('processButton');
            const activeJobCountEl = document.getElementById('active-job-count');
            const MAX_ACTIVE = 1; // consistency with your logic

            if (!fileInput || !processBtn) return;

            function updateButtonState() {
                const active = Number(activeJobCountEl?.textContent || 0);
                const hasFile = fileInput.files && fileInput.files.length > 0;
                processBtn.disabled = !(hasFile && active < MAX_ACTIVE);
            }

            // attach listener (safe, won't conflict if external script also uses this input)
            fileInput.addEventListener('change', updateButtonState, { passive: true });

            // also observe changes to active job count (in case polling updates it later)
            const observerTarget = activeJobCountEl;
            if (observerTarget) {
                const mo = new MutationObserver(updateButtonState);
                mo.observe(observerTarget, { childList: true, subtree: true, characterData: true });
            }

            // initial sync (in case file was preselected)
            updateButtonState();
        }
    </script>
</body>
</html>