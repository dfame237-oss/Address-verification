<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Smart Locator â€” Client Dashboard</title>

    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script>
        // FIX: Corrected the syntax error in the Tailwind config object (missing comma)
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            // Smart Locator/Teleforce Style Palette
                            'tf-primary': '#5F3DC4',
                            'tf-secondary': '#A437C1',
                            'tf-dark': '#0F172A',
                            'tf-text': '#E2E8F0',
                            'tf-card': '#1E293B',
                            'tf-light': '#F1F5F9',
                            'whatsapp-green': '#25D366',
                            'alert-dark': '#EF4444',
                            'alert-light': '#FEE2E2',
                            'success-light': '#D1FAE5',
                            'tf-primary-light': '#EFE7FF'
                        },
                        fontFamily: {
                            sans: ['Inter', 'sans-serif']
                        }
                    }
                }
            }
        };
    </script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* Base styles adapted for new brand colors */
        body { font-family: 'Inter', sans-serif; background-color: #F1F5F9; }
        /* Ensure default text color is dark on light background */
        .dashboard-container { max-width: 1200px; margin: 30px auto; padding: 35px; background-color: white; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.1); padding-bottom: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #E5E7EB; }
        .header h1 { font-weight: 700; }

        /* --- SIDEBAR LAYOUT STYLES --- */
        .main-dashboard-layout { display: grid; grid-template-columns: 240px 1fr; gap: 30px; }

        .sidebar-nav { background-color: #F8FAFC; padding: 15px 0; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: fit-content; }
        .sidebar-header { padding: 0 20px 10px; border-bottom: 1px solid #E2E8F0; }
        .sidebar-section-title { font-size: 0.8rem; font-weight: 700; color: #64748B; margin-top: 20px; margin-bottom: 5px; padding: 0 20px; text-transform: uppercase; }

        .nav-tabs .tab-button { display: flex; align-items: center; width: 100%; text-align: left; padding: 12px 20px; border-bottom: none; border-left: 4px solid transparent; color: #1E293B; font-weight: 500; transition: background-color 0.2s, border-left 0.2s; }
        .nav-tabs .tab-button:hover { background-color: #EFE7FF; }

        .nav-tabs .tab-button.active { color: #5F3DC4; background-color: #EFE7FF; border-left: 4px solid #5F3DC4; font-weight: 700; }

        .tab-content-area { padding-bottom: 35px; }
        .tab-content { padding: 15px 0; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .controls { display: flex; gap: 15px; align-items: center; }
        .icon-btn { cursor: pointer; position: relative; font-size: 24px; color: #64748B; transition: color 0.2s; }
        .icon-btn:hover { color: #5F3DC4; }
        .badge { position: absolute; top: -5px; right: -5px; background-color: #EF4444; color: white; border-radius: 50%; padding: 3px 7px; font-size: 11px; }

        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .profile-card, .plan-card { background-color: #F8FAFC; padding: 30px; border-radius: 12px; border: 1px solid #E2E8F0; transition: box-shadow 0.2s; }
        .profile-card:hover, .plan-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08); }
        .info-item strong { color: #1E293B; margin-right: 8px; font-weight: 600; }
        .plan-status-badge { display: inline-block; padding: 6px 14px; border-radius: 9999px; font-size: 0.85rem; font-weight: 700; }
        .status-enabled { background-color: #EFE7FF; color: #5F3DC4; }
        .status-disabled { background-color: #FEE2E2; color: #DC2626; }

        .action-btn { background-color: #5F3DC4 !important; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s, transform 0.1s, opacity 0.2s; }
        .action-btn:hover { background-color: #4d2e97; transform: translateY(-1px); }
        .action-btn.logout { background-color: #DC2626 !important; }
        .action-btn.logout:hover { background-color: #B91C1C; }

        .bg-tf-primary { background-color: #5F3DC4 !important; }
        .bg-tf-secondary { background-color: #A437C1 !important; }
        .bg-whatsapp-green { background-color: #25D366 !important; }

        .progress-fill { background-color: #A437C1; height: 0.75rem; border-radius: 9999px; transition: all 0.5s ease-in-out; }

        #inbox-header-btn { position: relative; background: #F8FAFC; border: 1px solid #CBD5E1; border-radius: 50%; padding: 10px 14px; box-shadow: 0 2px 5px rgba(0,0,0,0.08); cursor: pointer; transition: background-color 0.2s; }
        #inbox-header-btn:hover { background-color: #EFE7FF; }
        #inbox-header-btn .fas { font-size: 20px; color: #5F3DC4; }
        #inbox-header-btn .badge { top: -5px; right: -5px; padding: 2px 6px; }

        #drop-zone { border: 2px dashed #CBD5E1; border-radius: 12px; padding: 30px; text-align: center; cursor: pointer; transition: border-color 0.3s, background-color 0.3s; }
        #drop-zone.dragover { border-color: #A437C1; background-color: #EEF2FF; }

        #preview-table th { background-color: #E2E8F0; padding: 8px 12px; border-bottom: 1px solid #CBD5E1; font-weight: 600; }
        #preview-table td { padding: 8px 12px; border-bottom: 1px solid #F1F5F9; }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-content { padding: 24px; border-radius: 12px; background: #fff; max-width: 520px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.2); position: relative; animation: fadeIn 0.3s; }

        #full-message-detail { border: 1px solid #D1D5DB; background-color: #F8FAFC; border-radius: 8px; padding: 15px; line-height: 1.6; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
        #full-message-detail h3 { color: #A437C1; padding-bottom: 8px; border-bottom: 1px dashed #E2E8F0; margin-bottom: 8px; }

        @media (max-width: 768px) {
            .dashboard-container { padding: 15px; margin: 10px auto; width: 95%; box-shadow: none; }
            .header { flex-direction: column; align-items: flex-start; margin-bottom: 20px; }
            .header h1 { font-size: 1.75rem; margin-bottom: 10px; }
            .controls { width: 100%; justify-content: flex-end; }
            .main-dashboard-layout { grid-template-columns: 1fr; gap: 15px; }
            .sidebar-nav { border-radius: 8px; padding: 10px 0; }
            .nav-tabs .tab-button i { display: none; }
            .tab-content-area { padding-bottom: 20px; }
        }

        #force-logout-modal .modal-content { max-width: 520px; padding: 24px; border-radius: 12px; background: #fff; }
        #force-logout-modal .modal-actions { margin-top: 16px; display:flex; gap:10px; justify-content:flex-end; }

        .msg-card { display: flex; align-items: center; border: 1px solid #E5E7EB; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; }
        .msg-card:hover { background-color: #F0F4FF; box-shadow: 0 2px 8px rgba(95, 61, 196, 0.1); }
        .msg-card.unread { background-color: #EEF2FF; border-left: 4px solid #5F3DC4; font-weight: 600; }
        .msg-card .msg-icon { font-size: 1.2rem; color: #5F3DC4; margin-right: 15px; flex-shrink: 0; }
    </style>
</head>
<body>
    <div class="dashboard-container text-gray-800">
        <header class="header">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Welcome, <span id="client-name-display" class="text-tf-primary">Client</span></h1>
                <div class="text-sm text-gray-500 mt-1">Manage your address verifications and plan here.</div>
            </div>

            <div class="controls">
                <button id="inbox-header-btn" onclick="toggleInbox()" aria-label="Open Inbox" role="button">
                    <i class="fas fa-envelope-open-text"></i>
                    <span id="inbox-badge" class="badge" style="display:none;">0</span>
                </button>

                <button onclick="logout()" class="action-btn logout" aria-label="Logout" role="button">Logout</button>
            </div>
        </header>

        <div class="main-dashboard-layout">

            <aside id="sidebar" class="sidebar-nav">
                <div class="sidebar-header">
                    <h4 class="text-lg font-bold text-tf-dark">Dashboard Menu</h4>
                </div>

                <div class="nav-tabs vertical" role="tablist">

                    <h5 class="sidebar-section-title">Core Operations</h5>

                    <button id="bulk-tab-btn" class="tab-button active" onclick="showTab('bulk-verification', this)" role="tab" aria-selected="true">
                        <i class="fas fa-file-upload mr-2"></i> Bulk Verification
                    </button>
                    <button id="single-tab-btn" class="tab-button" onclick="showTab('single-verification', this)" role="tab" aria-selected="false">
                        <i class="fas fa-search-location mr-2"></i> Single Lookup
                    </button>
                    <button id="in-progress-tab-btn" class="tab-button" onclick="showTab('in-progress-jobs', this)" role="tab" aria-selected="false">
                        <i class="fas fa-hourglass-half mr-2"></i> In Progress
                    </button>

                    <button id="completed-tab-btn" class="tab-button" onclick="showTab('completed-jobs', this)" role="tab" aria-selected="false">
                        <i class="fas fa-check-circle mr-2"></i> Completed
                    </button>

                    <h5 class="sidebar-section-title">Analytics & Account</h5>

                    <button id="metrics-tab-btn" class="tab-button" onclick="showTab('metrics-reports', this)" role="tab" aria-selected="false">
                        <i class="fas fa-chart-bar mr-2"></i> Key Metrics & Usage
                    </button>

                    <button id="deduction-history-btn" class="tab-button" onclick="showTab('deduction-history', this)" role="tab" aria-selected="false">
                        <i class="fas fa-file-invoice-dollar mr-2"></i> Deduction History
                    </button>

                    <button id="profile-tab-btn" class="tab-button" onclick="showTab('profile-plan', this)" role="tab" aria-selected="false">
                        <i class="fas fa-user-circle mr-2"></i> Profile & Plan Status
                    </button>

                    <button class="tab-button" onclick="showTab('support', this)" role="tab" aria-selected="false">
                        <i class="fas fa-headset mr-2"></i> Support
                    </button>

                </div>
            </aside>

            <main id="main-content" class="tab-content-area">

                <div id="bulk-verification" class="tab-content" role="tabpanel" aria-labelledby="bulk-tab-btn">

                    <header class="text-center mb-10">
                        <h2 class="text-4xl font-extrabold text-gray-900 mb-2">
                            <span class="text-tf-secondary">Bulk Address</span> Verification
                        </h2>
                        <p class="text-lg text-gray-500 mt-2">Upload a CSV file for high-volume cleaning and verification.</p>
                    </header>

                    <div id="kpi-grid" class="info-grid mb-8">
                        <div class="profile-card w-full max-w-sm mx-auto">
                            <h3 class="text-md font-semibold text-gray-600 mb-2 flex items-center"><i class="fas fa-calendar-day mr-2 text-tf-primary"></i> Today's Completed Verifications</h3>
                            <p id="today-completed-kpi" class="text-3xl font-bold text-tf-primary">0</p>
                            <p class="text-xs text-gray-500 mt-1">Refreshed on tab load.</p>
                        </div>
                    </div>

                    <div id="bulkContent" class="space-y-8">

                        <div class="bg-tf-light p-8 rounded-xl border-l-4 border-tf-primary shadow-lg">
                            <p class="font-bold text-xl text-tf-primary mb-3 flex items-center">
                                <i class="fas fa-download mr-3"></i> 1. Download Template
                            </p>
                            <p class="text-sm text-gray-600 mb-4">
                                Use this template to ensure your CSV file has the required columns:
                                <code class="bg-gray-200 px-1 rounded font-mono text-gray-900">ORDER ID</code>,
                                <code class="bg-gray-200 px-1 rounded font-mono text-gray-900">CUSTOMER NAME</code>,
                                <code class="bg-gray-200 px-1 rounded font-mono text-gray-900">CUSTOMER RAW ADDRESS</code>.
                            </p>

                            <button id="downloadTemplateButton" class="w-full py-3 bg-tf-primary text-white font-semibold rounded-lg hover:bg-[#4d2e97] transition duration-200 focus:outline-none focus:ring-4 focus:ring-tf-primary focus:ring-opacity-50" role="button" aria-label="Download CSV Template">
                                Download Verification Template (CSV)
                            </button>
                        </div>

                        <div class="bg-white p-8 rounded-xl border border-gray-200 shadow-lg text-center">
                            <p class="font-bold text-xl text-gray-800 mb-4 flex items-center justify-center">
                                <i class="fas fa-upload mr-3 text-tf-secondary"></i> 2. Upload Your CSV File
                            </p>

                            <div id="drop-zone" class="mb-4">
                                <p class="text-gray-500 mb-2">Drag and drop your CSV file here, or click to select.</p>
                                <input type="file" id="csvFileInput" accept=".csv" class="hidden" aria-describedby="file-upload-hint">
                                <label for="csvFileInput" class="py-2 px-4 bg-tf-secondary/10 text-tf-secondary font-semibold rounded-lg hover:bg-tf-secondary/20 transition cursor-pointer">Choose File</label>
                                <span id="file-name-display" class="text-gray-700 ml-3">No file chosen</span>
                            </div>

                            <p class="text-xs text-gray-500 mt-2" id="file-upload-hint">Maximum 1000 rows recommended for stability. Must use the provided template format.</p>

                            <div id="preview-section" class="mt-4 hidden p-4 bg-gray-50 rounded border border-gray-200 overflow-x-auto">
                                <h4 class="font-semibold text-gray-800 mb-2">Preview (First 5 Rows)</h4>
                                <table id="preview-table" class="w-full text-sm text-left"></table>
                            </div>
                        </div>

                        <button id="processButton" class="w-full py-4 bg-tf-secondary text-white font-bold text-lg rounded-lg shadow-xl transition duration-200 transform hover:scale-[1.005] hover:bg-[#86259d] focus:outline-none focus:ring-4 focus:ring-tf-secondary focus:ring-opacity-50" disabled style="display:block;" aria-label="Start Bulk Verification Process" role="button">
                            Start Verification
                        </button>

                    </div>

                    <div class="progress-container mt-12 p-8 bg-tf-light rounded-xl border border-gray-300 shadow-inner">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Verification Status</h3>
                        <p id="status-message" class="font-semibold text-gray-600 mb-4 transition duration-300">Ready to upload.</p>

                        <div class="progress-bar w-full bg-gray-300 rounded-full h-3">
                            <div class="progress-fill h-3 bg-tf-secondary rounded-full transition-all duration-500 ease-in-out" id="progressBarFill" style="width: 0%;"></div>
                        </div>

                    </div>

                    <p id="access-denied-message" class="hidden mt-6 text-center text-red-700 font-bold"></p>
                </div>

                <div id="single-verification" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="single-tab-btn">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-search-location mr-2 text-tf-primary"></i> Single Address Lookup
                    </h2>

                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg space-y-4 max-w-2xl mx-auto">
                        <p class="text-gray-600">Enter a single raw address to verify and clean instantly (1 credit).</p>

                        <form id="single-verify-form" onsubmit="event.preventDefault(); handleSingleVerification();">
                            <div class="space-y-4">
                                <input type="text" id="single-name-input" class="w-full p-3 border rounded focus:border-tf-primary" placeholder="Customer Name (Optional)" aria-label="Customer Name">
                                <textarea id="single-address-input" class="w-full p-3 border rounded focus:border-tf-primary resize-y" rows="3" placeholder="Enter Raw Address Here (e.g., H.No. 123, Street Name, City, Pincode)" required aria-label="Raw Address"></textarea>
                            </div>

                            <button type="submit" id="singleVerifyBtn" class="action-btn w-full mt-4 bg-tf-primary hover:bg-[#4d2e97]" role="button" aria-label="Verify Single Address">
                                <i class="fas fa-magic mr-2"></i> Verify Address
                            </button>
                        </form>
                    </div>

                    <div id="single-result-container" class="mt-6 p-6 bg-tf-light rounded-xl border border-gray-300 shadow-inner max-w-2xl mx-auto" style="display:none;">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-clipboard-check mr-2 text-green-600"></i> Verification Results
                        </h3>
                        <p id="single-result-status" class="font-semibold text-sm mb-3"></p>

                        <div id="single-result-details" class="info-grid">
                            <div class="profile-card">
                                <h4 class="font-semibold text-gray-600 mb-2">Clean Address</h4>
                                <p class="text-lg font-bold text-tf-primary" id="clean-address-line1"></p>
                                <p class="text-sm text-gray-600" id="clean-address-line2"></p>
                            </div>
                            <div class="profile-card">
                                <h4 class="font-semibold text-gray-600 mb-2">Geographic Data</h4>
                                <div class="info-item"><strong>PIN:</strong> <span id="clean-pin"></span></div>
                                <div class="info-item"><strong>District:</strong> <span id="clean-district"></span></div>
                                <div class="info-item"><strong>State:</strong> <span id="clean-state"></span></div>
                                <div class="info-item"><strong>Quality:</strong> <span id="clean-quality"></span></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-4" id="single-remarks"></p>
                    </div>
                </div>

                <div id="in-progress-jobs" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="in-progress-tab-btn">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Active Jobs (<span id="active-job-count">0</span>/1)</h2>
                    <input type="text" id="in-progress-search" class="w-full p-3 border rounded mb-4" placeholder="Filter jobs by Filename or Job ID">
                    <p class="text-xs text-gray-500 mb-4" id="in-progress-status-timestamp">Last refreshed: Just now.</p>

                    <div id="in-progress-list" class="space-y-4">
                        <p class="text-gray-500 text-center">Loading active jobs...</p>
                    </div>
                    <p id="max-jobs-message" class="text-red-600 font-bold mt-4" style="display:none;">Maximum 1 job is running. Please wait for completion.</p>
                </div>

                <div id="completed-jobs" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="completed-tab-btn">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Completed Jobs</h2>
                    <input type="text" id="completed-search" class="w-full p-3 border rounded mb-4" placeholder="Filter jobs by Filename or Job ID">
                    <p class="text-xs text-gray-500 mb-4" id="completed-status-timestamp">Last refreshed: Just now.</p>

                    <div id="completed-list" class="space-y-4">
                        <p class="text-gray-500 text-center">No recently completed jobs.</p>
                    </div>
                </div>

                <div id="metrics-reports" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="metrics-tab-btn">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Key Metrics & Usage Reports</h2>

                    <div class="profile-card mb-8">
                        <h3 class="text-xl font-semibold text-tf-primary mb-4 flex items-center"><i class="fas fa-chart-area mr-2"></i> Last 30 Days Usage Trend</h3>
                        <canvas id="usage-chart" role="img" aria-label="Line chart showing credits used over the past 30 days."></canvas>
                    </div>
                </div>

                <div id="deduction-history" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="deduction-history-btn">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-file-invoice-dollar mr-2"></i> Verification Deduction History</h2>
                    <p class="text-gray-600 mb-4">This section displays a detailed history of your bulk verification jobs and credit usage. <strong>History is limited to the last 90 days.</strong></p>
                    <div id="deduction-history-list" class="space-y-4">
                        <p class="text-gray-500 text-center">Loading history...</p>
                    </div>
                </div>

                <div id="profile-plan" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="profile-tab-btn">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Account Overview</h2>

                    <div class="info-grid">
                        <div class="profile-card flex flex-col justify-between">
                            <h3 class="text-xl font-semibold text-tf-primary mb-4 flex items-center"><i class="fas fa-user-circle mr-2"></i> My Profile Details</h3>

                            <div class="space-y-3">
                                <div class="info-item"><p><strong>Username:</strong> <span id="profile-username"></span></p></div>
                                <div class="info-item"><p><strong>Email:</strong> <span id="profile-email"></span></p></div>
                                <div class="info-item"><p><strong>Mobile:</strong> <span id="profile-mobile"></span></p></div>
                                <div class="info-item"><p><strong>Access Code:</strong> <span id="profile-bulk-code"></span></p></div>
                            </div>
                            <button class="action-btn mt-6 w-full bg-gray-500 text-white hover:bg-gray-600" onclick="openPasswordModal()" role="button" aria-label="Change Password">Change Password</button>
                        </div>

                        <div class="plan-card">
                            <h3 class="text-xl font-semibold text-tf-secondary mb-4 flex items-center"><i class="fas fa-award mr-2"></i> Plan Status</h3>
                            <div class="space-y-3">
                                <div class="info-item"><p><strong>Current Plan:</strong> <span id="plan-name" class="font-bold"></span></p></div>
                                <div class="info-item"><p><strong>Status:</strong> <span id="account-status"></span></p></div>
                                <div class="info-item"><p><strong>Valid Until:</strong> <span id="validity-end"></span></p></div>
                                <div class="info-item"><p><strong>Remaining Credits:</strong> <span id="plan-remaining-credits" class="font-bold text-tf-secondary">N/A</span></p></div>
                            </div>

                            <button class="action-btn mt-6 w-full bg-tf-secondary hover:bg-[#86259d]" onclick="showTab('support', document.querySelector('.nav-tabs .tab-button:last-child'))" role="button" aria-label="Contact support for renewal">Contact for Renewal</button>
                        </div>
                    </div>
                </div>

                <div id="support" class="tab-content" style="display:none;" role="tabpanel">
                    <div class="p-8 border rounded-xl shadow-md bg-tf-light space-y-6 max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4 flex items-center text-tf-primary">
                            <i class="fas fa-headset mr-3"></i> Contact Support
                        </h2>

                        <p class="text-gray-600">Need help with plan renewal, technical issues, or credits? Contact our dedicated support team instantly.</p>

                        <a href="https://wa.me/919193246219" target="_blank" class="block w-full py-4 bg-whatsapp-green text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition transform hover:scale-[1.005] flex items-center justify-center" role="button" aria-label="Contact Support via WhatsApp">
                            <i class="fab fa-whatsapp text-xl mr-3"></i> WhatsApp Support (+91 9193246219)
                        </a>

                        <a href="tel:+919193246219" class="block w-full py-4 bg-tf-primary text-white font-bold rounded-lg hover:bg-[#4d2e97] transition transform hover:scale-[1.005] flex items-center justify-center" role="button" aria-label="Call Support">
                            <i class="fas fa-phone mr-3"></i> Call Support (+91 9193246219)
                        </a>
                    </div>
                </div>

            </main>

        </div>
    </div>

    <!-- Modals -->
    <div id="insufficient-credits-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="credits-title">
        <div class="modal-content w-full max-w-md rounded-xl shadow-2xl p-6 bg-white relative text-center">
            <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeCreditsModal()">&times;</span>
            <i class="fas fa-exclamation-triangle text-alert-dark text-4xl mb-4"></i>
            <h3 class="text-2xl font-bold text-alert-dark mb-2" id="credits-title">Credit Alert</h3>
            <p id="credits-required-message" class="text-gray-700 mb-6 font-semibold"></p>
            <button class="action-btn bg-tf-secondary hover:bg-[#86259d] w-full" onclick="showTab('profile-plan', document.getElementById('profile-tab-btn')); closeCreditsModal();">View Plan / Renew</button>
        </div>
    </div>

    <div id="max-jobs-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="max-jobs-title">
        <div class="modal-content w-full max-w-md rounded-xl shadow-2xl p-6 bg-white relative text-center">
            <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeMaxJobsModal()">&times;</span>
            <i class="fas fa-hourglass-half text-tf-secondary text-4xl mb-4"></i>
            <h3 class="text-2xl font-bold text-tf-secondary mb-2" id="max-jobs-title">Job Processing Limit</h3>
            <p id="max-jobs-message-content" class="text-gray-700 mb-6 font-semibold">A bulk verification job is already in progress. Please wait for its completion before submitting a new file.</p>
            <button class="action-btn bg-tf-primary hover:bg-[#4d2e97] w-full" onclick="showTab('in-progress-jobs', document.getElementById('in-progress-tab-btn')); closeMaxJobsModal();">Monitor Active Job</button>
        </div>
    </div>

    <div id="cancel-job-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cancel-title">
        <div class="modal-content w-full max-w-sm rounded-xl shadow-2xl p-6 bg-white relative text-center">
            <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeCancelJobModal()">&times;</span>
            <i class="fas fa-times-circle text-alert-dark text-4xl mb-4"></i>
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="cancel-title">Confirm Cancellation</h3>
            <p id="cancel-job-message" class="text-gray-700 mb-6"></p>
            <div class="modal-actions flex justify-center gap-4">
                <button class="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300" onclick="closeCancelJobModal()">No, Keep Job</button>
                <button id="confirmCancelBtn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmJobCancellation()">Yes, Cancel Job</button>
            </div>
        </div>
    </div>

    <div id="inbox-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="inbox-title">
        <div class="modal-content w-full max-w-lg rounded-xl shadow-2xl p-6 bg-white relative">
            <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeInbox()">&times;</span>
            <h2 class="text-3xl font-bold mb-6 text-tf-primary flex items-center" id="inbox-title">
                <i class="fas fa-envelope-open-text mr-3"></i> Client Inbox
            </h2>

            <div id="client-inbox-list" class="mt-4 max-h-96 overflow-y-auto space-y-3">
                <p class="text-center text-gray-500 mt-5">Loading messages...</p>
            </div>

            <div id="full-message-detail" class="mt-6 pt-4" style="display:none;">
                <h3 id="full-message-subject" class="font-bold text-xl mb-1"></h3>
                <small id="full-message-date" class="text-gray-500 block mb-4"></small>
                <div id="full-message-body" class="p-4 border rounded bg-gray-50 whitespace-pre-wrap text-gray-700 max-h-40 overflow-y-auto"></div>
            </div>
        </div>
    </div>

    <div id="password-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="password-title">
        <div class="modal-content">
            <span class="modal-close" onclick="closePasswordModal()">&times;</span>
            <h2 class="text-2xl font-bold mb-4 text-tf-primary" id="password-title">Change Your Password</h2>

            <form id="password-update-form" class="space-y-4">
                <div class="form-group">
                    <label for="new-password">New Password</label>
                    <input type="password" id="new-password" name="newPassword" required minlength="6" class="w-full p-3 border rounded input-focus">
                </div>
                <div class="form-group">
                    <label for="confirm-password">Confirm New Password</label>
                    <input type="password" id="confirm-password" required minlength="6" class="w-full p-3 border rounded input-focus">
                </div>
                <button type="submit" id="updatePasswordBtn" class="action-btn w-full bg-red-600 hover:bg-red-700" role="button">Update & Log Out</button>
                <p id="password-update-status" class="mt-3 text-sm text-center text-gray-700"></p>
            </form>
            <p class="text-xs text-center text-gray-500 mt-4">Note: Changing your password will immediately log you out of all devices for security.</p>
        </div>
    </div>

    <div id="force-logout-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="force-logout-title">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-800 mb-2" id="force-logout-title">Another device is logged in</h3>
            <p class="text-gray-700">It looks like your account is currently active on another device. You can force-logout that session and continue here, or cancel to remain logged out.</p>
            <div class="modal-actions">
                <button id="forceCancelBtn" class="py-2 px-4 bg-gray-200 rounded-lg" onclick="closeForceModal()">Cancel</button>
                <button id="forceConfirmBtn" class="py-2 px-4 bg-red-600 text-white rounded-lg" onclick="forceLogoutOtherDevice()">Logout other device & Continue</button>
            </div>
        </div>
    </div>

    <script src="bulk_verification_logic.js"></script>
    <script>
        // --- CONSTANTS AND STATE ---
        const API_BASE = '/api';
        const API_CLIENT = `${API_BASE}/client/index`;
        const API_ENDPOINT = "/api/verify-single-address"; // used by single verification
        // NOTE: API_BULK_JOBS is defined in bulk_verification_logic.js.
        const LOGIN_PAGE = "client-login.html";

        let planDetails = JSON.parse(localStorage.getItem('planDetails') || '{}');
        const CLIENT_NAME = localStorage.getItem('clientName') || planDetails.clientName || planDetails.username || 'Client';
        let isPlanValid = true;

        const initialToken = localStorage.getItem('clientToken');
        if (!initialToken) {
            window.location.href = LOGIN_PAGE;
        }

        let activeJobPollInterval;
        let globalJobsData = { inProgress: [], completed: [] };
        let jobToCancel = null;

        function openCreditsModal(message) {
            document.getElementById('credits-required-message').textContent = message;
            document.getElementById('insufficient-credits-modal').style.display = 'flex';
        }
        function closeCreditsModal() { document.getElementById('insufficient-credits-modal').style.display = 'none'; }
        function openMaxJobsModal() { document.getElementById('max-jobs-modal').style.display = 'flex'; }
        function closeMaxJobsModal() { document.getElementById('max-jobs-modal').style.display = 'none'; }
        function openCancelJobModal(jobId) { jobToCancel = jobId; document.getElementById('cancel-job-message').textContent = `Are you sure you want to cancel Job ID: ${jobId}? This action cannot be undone.`; document.getElementById('cancel-job-modal').style.display = 'flex'; }
        function closeCancelJobModal() { document.getElementById('cancel-job-modal').style.display = 'none'; jobToCancel = null; }
        async function confirmJobCancellation() { if (jobToCancel) { window.handleCancelJobConfirmed && window.handleCancelJobConfirmed(jobToCancel); } closeCancelJobModal(); }

        window.openCreditsModal = openCreditsModal;
        window.closeCreditsModal = closeCreditsModal;
        window.openMaxJobsModal = openMaxJobsModal;
        window.closeMaxJobsModal = closeMaxJobsModal;
        window.openCancelJobModal = openCancelJobModal;
        window.closeCancelJobModal = closeCancelJobModal;
        window.confirmJobCancellation = confirmJobCancellation;

        async function sendHeartbeat() {
            const currentToken = localStorage.getItem('clientToken');
            if (!currentToken) return;
            try { await authFetch(`${API_CLIENT}?action=activity`, { method: 'POST' }); } catch (e) { console.warn("Heartbeat failed, session may be invalid:", e); }
        }

        async function logout() {
            const tokenToNotify = localStorage.getItem('clientToken');
            try {
                if (tokenToNotify) {
                    await fetch(`${API_CLIENT}?action=logout`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${tokenToNotify}`, 'Content-Type': 'application/json' }
                    });
                }
            } catch (error) { console.warn("Could not notify server of logout:", error); } finally { localStorage.clear(); window.location.href = LOGIN_PAGE; }
        }

        async function authFetch(url, options = {}) {
            const currentToken = localStorage.getItem('clientToken');
            if (!currentToken) { localStorage.clear(); window.location.href = LOGIN_PAGE; throw new Error("Session expired. Please log in again."); }
            const defaultHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` };
            const resp = await fetch(url, { ...options, headers: { ...defaultHeaders, ...(options.headers || {}) } });
            if (resp.status === 401 || resp.status === 403) { let debugText = ''; try { debugText = await resp.text(); } catch(e){} console.warn('authFetch got 401/403 from', url, 'server message:', debugText); localStorage.clear(); window.location.href = LOGIN_PAGE; throw new Error("Session expired. Please log in again."); }
            return resp;
        }

        async function fetchProfileData() {
            const currentToken = localStorage.getItem('clientToken');
            if (!currentToken) { localStorage.clear(); window.location.href = LOGIN_PAGE; return; }
            try {
                const resp = await fetch(`${API_CLIENT}?action=profile`, { method: 'GET', headers: { 'Authorization': `Bearer ${currentToken}`, 'Content-Type': 'application/json' } });
                if (resp.status === 401) {
                    let bodyText = ''; try { bodyText = await resp.text(); } catch(e){}
                    console.warn('Profile fetch 401:', bodyText);
                    if (bodyText && bodyText.toLowerCase().includes('session invalidated')) { localStorage.clear(); alert('Your session has been invalidated by the server (e.g., due to an admin action or password change). Please log in again.'); window.location.href = LOGIN_PAGE; return; }
                    updateUIFromLocalPlan();
                    return;
                }
                const json = await resp.json().catch(()=>null);
                if (!resp.ok || !json || json.status === 'Error') { console.warn('Profile fetch failed', resp.status, json); updateUIFromLocalPlan(); return; }

                const pd = json.planDetails || {};
                planDetails = Object.assign({}, planDetails, pd);
                localStorage.setItem('planDetails', JSON.stringify(planDetails));

                const rc = pd.remainingCredits;
                const creditsDisplay = rc === 'Unlimited' ? 'Unlimited' : (rc == null ? 'N/A' : Number(rc).toLocaleString());

                document.getElementById('plan-remaining-credits').textContent = creditsDisplay;
                document.getElementById('client-name-display').textContent = pd.clientName || CLIENT_NAME;
                document.getElementById('profile-username').textContent = pd.username || pd.clientName || CLIENT_NAME;
                document.getElementById('profile-email').textContent = pd.email || 'â€”';
                document.getElementById('profile-mobile').textContent = pd.mobile || 'â€”';
                document.getElementById('profile-bulk-code').textContent = pd.bulkAccessCode || 'N/A';
                document.getElementById('plan-name').textContent = (pd.planName || 'Not Set').split('_')[0];
                document.getElementById('validity-end').textContent = pd.validityEnd ? new Date(pd.validityEnd).toLocaleDateString() : 'N/A';
                const statusEl = document.getElementById('account-status');
                const isActive = (typeof pd.isActive === 'undefined') ? true : pd.isActive;
                statusEl.textContent = isActive ? 'Enabled' : 'Disabled';
                statusEl.className = `plan-status-badge ${isActive ? 'status-enabled' : 'status-disabled'}`;

                checkPlanValidity();
                if (document.getElementById('usage-chart')) { fetchUsageData().then(data => { if (data) renderUsageChart(data); }).catch(console.error); }
                if (typeof loadKpiData === 'function') loadKpiData();
            } catch (e) { console.error('fetchProfileData error:', e); updateUIFromLocalPlan(); }
        }

        async function fetchUsageData() {
            try {
                const resp = await authFetch(`${API_CLIENT}?action=usage-reports`, { method: 'GET' });
                const json = await resp.json().catch(() => null);
                if (resp.ok && json && json.status === 'Success') { return { labels: json.labels, creditsUsed: json.creditsUsed }; }
                console.warn('Failed to fetch real usage data, defaulting to empty:', json);
                return { labels: [], creditsUsed: [] };
            } catch (e) { console.error('Network error fetching usage data:', e); return { labels: [], creditsUsed: [] }; }
        }

        let usageChartInstance = null;
        function renderUsageChart(data) {
            if (usageChartInstance) usageChartInstance.destroy();
            const ctx = document.getElementById('usage-chart').getContext('2d');
            usageChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels: data.labels, datasets: [{ label: 'Credits Used', data: data.creditsUsed, borderColor: '#A437C1', backgroundColor: 'rgba(164, 55, 193, 0.1)', tension: 0.3, fill: true, pointRadius: 4, pointBackgroundColor: '#5F3DC4' }] },
                options: { responsive: true, maintainAspectRatio: true, scales: { y: { beginAtZero: true, title: { display: true, text: 'Credits' } } }, plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } } }
            });
        }

        function updateUIFromLocalPlan() {
            const rc = planDetails.remainingCredits ?? 'N/A';
            const creditsDisplay = rc === 'Unlimited' ? 'Unlimited' : (rc === 'N/A' ? 'N/A' : Number(rc).toLocaleString());
            document.getElementById('plan-remaining-credits').textContent = creditsDisplay;
            document.getElementById('client-name-display').textContent = CLIENT_NAME;
            document.getElementById('profile-username').textContent = planDetails.username || CLIENT_NAME;
            document.getElementById('profile-email').textContent = planDetails.email || 'â€”';
            document.getElementById('profile-mobile').textContent = planDetails.mobile || 'â€”';
            document.getElementById('profile-bulk-code').textContent = planDetails.bulkAccessCode || 'N/A';
            document.getElementById('plan-name').textContent = (planDetails.planName || 'Not Set').split('_')[0];
            document.getElementById('validity-end').textContent = planDetails.validityEnd ? new Date(planDetails.validityEnd).toLocaleDateString() : 'N/A';
            const statusEl = document.getElementById('account-status');
            const isActive = (typeof planDetails.isActive === 'undefined') ? true : planDetails.isActive;
            statusEl.textContent = isActive ? 'Enabled' : 'Disabled';
            statusEl.className = `plan-status-badge ${isActive ? 'status-enabled' : 'status-disabled'}`;
        }

        function checkPlanValidity() {
            const token = localStorage.getItem('clientToken');
            if (!token) { showAccessDenied("Please log in to access Bulk Address Verification."); isPlanValid = false; return false; }
            try {
                const validityEnd = planDetails.validityEnd ? new Date(planDetails.validityEnd) : null;
                const now = new Date();
                if (planDetails.isActive === false) { showAccessDenied("Your account has been **disabled** by the administrator. Please contact support."); isPlanValid = false; return false; }
                if (validityEnd && validityEnd < now) { showAccessDenied(`Your bulk plan expired on **${validityEnd.toLocaleDateString()}**. Please contact support to renew.`); isPlanValid = false; return false; }
                document.getElementById('bulkContent').classList.remove('hidden');
                const progressContainer = document.querySelector('#bulk-verification .progress-container');
                if (progressContainer) progressContainer.classList.remove('hidden');
                isPlanValid = true; return true;
            } catch (e) { console.error("Error parsing plan details:", e); showAccessDenied("Client authentication data is corrupted. Please log in again."); setTimeout(() => { localStorage.clear(); window.location.href = LOGIN_PAGE; }, 1500); isPlanValid = false; return false; }
        }

        function showAccessDenied(message) {
            const bulkContent = document.getElementById('bulkContent');
            const progressContainer = document.querySelector('#bulk-verification .progress-container');
            if (bulkContent) bulkContent.classList.add('hidden');
            if (progressContainer) progressContainer.classList.add('hidden');

            const existing = document.querySelector('#bulk-verification .access-denied-block');
            if (existing) return;
            const errorBlock = document.createElement('div');
            errorBlock.className = 'access-denied-block space-y-6 mt-6';
            errorBlock.innerHTML = `
                <div class="bg-red-50 p-8 rounded-xl border-l-4 border-alert-dark shadow-lg">
                    <p class="font-bold text-xl text-alert-dark mb-3 flex items-center">ðŸ›‘ Access Denied</p>
                    <p class="text-base text-gray-700 mb-6">${message.replace(/\*\*/g, '<strong>')}</p>
                </div>
                <a href="tel:+919193246219" class="block w-full py-3 bg-tf-secondary text-white text-center font-bold rounded-lg hover:bg-[#86259d] transition">Call Support / Renew Plan</a>
                <a href="https://wa.me/919193246219" target="_blank" class="block w-full py-3 bg-whatsapp-green text-white text-center font-bold rounded-lg hover:bg-green-600">ðŸŸ¢ WhatsApp Support</a>
            `;
            document.getElementById('bulk-verification').appendChild(errorBlock);
        }

        function openPasswordModal() { document.getElementById('password-modal').style.display = 'flex'; document.getElementById('password-update-form').reset(); document.getElementById('password-update-status').textContent = ''; }
        function closePasswordModal() { document.getElementById('password-modal').style.display = 'none'; }
        function openForceModal() { document.getElementById('force-logout-modal').style.display = 'flex'; }
        function closeForceModal() { document.getElementById('force-logout-modal').style.display = 'none'; }

        function getTokenPayload() { const token = localStorage.getItem('clientToken'); if (!token) return null; try { const payload = JSON.parse(atob(token.split('.')[1])); return payload; } catch (e) { return null; } }

        async function forceLogoutOtherDevice() {
            const payload = getTokenPayload();
            const clientId = payload && payload.clientId ? payload.clientId : (planDetails.id || planDetails.clientId);
            if (!clientId) { alert('Cannot determine clientId. Please log in again.'); closeForceModal(); localStorage.clear(); window.location.href = LOGIN_PAGE; return; }
            try {
                const resp = await fetch(`${API_CLIENT}?action=force-logout`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ clientId }) });
                const json = await resp.json().catch(()=>null);
                if (resp.ok && json && json.status === 'Success') { closeForceModal(); localStorage.removeItem('clientToken'); alert('Other device logged out. Please log in again here.'); window.location.href = LOGIN_PAGE; } else { console.warn('force-logout failed', resp.status, json); alert('Could not force logout other device. Contact support.'); closeForceModal(); }
            } catch (e) { console.error('force-logout error', e); alert('Network error. Try again or contact support.'); closeForceModal(); }
        }

        async function loadInboxCounts() {
            try { const response = await authFetch(`${API_BASE}/inbox/message`); const result = await response.json(); if (result.status === "Success" && result.unreadCount > 0) { const badge = document.getElementById('inbox-badge'); badge.textContent = result.unreadCount; badge.style.display = 'block'; } else { document.getElementById('inbox-badge').style.display = 'none'; } } catch (e) { console.error("Failed to load client inbox counts:", e); }
        }

        async function loadClientInbox() {
            const msgContainer = document.getElementById('client-inbox-list');
            const detailView = document.getElementById('full-message-detail');
            msgContainer.innerHTML = '<p class="text-center text-gray-500 mt-5">Loading messages...</p>';
            detailView.style.display = 'none';
            try {
                const response = await authFetch(`${API_BASE}/inbox/message`);
                const result = await response.json();
                if (result.status === "Success") {
                    msgContainer.innerHTML = '';
                    if (!result.messages || result.messages.length === 0) { msgContainer.innerHTML = '<p class="text-center text-gray-500 mt-5">No messages in your inbox.</p>'; return; }
                    result.messages.forEach(msg => {
                        const isUnread = !msg.isRead && msg.senderId === 'admin';
                        const cardClass = isUnread ? 'unread' : '';
                        const icon = isUnread ? 'fa-envelope' : 'fa-envelope-open';
                        const sender = msg.senderId === 'admin' ? 'Admin' : 'You';
                        const subjectEncoded = encodeURIComponent(msg.subject || '(No Subject)');
                        const bodyEncoded = encodeURIComponent(msg.body || '');
                        const messageHtml = `
                            <div id="msg-${msg._id}" class="msg-card ${cardClass}" onclick="viewClientMessage('${msg._id}', '${subjectEncoded}', '${bodyEncoded}', ${isUnread}, '${msg.timestamp}')">
                                <i class="fas ${icon} msg-icon"></i>
                                <div class="flex-grow">
                                    <p class="text-md truncate">${msg.subject || '(No Subject)'}</p>
                                    <small class="text-gray-500 block">From: ${sender} â€¢ ${new Date(msg.timestamp).toLocaleDateString()}</small>
                                </div>
                            </div>
                        `;
                        msgContainer.insertAdjacentHTML('beforeend', messageHtml);
                    });
                } else { msgContainer.innerHTML = `<p class="text-center text-red-500 mt-5">Failed to load inbox: ${result.message}</p>`; }
            } catch (error) { msgContainer.innerHTML = `<p class="text-center text-red-500 mt-5">Network Error: ${error.message}</p>`; }
        }

        function toggleInbox() { document.getElementById('inbox-modal').style.display = 'flex'; loadClientInbox(); }
        function closeInbox() { document.getElementById('inbox-modal').style.display = 'none'; loadInboxCounts(); }

        function viewClientMessage(messageId, subjectEncoded, bodyEncoded, isUnread, timestamp) {
            const subject = decodeURIComponent(subjectEncoded);
            const body = decodeURIComponent(bodyEncoded);
            const detailView = document.getElementById('full-message-detail');
            document.getElementById('full-message-subject').textContent = subject;
            document.getElementById('full-message-body').innerText = body;
            document.getElementById('full-message-date').textContent = new Date(timestamp).toLocaleString();
            detailView.style.display = 'block';
            if (isUnread) { authFetch(`${API_BASE}/inbox/message?messageId=${messageId}`, { method: 'PUT' }).catch(()=>{}); const card = document.getElementById(`msg-${messageId}`); if (card) { card.classList.remove('unread'); const iconEl = card.querySelector('.msg-icon'); if (iconEl) iconEl.classList.replace('fa-envelope', 'fa-envelope-open'); } setTimeout(loadInboxCounts, 500); }
        }

        function showTab(tabId, button) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabId).style.display = 'block';
            if (button) button.classList.add('active');
            if (activeJobPollInterval) { clearInterval(activeJobPollInterval); activeJobPollInterval = null; }
            if (tabId === 'bulk-verification') { checkPlanValidity(); if (typeof fetchTodayCompletedKpi === 'function') fetchTodayCompletedKpi(); }
            else if (tabId === 'profile-plan') { fetchProfileData(); }
            else if (tabId === 'in-progress-jobs' || tabId === 'completed-jobs') { startJobPolling(); }
            else if (tabId === 'deduction-history') { if (typeof fetchDeductionHistory === 'function') fetchDeductionHistory(1); }
            else if (tabId === 'single-verification') { document.getElementById('single-result-container').style.display = 'none'; fetchProfileData(); }
        }

        function startJobPolling() {
            if (activeJobPollInterval) clearInterval(activeJobPollInterval);
            fetchAndUpdateJobStatus();
            activeJobPollInterval = setInterval(fetchAndUpdateJobStatus, 5000);
            document.getElementById('in-progress-search')?.addEventListener('input', filterJobsList);
            document.getElementById('completed-search')?.addEventListener('input', filterJobsList);
        }

        function filterJobsList() {
            const activeSearchTerm = document.getElementById('in-progress-search')?.value.toLowerCase() || '';
            const completedSearchTerm = document.getElementById('completed-search')?.value.toLowerCase() || '';
            renderJobsList(globalJobsData.inProgress, 'in-progress-list', activeSearchTerm);
            renderJobsList(globalJobsData.completed, 'completed-list', completedSearchTerm);
        }

        function renderJobsList(jobs, containerId, searchTerm) {
            const container = document.getElementById(containerId);
            let filteredJobs = jobs;
            if (searchTerm) { filteredJobs = jobs.filter(job => job.filename.toLowerCase().includes(searchTerm) || job._id.toLowerCase().includes(searchTerm)); }
            let html = '';
            let activeCount = 0;
            for (const job of filteredJobs) {
                const progress = job.totalRows > 0 ? ((job.processedCount / job.totalRows) * 100).toFixed(0) : 0;
                const isFailed = job.status === 'Failed';
                const isCompleted = job.status === 'Completed';
                if (containerId === 'completed-list' && !searchTerm && html.split('job-card').length > 10) continue;
                const completionDisplay = isCompleted ? formatISTTime(job.completedTime) : new Date(job.submittedAt).toLocaleDateString();
                if (job.status === 'In Progress' || job.status === 'Queued') activeCount++;
                const cardHtml = `
                    <div class="job-card bg-white p-4 rounded-lg shadow-md border-l-4 ${isCompleted ? 'border-green-500' : isFailed || job.status === 'Cancelled' ? 'border-red-500' : 'border-tf-secondary'}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="font-bold text-lg text-gray-800 truncate">${job.filename}</h4>
                            <span class="text-sm font-semibold text-gray-600">${completionDisplay}</span>
                        </div>
                        <div class="text-sm text-gray-600 mb-2 space-y-1">
                            <p><strong>Status:</strong> <span class="font-bold">${job.status}</span></p>
                            ${job.status !== 'Cancelled' && job.status !== 'Failed' ? `<p><strong>Rows:</strong> ${job.processedCount} / ${job.totalRows}</p>` : ''}
                        </div>
                        ${job.status === 'In Progress' ? `
                            <div class="progress-bar w-full bg-gray-300 rounded-full h-2 mt-2">
                                <div class="progress-fill h-2 bg-tf-secondary rounded-full" style="width: ${progress}%;"></div>
                            </div>
                        ` : ''}
                        <div class="mt-3 flex gap-2 justify-end">
                            ${job.status === 'In Progress' || job.status === 'Queued' ? `
                                <button class="py-1 px-3 bg-red-500 text-white text-sm rounded hover:bg-red-600" onclick="handleCancelJob('${job._id}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>` : isCompleted ? `
                                <span class="text-xs text-gray-500 mr-2">Ready: ${job.countReady} | Manual: ${job.countManual}</span>
                                <button class="py-1 px-3 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition" onclick="handleAuthenticatedDownload('${job._id}', '${(job.filename||'').replace(/'/g, "\\'").replace(/"/g, '')}', 'ready')">
                                    <i class="fas fa-file-download"></i> Ready for Ship (${job.countReady})
                                </button>
                                <button class="py-1 px-3 bg-orange-500 text-white text-sm rounded hover:bg-orange-600 transition" onclick="handleAuthenticatedDownload('${job._id}', '${(job.filename||'').replace(/'/g, "\\'").replace(/"/g, '')}', 'manual')">
                                    <i class="fas fa-clipboard-list"></i> Manual Check Needed (${job.countManual})
                                </button>
                            ` : isFailed ? `<span class="text-red-500 text-sm italic">${job.error || 'Check server logs.'}</span>` : job.status === 'Cancelled' ? `<span class="text-red-500 text-sm italic">Cancelled by user.</span>` : ''}
                        </div>
                    </div>
                `;
                html += cardHtml;
            }
            container.innerHTML = html || `<p class="text-gray-500 text-center mt-5">No jobs found matching the filter.</p>`;
            if (containerId === 'in-progress-list' && !document.getElementById('in-progress-search')?.value) {
                document.getElementById('active-job-count').textContent = activeCount;
                const processBtn = document.getElementById('processButton');
                const bulkTabBtn = document.getElementById('bulk-tab-btn');
                const csvFileInput = document.getElementById('csvFileInput');
                if (activeCount >= 1) { if (processBtn) processBtn.disabled = true; if (bulkTabBtn) bulkTabBtn.style.borderBottom = '2px solid #EF4444'; } else { if (processBtn && csvFileInput) processBtn.disabled = !csvFileInput.files.length; if (bulkTabBtn) bulkTabBtn.style.borderBottom = '2px solid #5F3DC4'; }
            }
            const tsEl = document.getElementById(containerId.replace('-list', '-status-timestamp'));
            if (tsEl) tsEl.textContent = `Last refreshed: ${new Date().toLocaleTimeString()}`;
        }

        async function fetchAndUpdateJobStatus() {
            try {
                const resp = await authFetch(API_BULK_JOBS, { method: 'GET' });
                const result = await resp.json();
                if (result.status !== 'Success') { console.error('Failed to fetch job status:', result.message); return; }
                result.jobs.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
                globalJobsData.inProgress = result.jobs.filter(j => j.status === 'Queued' || j.status === 'In Progress');
                globalJobsData.completed = result.jobs.filter(j => j.status === 'Completed' || j.status === 'Failed' || j.status === 'Cancelled');
                filterJobsList();
                const afterCreditsResp = await getRemainingCredits();
                if (afterCreditsResp.ok) { const rc = afterCreditsResp.remainingCredits; const remEl = document.getElementById('plan-remaining-credits'); if (remEl) remEl.textContent = rc === 'Unlimited' ? 'Unlimited' : Number(rc).toLocaleString(); }
                if (typeof loadKpiData === 'function') loadKpiData();
            } catch (e) { console.error('Job polling failed:', e); document.getElementById('in-progress-list').innerHTML = '<p class="text-red-500 text-center mt-5">Failed to load status. Network error.</p>'; }
        }

        async function loadKpiData() {
            const today = new Date(); today.setHours(0,0,0,0);
            let completedToday = 0;
            if (globalJobsData.completed) {
                globalJobsData.completed.forEach(job => { const completedTime = job.completedTime; if (job.status === 'Completed' && completedTime) { const completedDate = new Date(completedTime); if (completedDate >= today) { completedToday += job.totalRows; } } });
            }
            document.getElementById('today-completed-kpi').textContent = completedToday.toLocaleString();
        }

        async function handleSingleVerification() {
            const addressInput = document.getElementById('single-address-input');
            const nameInput = document.getElementById('single-name-input');
            const resultContainer = document.getElementById('single-result-container');
            const statusMessage = document.getElementById('single-result-status');
            const verifyBtn = document.getElementById('singleVerifyBtn');
            if (!addressInput.value.trim()) { statusMessage.textContent = 'Please enter an address to verify.'; statusMessage.classList.add('text-red-600'); resultContainer.style.display = 'block'; return; }
            verifyBtn.disabled = true; verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Verifying...'; resultContainer.style.display = 'none'; statusMessage.className = 'font-semibold text-sm mb-3 text-gray-600'; statusMessage.textContent = 'Awaiting response...';
            const payload = { address: addressInput.value.trim(), customerName: nameInput.value.trim() };
            try {
                const resp = await authFetch(API_ENDPOINT, { method: 'POST', body: JSON.stringify(payload) });
                const result = await resp.json();
                const afterCreditsResp = await getRemainingCredits();
                if (afterCreditsResp.ok) { const rc = afterCreditsResp.remainingCredits; document.getElementById('plan-remaining-credits').textContent = rc === 'Unlimited' ? 'Unlimited' : Number(rc).toLocaleString(); }
                if (result.status === 'Success') {
                    const qualityClass = result.addressQuality === 'Very Good' || result.addressQuality === 'Good' ? 'text-green-600' : result.addressQuality === 'Medium' ? 'text-orange-500' : 'text-red-600';
                    statusMessage.textContent = `Verification Successful! Quality: ${result.addressQuality}. Location Suitability: ${result.locationSuitability}.`;
                    statusMessage.className = `font-bold text-base mb-3 ${qualityClass}`;
                    document.getElementById('clean-address-line1').textContent = result.addressLine1 || 'N/A';
                    document.getElementById('clean-address-line2').textContent = result.landmark || result.postOffice || 'â€”';
                    document.getElementById('clean-pin').textContent = result.pin || 'N/A';
                    document.getElementById('clean-district').textContent = result.district || 'N/A';
                    document.getElementById('clean-state').textContent = result.state || 'N/A';
                    document.getElementById('clean-quality').textContent = result.addressQuality || 'Unknown';
                    document.getElementById('clean-quality').className = qualityClass;
                    document.getElementById('single-remarks').textContent = `Remarks: ${ (result.remarks || '').replace(/CRITICAL_ALERT: /g, 'Warning: ') }`;
                } else {
                    statusMessage.textContent = `Verification Failed: ${result.error || result.message || 'Unknown Server Error'}`;
                    statusMessage.classList.add('text-red-600');
                    document.getElementById('clean-address-line1').textContent = payload.address;
                    document.getElementById('clean-address-line2').textContent = 'â€”';
                    document.getElementById('clean-pin').textContent = 'N/A';
                    document.getElementById('clean-district').textContent = 'N/A';
                    document.getElementById('clean-state').textContent = 'N/A';
                    document.getElementById('clean-quality').textContent = 'Very Bad';
                    document.getElementById('clean-quality').className = 'text-red-600';
                    document.getElementById('single-remarks').textContent = `Error: ${result.error || result.message || 'Could not process address.'}`;
                }
            } catch (error) { statusMessage.textContent = `Network Error: ${error.message}`; statusMessage.classList.add('text-red-600'); }
            finally { verifyBtn.disabled = false; verifyBtn.innerHTML = '<i class="fas fa-magic mr-2"></i> Verify Address'; resultContainer.style.display = 'block'; }
        }
        window.handleSingleVerification = handleSingleVerification;

        async function handleAuthenticatedDownload(jobId, jobFilename, fileType) {
            const suffix = (fileType === 'ready' ? '_READY_FOR_SHIPMENT' : '_MANUAL_CHECK_NEEDED');
            const safeFilename = `${jobFilename.replace('.csv', '').replace(/'/g, '').replace(/"/g, '')}${suffix}.csv`;
            const downloadUrl = `${API_BULK_JOBS}?action=download&jobId=${jobId}&type=${fileType}`;
            try {
                const resp = await authFetch(downloadUrl, { method: 'GET' });
                const contentType = (resp.headers.get && resp.headers.get('content-type') || '').toLowerCase();
                if (contentType.includes('application/json')) { let json = null; try { json = await resp.json(); } catch (e) {} const msg = (json && (json.message || json.error)) ? (json.message || json.error) : 'Server returned JSON instead of CSV.'; alert('Download failed: ' + msg); return; }
                if (!resp.ok) { const errorText = await resp.text(); try { const errorJson = JSON.parse(errorText); alert('Download failed: ' + (errorJson.message || errorJson.error || 'File unavailable.')); } catch (e) { alert('Download failed. Please try again later.'); } return; }
                const blob = await resp.blob(); const a = document.createElement('a'); a.style.display = 'none'; a.href = window.URL.createObjectURL(blob); a.download = safeFilename; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(a.href); a.remove();
            } catch (e) { console.error("Authenticated Download Failed:", e); alert('Download failed due to a network or authentication error.'); }
        }

        window.showTab = showTab; window.logout = logout; window.openPasswordModal = openPasswordModal; window.closePasswordModal = closePasswordModal; window.closeForceModal = closeForceModal; window.forceLogoutOtherDevice = forceLogoutOtherDevice; window.toggleInbox = toggleInbox; window.closeInbox = closeInbox; window.viewClientMessage = viewClientMessage; window.handleAuthenticatedDownload = handleAuthenticatedDownload; window.filterJobsList = filterJobsList; window.loadKpiData = loadKpiData;

        document.getElementById('password-update-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const statusEl = document.getElementById('password-update-status');
            const updateBtn = document.getElementById('updatePasswordBtn');
            if (newPassword !== confirmPassword) { statusEl.textContent = 'Passwords do not match.'; statusEl.className = 'text-red-600 mt-3'; return; }
            if (newPassword.length < 6) { statusEl.textContent = 'Password must be at least 6 characters.'; statusEl.className = 'text-red-600 mt-3'; return; }
            updateBtn.disabled = true; updateBtn.textContent = 'Processing...'; statusEl.textContent = 'Sending request to server...'; statusEl.className = 'text-tf-primary mt-3';
            try {
                const resp = await authFetch(`${API_CLIENT}?action=update-password`, { method: 'PUT', body: JSON.stringify({ newPassword }) });
                const result = await resp.json();
                if (resp.ok && result.status === 'Success') { statusEl.textContent = 'Password changed successfully! Redirecting to login...'; statusEl.className = 'text-green-600 mt-3'; setTimeout(logout, 1500); } else { statusEl.textContent = result.message || 'Update failed.'; statusEl.className = 'text-red-600 mt-3'; }
            } catch (error) { statusEl.textContent = 'Network error or session expired.'; statusEl.className = 'text-red-600 mt-3'; console.error('Password Update Error:', error); }
            finally { updateBtn.disabled = false; updateBtn.textContent = 'Update & Log Out'; }
        });

        window.onload = () => {
            fetchProfileData().then(()=> { if (typeof initBulkListeners === 'function') { initBulkListeners(); } else { console.error("Bulk listeners function not found. Make sure bulk_verification_logic.js is loaded."); } }).catch((e)=> { console.error('Error during profile init:', e); if (typeof initBulkListeners === 'function') initBulkListeners(); });
            loadInboxCounts();
            setInterval(sendHeartbeat, 60000);
            setInterval(loadInboxCounts, 60000);
            showTab('bulk-verification', document.getElementById('bulk-tab-btn'));
            try { ensureProcessButtonFallback(); } catch (e) { console.warn('Fallback init failed', e); }
        };

        function formatISTTime(utcTimestamp) { if (!utcTimestamp) return 'N/A'; const date = new Date(utcTimestamp); const options = { year: 'numeric', month: 'short', day: '2-digit', hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Asia/Kolkata' }; return date.toLocaleDateString('en-IN', options); }

        async function getRemainingCredits() { try { const resp = await authFetch(`${API_CLIENT}?action=remaining-credits`); const json = await resp.json().catch(()=>null); return json || { ok: false }; } catch (e) { return { ok: false }; } }

        function ensureProcessButtonFallback() {
            const fileInput = document.getElementById('csvFileInput');
            const processBtn = document.getElementById('processButton');
            const activeJobCountEl = document.getElementById('active-job-count');
            const MAX_ACTIVE = 1;
            if (!fileInput || !processBtn) return;
            function updateButtonState() { const active = Number(activeJobCountEl?.textContent || 0); const hasFile = fileInput.files && fileInput.files.length > 0; processBtn.disabled = !(hasFile && active < MAX_ACTIVE); }
            fileInput.addEventListener('change', updateButtonState, { passive: true });
            const observerTarget = activeJobCountEl;
            if (observerTarget) { const mo = new MutationObserver(updateButtonState); mo.observe(observerTarget, { childList: true, subtree: true, characterData: true }); }
            updateButtonState();
        }
    </script>
</body>
</html>
