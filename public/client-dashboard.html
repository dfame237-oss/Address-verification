<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f8fafc; color:#0f172a; }
    .card { background:#fff; border-radius:12px; padding:16px; box-shadow: 0 6px 20px rgba(2,6,23,0.06); }
  </style>
</head>
<body>
  <div class="max-w-5xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">Client Dashboard</h1>
      <div class="flex items-center gap-4">
        <div class="text-sm text-gray-600">Remaining Credits:</div>
        <div id="remaining-credits" class="px-3 py-1 bg-gray-100 rounded font-semibold">—</div>
        <button id="btn-logout" class="px-3 py-1 bg-red-500 text-white rounded">Logout</button>
      </div>
    </header>

    <section class="card mb-6">
      <h2 class="text-lg font-semibold mb-2">Bulk Verification</h2>
      <div id="bulk-controls" class="space-y-3">
        <input id="csvFileInput" type="file" accept=".csv" />
        <div>
          <button id="downloadTemplateButton" class="px-3 py-1 bg-gray-200 rounded">Download Template</button>
          <button id="processButton" class="px-3 py-1 bg-indigo-600 text-white rounded">Start Bulk Verification</button>
          <a id="downloadLink" class="ml-3 text-sm hidden" download="verified_addresses.csv">Download Verified CSV</a>
        </div>
        <div id="status-message" class="mt-2 text-sm text-gray-600"></div>
        <div class="w-full bg-gray-200 h-2 mt-2 rounded">
          <div id="progressBarFill" class="h-2 bg-indigo-500 rounded" style="width:0%"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 class="font-semibold mb-2">Profile</h3>
      <div id="profile-info" class="text-sm text-gray-700">
        Loading profile...
      </div>
    </section>
  </div>

  <!-- include bulk_verification_logic.js earlier in your page or as module -->
  <script src="bulk_verification_logic.js"></script>

  <script>
    // Minimal authFetch helper (your existing project already has one; this is a safe fallback)
    async function authFetch(url, options = {}) {
      const token = localStorage.getItem('clientToken');
      const headers = Object.assign({}, options.headers || {});
      if (token) headers['Authorization'] = 'Bearer ' + token;
      if (!headers['Content-Type'] && !(options.body instanceof FormData)) headers['Content-Type'] = 'application/json';
      const resp = await fetch(url, Object.assign({}, options, { headers }));
      // If server returns 401 due to session mismatch, throw to trigger logout
      if (resp.status === 401) {
        // Try to parse message for session mismatch, but treat all 401 as session expired
        throw new Error('Session expired');
      }
      return resp;
    }

    // Expose for bulk script (if your global already exists you can remove this)
    window.authFetch = authFetch;
    window.API_ENDPOINT = '/api/verify-single-address';
    window.LOGIN_PAGE = 'client-login.html';

    // Fetch & display remaining credits and profile summary
    async function refreshProfile() {
      const remEl = document.getElementById('remaining-credits');
      const profileEl = document.getElementById('profile-info');
      try {
        const resp = await authFetch('/api/verify-single-address', { method: 'GET' });
        const json = await resp.json();
        if (!resp.ok || json.status === 'Error') {
          profileEl.textContent = 'Could not load profile.';
          remEl.textContent = '—';
          return;
        }
        const rc = json.remainingCredits;
        remEl.textContent = rc === 'Unlimited' ? 'Unlimited' : Number(rc).toLocaleString();
        profileEl.innerHTML = `
          <div><strong>Plan:</strong> ${json.planName || '—'}</div>
          <div><strong>Initial Credits:</strong> ${json.initialCredits == null ? '—' : (json.initialCredits === 'Unlimited' ? 'Unlimited' : Number(json.initialCredits).toLocaleString())}</div>
          <div><strong>Remaining Credits:</strong> ${rc === 'Unlimited' ? 'Unlimited' : Number(rc).toLocaleString()}</div>
        `;
      } catch (e) {
        console.error('refreshProfile error:', e);
        // If session expired, force logout
        if (e.message && e.message.toLowerCase().includes('session')) {
          try { localStorage.removeItem('clientToken'); } catch (_) {}
          window.location.href = window.LOGIN_PAGE || 'client-login.html';
          return;
        }
        profileEl.textContent = 'Could not load profile (network).';
        remEl.textContent = '—';
      }
    }

    // Logout button
    document.getElementById('btn-logout').addEventListener('click', async () => {
      try {
        const token = localStorage.getItem('clientToken');
        if (!token) { window.location.href = window.LOGIN_PAGE; return; }
        await fetch('/api/client/logout', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
      } catch (e) {
        console.warn('Logout error', e);
      } finally {
        localStorage.removeItem('clientToken');
        window.location.href = window.LOGIN_PAGE;
      }
    });

    // On load: refresh profile and init bulk listeners
    window.addEventListener('DOMContentLoaded', async () => {
      await refreshProfile();
      if (typeof initBulkListeners === 'function') initBulkListeners();
      // Periodically refresh credits (optional): every 60s
      setInterval(refreshProfile, 60000);
    });
  </script>
</body>
</html>
