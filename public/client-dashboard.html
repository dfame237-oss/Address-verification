<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
Â  Â  <title>Smart Locator â€” Client Dashboard</title>

Â  Â  <link rel="stylesheet" href="style.css" />
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
Â  Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

Â  Â  <script>
        // FIX: Corrected the syntax error in the Tailwind config object (missing comma)
Â  Â  Â  Â  window.tailwind = {
Â  Â  Â  Â  Â  Â  config: {
Â  Â  Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ðŸ’œ Smart Locator/Teleforce Style Palette
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tf-primary': '#5F3DC4',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tf-secondary': '#A437C1',Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tf-dark': '#0F172A',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tf-text': '#E2E8F0',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tf-card': '#1E293B',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tf-light': '#F1F5F9',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'whatsapp-green': '#25D366',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'alert-dark': '#EF4444',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'alert-light': '#FEE2E2',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'success-light': '#D1FAE5',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'tf-primary-light': '#EFE7FF',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fontFamily: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sans: ['Inter', 'sans-serif'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
</script>

Â  Â  <script src="https://cdn.tailwindcss.com"></script>

Â  Â  <style>
Â  Â  Â  Â  /* Base styles adapted for new brand colors */
Â  Â  Â  Â  body { font-family: 'Inter', sans-serif;
background-color: #F1F5F9; }
Â  Â  Â  Â  /* FIX 1: Added text-gray-800 to ensure default text color is dark on white background */
Â  Â  Â  Â  .dashboard-container { max-width: 1200px;
margin: 30px auto; padding: 35px;
Â  Â  Â  Â  Â  Â  background-color: white; border-radius: 16px; box-shadow: 0 15px 40px rgba(0,0,0,0.1);
/* Removed padding-bottom to allow dashboard-layout to manage content height */
Â  Â  Â  Â  Â  Â  padding-bottom: 0;
}
Â  Â  Â  Â  .header { display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 20px;
border-bottom: 1px solid #E5E7EB;
Â  Â  Â  Â  }
Â  Â  Â  Â  .header h1 { font-weight: 700;
}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* --- NEW SIDEBAR LAYOUT STYLES --- */
Â  Â  Â  Â  .main-dashboard-layout {
Â  Â  Â  Â  Â  Â  display: grid;
grid-template-columns: 240px 1fr; /* Fixed sidebar width (240px) and main content */
Â  Â  Â  Â  Â  Â  gap: 30px;
}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .sidebar-nav {
Â  Â  Â  Â  Â  Â  background-color: #F8FAFC;
/* Light background for the sidebar */
Â  Â  Â  Â  Â  Â  padding: 15px 0;
border-radius: 12px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
Â  Â  Â  Â  Â  Â  height: fit-content; /* Ensure sidebar doesn't stretch too much */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .sidebar-header {
Â  Â  Â  Â  Â  Â  padding: 0 20px 10px;
border-bottom: 1px solid #E2E8F0;
Â  Â  Â  Â  }

Â  Â  Â  Â  .sidebar-section-title {
Â  Â  Â  Â  Â  Â  font-size: 0.8rem;
font-weight: 700;
Â  Â  Â  Â  Â  Â  color: #64748B; /* Gray text */
Â  Â  Â  Â  Â  Â  margin-top: 20px;
margin-bottom: 5px;
Â  Â  Â  Â  Â  Â  padding: 0 20px;
Â  Â  Â  Â  Â  Â  text-transform: uppercase;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Overrides for vertical tab buttons */
Â  Â  Â  Â  .nav-tabs .tab-button {
Â  Â  Â  Â  Â  Â  display: flex;
align-items: center;
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  text-align: left;
Â  Â  Â  Â  Â  Â  padding: 12px 20px;
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  Â  Â  border-left: 4px solid transparent;
Â  Â  Â  Â  Â  Â  color: #1E293B;
/* Darker default text */
Â  Â  Â  Â  Â  Â  font-weight: 500;
transition: background-color 0.2s, border-left 0.2s;
Â  Â  Â  Â  }

Â  Â  Â  Â  .nav-tabs .tab-button:hover {
Â  Â  Â  Â  Â  Â  background-color: #EFE7FF;
/* tf-primary-light on hover */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Active tab style */
Â  Â  Â  Â  .nav-tabs .tab-button.active {
Â  Â  Â  Â  Â  Â  color: #5F3DC4;
/* tf-primary text */
Â  Â  Â  Â  Â  Â  background-color: #EFE7FF;
/* tf-primary-light background */
Â  Â  Â  Â  Â  Â  border-left: 4px solid #5F3DC4;
/* Highlight bar */
Â  Â  Â  Â  Â  Â  font-weight: 700;
}
Â  Â  Â  Â Â 
Â  Â  Â  Â  .tab-content-area {
Â  Â  Â  Â  Â  Â  padding-bottom: 35px;
/* Re-apply padding removed from dashboard-container */
Â  Â  Â  Â  }

Â  Â  Â  Â  /* --- END SIDEBAR LAYOUT STYLES --- */

Â  Â  Â  Â  .tab-content { padding: 15px 0;
animation: fadeIn 0.5s;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0;
} to { opacity: 1;
Â  Â  Â  Â  } }
Â  Â  Â  Â  /* Controls are updated to align better */
Â  Â  Â  Â  .controls { display: flex;
gap: 15px; align-items: center;
Â  Â  Â  Â  }
Â  Â  Â  Â  .icon-btn { cursor: pointer; position: relative; font-size: 24px;
color: #64748B;
Â  Â  Â  Â  transition: color 0.2s; }
Â  Â  Â  Â  .icon-btn:hover { color: #5F3DC4;
}
Â  Â  Â  Â  .badge { position: absolute; top: -5px; right: -5px; background-color: #EF4444; color: white;
border-radius: 50%; padding: 3px 7px; font-size: 11px; }
Â  Â  Â  Â  .info-grid { display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
Â  Â  Â  Â  .profile-card, .plan-card { background-color: #F8FAFC;
padding: 30px; border-radius: 12px; border: 1px solid #E2E8F0; transition: box-shadow 0.2s;
}
Â  Â  Â  Â  .profile-card:hover, .plan-card:hover { box-shadow: 0 8px 20px rgba(0,0,0,0.08);
}
Â  Â  Â  Â  .info-item strong { color: #1E293B; margin-right: 8px; font-weight: 600;
}
Â  Â  Â  Â  .plan-status-badge { display: inline-block; padding: 6px 14px; border-radius: 9999px; font-size: 0.85rem;
font-weight: 700; }
Â  Â  Â  Â  .status-enabled { background-color: #EFE7FF; color: #5F3DC4;
}
Â  Â  Â  Â  .status-disabled { background-color: #FEE2E2; color: #DC2626;
}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* ENTERPRISE IMPROVEMENT & FIX 3 (Invisible Button Fix): Force colors via CSS */
Â  Â  Â  Â  .action-btn {Â 
Â  Â  Â  Â  Â  Â  background-color: #5F3DC4 !important;
color: white; padding: 10px 20px; border-radius: 8px;
Â  Â  Â  Â  Â  Â  border: none; cursor: pointer; font-weight: 600; transition: background-color 0.2s, transform 0.1s, opacity 0.2s;
}
Â  Â  Â  Â  .action-btn:hover { background-color: #4d2e97;Â 
Â  Â  Â  Â  Â  Â  transform: translateY(-1px);
}
Â  Â  Â  Â  .action-btn.logout {Â 
Â  Â  Â  Â  Â  Â  background-color: #DC2626 !important;
}
Â  Â  Â  Â  .action-btn.logout:hover { background-color: #B91C1C;
}
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Definitive Fix for Bulk Upload/Renewal/WhatsApp Buttons visibility */
Â  Â  Â  Â  .bg-tf-primary {
Â  Â  Â  Â  Â  Â  background-color: #5F3DC4 !important;
}
Â  Â  Â  Â  .bg-tf-secondary {
Â  Â  Â  Â  Â  Â  background-color: #A437C1 !important;
}
Â  Â  Â  Â  .bg-whatsapp-green {
Â  Â  Â  Â  Â  Â  background-color: #25D366 !important;
}
Â  Â  Â  Â  /* END FIX */

Â  Â  Â  Â  .progress-fill { background-color: #A437C1;
height: 0.75rem; border-radius: 9999px; transition: all 0.5s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Inbox Button Styles - integrated into header, not fixed */
Â  Â  Â  Â  #inbox-header-btn {Â 
Â  Â  Â  Â  Â  Â  position: relative;
background: #F8FAFC;Â 
Â  Â  Â  Â  Â  Â  border: 1px solid #CBD5E1;Â 
Â  Â  Â  Â  Â  Â  border-radius: 50%;Â 
Â  Â  Â  Â  Â  Â  padding: 10px 14px;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 5px rgba(0,0,0,0.08);
Â  Â  Â  Â  Â  Â  cursor: pointer;
transition: background-color 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  #inbox-header-btn:hover { background-color: #EFE7FF;
}
Â  Â  Â  Â  #inbox-header-btn .fas { font-size: 20px; color: #5F3DC4;
}
Â  Â  Â  Â  #inbox-header-btn .badge { top: -5px; right: -5px; padding: 2px 6px;
}
Â  Â  Â  Â  /* Style for the new Drag & Drop zone */
Â  Â  Â  Â  #drop-zone {
Â  Â  Â  Â  Â  Â  border: 2px dashed #CBD5E1;
border-radius: 12px;
Â  Â  Â  Â  Â  Â  padding: 30px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  transition: border-color 0.3s, background-color 0.3s;
}
Â  Â  Â  Â  #drop-zone.dragover {
Â  Â  Â  Â  Â  Â  border-color: #A437C1;
background-color: #EEF2FF;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Style for the CSV preview table */
Â  Â  Â  Â  #preview-table th {
Â  Â  Â  Â  Â  Â  background-color: #E2E8F0;
padding: 8px 12px;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #CBD5E1;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  }
Â  Â  Â  Â  #preview-table td {
Â  Â  Â  Â  Â  Â  padding: 8px 12px;
border-bottom: 1px solid #F1F5F9;
Â  Â  Â  Â  }


Â  Â  Â  Â  .modal { position: fixed; top: 0; left: 0;
width: 100%; height: 100%;
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 2000; display: none;
}
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  /* Default styles for centered modals */
Â  Â  Â  Â  Â  Â  padding: 24px;
border-radius: 12px;
Â  Â  Â  Â  Â  Â  background: #fff;
Â  Â  Â  Â  Â  Â  max-width: 520px; /* Standard size */
Â  Â  Â  Â  Â  Â  width: 90%;
box-shadow: 0 10px 25px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  animation: fadeIn 0.3s;
}
Â  Â  Â  Â  #full-message-detail { border: 1px solid #D1D5DB; background-color: #F8FAFC; border-radius: 8px; padding: 15px;
line-height: 1.6; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); }
Â  Â  Â  Â  #full-message-detail h3 { color: #A437C1;
padding-bottom: 8px; border-bottom: 1px dashed #E2E8F0; margin-bottom: 8px; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Mobile responsive layout overrides */
Â  Â  Â  Â  @media (max-width: 768px) {
Â  Â  Â  Â  Â  Â  .dashboard-container { padding: 15px;
margin: 10px auto; width: 95%; box-shadow: none; }
Â  Â  Â  Â  Â  Â  .header { flex-direction: column;
align-items: flex-start; margin-bottom: 20px; }
Â  Â  Â  Â  Â  Â  .header h1 { font-size: 1.75rem;
margin-bottom: 10px; }
Â  Â  Â  Â  Â  Â  .controls { width: 100%; justify-content: flex-end;
}
Â  Â  Â  Â  Â  Â  .main-dashboard-layout {
Â  Â  Â  Â  Â  Â  Â  Â  grid-template-columns: 1fr;
/* Sidebar collapses to full width */
Â  Â  Â  Â  Â  Â  Â  Â  gap: 15px;
}
Â  Â  Â  Â  Â  Â  .sidebar-nav {
Â  Â  Â  Â  Â  Â  Â  Â  /* On mobile, use a clean scrollable list if not hidden by JS toggle */
Â  Â  Â  Â  Â  Â  Â  Â  border-radius: 8px;
padding: 10px 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  /* Hide tab button details/icons on mobile if space is tight */
Â  Â  Â  Â  Â  Â  .nav-tabs .tab-button i {
Â  Â  Â  Â  Â  Â  Â  Â  display: none;
}
Â  Â  Â  Â  Â  Â  .tab-content-area {
Â  Â  Â  Â  Â  Â  Â  Â  padding-bottom: 20px;
}
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Force-logout modal small style */
Â  Â  Â  Â  #force-logout-modal .modal-content { max-width: 520px;
padding: 24px; border-radius: 12px; background: #fff; }
Â  Â  Â  Â  #force-logout-modal .modal-actions { margin-top: 16px; display:flex;
gap:10px; justify-content:flex-end; }
Â  Â  Â  Â  Â /* Message card styles */
Â  Â  Â  Â  .msg-card {Â 
Â  Â  Â  Â  Â  Â  display: flex;
/* Added flex to align icon and text */
Â  Â  Â  Â  Â  Â  align-items: center;
/* Center items vertically */
Â  Â  Â  Â  Â  Â  border: 1px solid #E5E7EB;
padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s;
}
Â  Â  Â  Â  .msg-card:hover { background-color: #F0F4FF; box-shadow: 0 2px 8px rgba(95, 61, 196, 0.1);
}
Â  Â  Â  Â  .msg-card.unread { background-color: #EEF2FF; border-left: 4px solid #5F3DC4; font-weight: 600;
}
Â  Â  Â  Â  .msg-card .msg-icon { font-size: 1.2rem; color: #5F3DC4; margin-right: 15px; flex-shrink: 0;
}
Â  Â  </style>
</head>
<body>
Â  Â  <div class="dashboard-container text-gray-800">
Â  Â  Â  Â  <header class="header">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-3xl font-bold text-gray-800">Welcome, <span id="client-name-display" class="text-tf-primary">Client</span></h1>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-500 mt-1">Manage your address verifications andÂ 
Â  Â  Â  Â  Â  Â  Â  Â  plan here.</div>
Â  Â Â 
Â Â 
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="inbox-header-btn" onclick="toggleInbox()" aria-label="Open Inbox" role="button">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-envelope-open-text"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="inbox-badge" class="badge" style="display:none;">0</span>
Â  Â  Â  Â  Â  Â 
Â  Â  Â </button>
Â  Â Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="logout()" class="action-btn logout" aria-label="Logout" role="button">Logout</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="main-dashboard-layout">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <asideÂ 
id="sidebar" class="sidebar-nav">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="sidebar-header">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-bold text-tf-dark">Dashboard Menu</h4>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="nav-tabs vertical" role="tablist">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â <h5 class="sidebar-section-title">Core Operations</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="bulk-tab-btn" class="tab-button active" onclick="showTab('bulk-verification', this)" role="tab" aria-selected="true">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-upload mr-2"></i> Bulk Verification
Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â </button>
                    <button id="single-tab-btn" class="tab-button" onclick="showTab('single-verification', this)" role="tab" aria-selected="false">
                        <i class="fas fa-search-location mr-2"></i> Single Lookup
                    </button>
                    Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="in-progress-tab-btn" class="tab-button" onclick="showTab('in-progress-jobs', this)" role="tab" aria-selected="false">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-hourglass-half mr-2"></i> In Progress
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  <button id="completed-tab-btn" class="tab-button" onclick="showTab('completed-jobs', this)" role="tab" aria-selected="false">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-check-circle mr-2"></i> Completed
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  <h5 class="sidebar-section-title">Analytics & Account</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="metrics-tab-btn" class="tab-button" onclick="showTab('metrics-reports', this)" role="tab" aria-selected="false">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-chart-bar mr-2"></i> Key Metrics & Usage
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="deduction-history-btn" class="tab-button" onclick="showTab('deduction-history', this)" role="tab" aria-selected="false">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-invoice-dollar mr-2"></i> Deduction History
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>

Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="profile-tab-btn" class="tab-button" onclick="showTab('profile-plan', this)" role="tab" aria-selected="false">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-user-circle mr-2"></i> Profile & Plan Status
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <button class="tab-button" onclick="showTab('support', this)" role="tab" aria-selected="false">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-headset mr-2"></i> Support
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â Â 
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </aside>
Â Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <main id="main-content" class="tab-content-area">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="bulk-verification" class="tab-content" role="tabpanel" aria-labelledby="bulk-tab-btn">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  <header class="text-center mb-10">
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-4xl font-extrabold text-gray-900 mb-2">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-tf-secondary">BulkÂ 
Address</span> Verification
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â Â 
</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-lg text-gray-500 mt-2">Upload a CSV file for high-volume cleaning and verification.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </header>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <divÂ 
id="kpi-grid" class="info-grid mb-8">
Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="profile-card w-full max-w-sm mx-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-md font-semibold text-gray-600 mb-2 flex items-center"><i class="fas fa-calendar-day mr-2 text-tf-primary"></i> Today's Completed Verifications</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
<p id="today-completed-kpi" class="text-3xl font-boldÂ 
text-tf-primary">0</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mt-1">Refreshed on tab load.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â Â 
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â <div id="bulkContent" class="space-y-8">
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  <div class="bg-tf-light p-8 rounded-xl border-l-4 border-tf-primary shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-xl text-tf-primary mb-3 flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
<i class="fas fa-download mr-3"></i> 1. Download Template
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-smÂ 
text-gray-600 mb-4">
Â Â 
Â  Â  Â  Â  Â  Â Use this template to ensure your CSV file has the required columns:Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <code class="bg-gray-200 px-1 rounded font-mono text-gray-900">ORDER ID</code>,Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
<code class="bg-gray-200 px-1Â 
rounded font-mono text-gray-900">CUSTOMERÂ 
NAME</code>,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <code class="bg-gray-200 px-1 rounded font-mono text-gray-900">CUSTOMER RAW ADDRESS</code>.
</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="downloadTemplateButton" class="w-full py-3 bg-tf-primary text-white font-semibold rounded-lg hover:bg-[#4d2e97] transition duration-200 focus:outline-none focus:ring-4 focus:ring-tf-primary focus:ring-opacity-50" role="button" aria-label="Download CSV Template">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Download Verification Template (CSV)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="bg-white p-8 rounded-xl border border-gray-200 shadow-lg text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <pÂ 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="font-bold text-xl text-gray-800 mb-4 flex items-center justify-center">
Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <i class="fas fa-upload mr-3 text-tf-secondary"></i> 2. Upload Your CSV File
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  <div id="drop-zone" class="mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 mb-2">Drag and drop your CSV file here, or click to select.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="csvFileInput" accept=".csv" class="hidden" aria-describedby="file-upload-hint">
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label for="csvFileInput" class="py-2 px-4 bg-tf-secondary/10 text-tf-secondary font-semibold rounded-lg hover:bg-tf-secondary/20 transition cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Choose File
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="file-name-display" class="text-gray-700 ml-3">No file chosen</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xsÂ 
Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â text-gray-500 mt-2" id="file-upload-hint">Maximum 1000 rows recommended for stability.
Must use the provided template format.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="preview-section" class="mt-4 hidden p-4 bg-gray-50 rounded border border-gray-200 overflow-x-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  <h4 class="font-semibold text-gray-800 mb-2">Preview (First 5 Rows)</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table id="preview-table" class="w-full text-sm text-left">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="processButton" class="w-full py-4 bg-tf-secondary text-white font-bold text-lg rounded-lg shadow-xl transition duration-200 transform hover:scale-[1.005] hover:bg-[#86259d] focus:outline-none focus:ring-4 focus:ring-tf-secondary focus:ring-opacity-50" disabled style="display:block;"
aria-label="Start Bulk Verification Process" role="button">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Start Verification
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-container mt-12 p-8 bg-tf-light rounded-xl border border-gray-300 shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Verification Status</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="status-message"Â 
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  class="font-semibold text-gray-600 mb-4 transition duration-300">Ready toÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upload.</p>

Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar w-full bg-gray-300 rounded-full h-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â <div class="progress-fill h-3 bg-tf-secondary rounded-full transition-all duration-500 ease-in-out" id="progressBarFill" style="width: 0%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="access-denied-message" class="hidden mt-6 text-center text-red-700Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â font-bold"></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
                
                <div id="single-verification" class="tab-content" style="display:none;" role="tabpanel" aria-labelledby="single-tab-btn">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                        <i class="fas fa-search-location mr-2 text-tf-primary"></i> Single Address Lookup
                    </h2>

                    <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-lg space-y-4 max-w-2xl mx-auto">
                        <p class="text-gray-600">Enter a single raw address to verify and clean instantly (1 credit).</p>

                        <form id="single-verify-form" onsubmit="event.preventDefault(); handleSingleVerification();">
                            <div class="space-y-4">
                                <input type="text" id="single-name-input" class="w-full p-3 border rounded focus:border-tf-primary" placeholder="Customer Name (Optional)" aria-label="Customer Name">
                                <textarea id="single-address-input" class="w-full p-3 border rounded focus:border-tf-primary resize-y" rows="3" placeholder="Enter Raw Address Here (e.g., H.No. 123, Street Name, City, Pincode)" required aria-label="Raw Address"></textarea>
                            </div>
                            
                            <button type="submit" id="singleVerifyBtn" class="action-btn w-full mt-4 bg-tf-primary hover:bg-[#4d2e97]" role="button" aria-label="Verify Single Address">
                                <i class="fas fa-magic mr-2"></i> Verify Address
                            </button>
                        </form>
                    </div>

                    <div id="single-result-container" class="mt-6 p-6 bg-tf-light rounded-xl border border-gray-300 shadow-inner max-w-2xl mx-auto" style="display:none;">
                        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-clipboard-check mr-2 text-green-600"></i> Verification Results
                        </h3>
                        <p id="single-result-status" class="font-semibold text-sm mb-3"></p>
                        
                        <div id="single-result-details" class="info-grid">
                            <div class="profile-card">
                                <h4 class="font-semibold text-gray-600 mb-2">Clean Address</h4>
                                <p class="text-lg font-bold text-tf-primary" id="clean-address-line1"></p>
                                <p class="text-sm text-gray-600" id="clean-address-line2"></p>
                            </div>
                            <div class="profile-card">
                                <h4 class="font-semibold text-gray-600 mb-2">Geographic Data</h4>
                                <div class="info-item"><strong>PIN:</strong> <span id="clean-pin"></span></div>
                                <div class="info-item"><strong>District:</strong> <span id="clean-district"></span></div>
                                <div class="info-item"><strong>State:</strong> <span id="clean-state"></span></div>
                                <div class="info-item"><strong>Quality:</strong> <span id="clean-quality"></span></div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-4" id="single-remarks"></p>
                    </div>
                </div>
                Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="in-progress-jobs" class="tab-content" style="display:none;"
role="tabpanel" aria-labelledby="in-progress-tab-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6">Active Jobs (<span id="active-job-count">0</span>/1)</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="in-progress-search" class="w-full p-3 border rounded mb-4" placeholder="Filter jobs by Filename or Job ID">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mb-4" id="in-progress-status-timestamp">Last refreshed: Just now.</p>

Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â <div id="in-progress-list" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 text-center">Loading active jobs...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="max-jobs-message" class="text-red-600 font-bold mt-4" style="display:none;">Maximum 1 job is running.
Please wait for completion.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div id="completed-jobs" class="tab-content" style="display:none;"
role="tabpanel" aria-labelledby="completed-tab-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6">Completed Jobs</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="completed-search" class="w-full p-3 border rounded mb-4" placeholder="Filter jobs by Filename or Job ID">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500 mb-4" id="completed-status-timestamp">Last refreshed: Just now.</p>
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="completed-list" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-gray-500 text-center">No recently completed jobs.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â 
Â  Â  Â  Â  Â  Â  Â <div id="metrics-reports" class="tab-content" style="display:none;"
role="tabpanel" aria-labelledby="metrics-tab-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6">Key Metrics & Usage Reports</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="profile-card mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-tf-primary mb-4Â 
flex items-center"><i class="fas fa-chart-area mr-2"></i> Last 30 Days Usage Trend</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <canvas id="usage-chart" role="img" aria-label="Line chart showing credits used over the past 30 days."></canvas>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="deduction-history" class="tab-content"Â 
style="display:none;" role="tabpanel" aria-labelledby="deduction-history-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center"><i class="fas fa-file-invoice-dollar mr-2"></i> Verification Deduction History</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600 mb-4">This section displays a detailed history of your bulk verification jobs and credit usage. **History is limited to the last 90 days.**</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="deduction-history-list" class="space-y-4">
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-500 text-center">Loading history...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="profile-plan" class="tab-content"Â 
Â  Â  Â  Â 
Â  Â  Â  Â  Â style="display:none;"
role="tabpanel" aria-labelledby="profile-tab-btn">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-gray-800 mb-6">Account Overview</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-grid">
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="profile-card flex flex-col justify-between">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xlÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  font-semibold text-tf-primary mb-4 flex items-center"><i class="fas fa-user-circle mr-2"></i> My Profile Details</h3>
Â  Â Â 
Â  Â  Â  Â  Â 
Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><p><strong>Username:</strong> <span id="profile-username"></span></p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><p><strong>Email:</strong> <span id="profile-email"></span></p></div>
Â  Â  Â Â 
Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><p><strong>Mobile:</strong> <span id="profile-mobile"></span></p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  <div class="info-item"><p><strong>Access Code:</strong> <span id="profile-bulk-code"></span></p></div>
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn mt-6 w-full bg-gray-500 text-white hover:bg-gray-600" onclick="openPasswordModal()" role="button" aria-label="Change Password">Change Password</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="plan-card">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-semibold text-tf-secondary mb-4 flex items-center"><iÂ 
class="fas fa-award mr-2"></i> Plan Status</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â Â 
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  <div class="info-item"><p><strong>Current Plan:</strong> <span id="plan-name" class="font-bold"></span></p></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><p><strong>Status:</strong> <span id="account-status"></span></p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  <div class="info-item"><p><strong>Valid Until:</strong> <span id="validity-end"></span></p></div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="info-item"><p><strong>Remaining Credits:</strong> <span id="plan-remaining-credits" class="font-bold text-tf-secondary">N/A</span></p></div>
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-btn mt-6 w-full bg-tf-secondaryÂ 
Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hover:bg-[#86259d]" onclick="showTab('support', document.querySelector('.nav-tabs .tab-button:last-child'))" role="button" aria-label="Contact support for renewal">Contact for Renewal</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="support" class="tab-content" style="display:none;"
role="tabpanel">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-8 border rounded-xl shadow-md bg-tf-light space-y-6 max-w-lg mx-auto">
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-4 flex items-center text-tf-primary">
Â  Â  Â Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-headset mr-3"></i> Contact Support
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h2>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-gray-600">Need help with plan renewal, technical issues, orÂ 
credits?
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Contact our dedicated support team instantly.</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://wa.me/919193246219" target="_blank" class="block w-full py-4 bg-whatsapp-green text-white font-bold rounded-lg shadow-lg hover:bg-green-600 transition transform hover:scale-[1.005] flex items-center justify-center" role="button" aria-label="Contact Support via WhatsApp">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fab fa-whatsapp text-xl mr-3"></i> WhatsApp Support (+91 9193246219)
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </a>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="tel:+919193246219"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="block w-full py-4 bg-tf-primary text-white font-bold rounded-lg hover:bg-[#4d2e97] transition transform hover:scale-[1.005] flex items-center justify-center" role="button" aria-label="Call Support">
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  <i class="fas fa-phone mr-3"></i> Call Support (+91 9193246219)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </main>
Â  Â 
Â  Â  Â </div>
Â  Â  </div>

Â  Â 
Â <div id="insufficient-credits-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="credits-title">
Â  Â  Â  Â  <div class="modal-content w-full max-w-md rounded-xl shadow-2xl p-6 bg-white relative text-center">
Â  Â  Â  Â  Â  Â  <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeCreditsModal()">&times;</span>
Â  Â  Â  Â  Â  Â  <i class="fas fa-exclamation-triangle text-alert-dark text-4xl mb-4"></i>
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-alert-dark mb-2" id="credits-title">Credit Alert</h3>
Â  Â  Â  Â  Â  Â  <p id="credits-required-message" class="text-gray-700 mb-6 font-semibold"></p>
Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  <button class="action-btn bg-tf-secondary hover:bg-[#86259d] w-full" onclick="showTab('profile-plan', document.getElementById('profile-tab-btn'));
closeCreditsModal();">View Plan / Renew</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="max-jobs-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="max-jobs-title">
Â  Â  Â  Â  <div class="modal-content w-full max-w-md rounded-xl shadow-2xl p-6 bg-white relative text-center">
Â  Â  Â  Â  Â  Â  <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeMaxJobsModal()">&times;</span>
Â  Â  Â  Â  Â  Â  <i class="fas fa-hourglass-half text-tf-secondary text-4xl mb-4"></i>
Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold text-tf-secondary mb-2" id="max-jobs-title">Job Processing Limit</h3>
Â  Â Â 
Â  Â  Â  Â  Â <p id="max-jobs-message-content" class="text-gray-700 mb-6 font-semibold">A bulk verification job is already in progress. Please wait for its completion before submitting a new file.</p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <button class="action-btn bg-tf-primary hover:bg-[#4d2e97] w-full" onclick="showTab('in-progress-jobs', document.getElementById('in-progress-tab-btn'));
closeMaxJobsModal();">Monitor Active Job</button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="cancel-job-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="cancel-title">
Â  Â  Â  Â  <div class="modal-content w-full max-w-sm rounded-xl shadow-2xl p-6 bg-white relative text-center">
Â  Â  Â  Â  Â  Â  <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeCancelJobModal()">&times;</span>
Â  Â  Â  Â  Â  Â  <i class="fas fa-times-circle text-alert-dark text-4xl mb-4"></i>
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-800 mb-2" id="cancel-title">Confirm Cancellation</h3>
Â  Â  Â Â 
Â  Â  Â  Â <p id="cancel-job-message" class="text-gray-700 mb-6"></p>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="modal-actions flex justify-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="py-2 px-4 bg-gray-200 rounded-lg hover:bg-gray-300" onclick="closeCancelJobModal()">No, Keep Job</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="confirmCancelBtn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700" onclick="confirmJobCancellation()">Yes, Cancel Job</button>
Â  Â  Â  Â  Â  Â  </div>
Â 
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="inbox-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="inbox-title">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="modal-content w-full max-w-lg rounded-xl shadow-2xl p-6 bg-white relative">
Â  Â  Â  Â  Â  Â  <span class="modal-close absolute right-4 top-4 text-2xl cursor-pointer" onclick="closeInbox()">&times;</span>
Â  Â  Â  Â  Â  Â  <h2 class="text-3xl font-bold mb-6 text-tf-primary flex items-center" id="inbox-title">
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â 
<i class="fas fa-envelope-open-text mr-3"></i> Client Inbox
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  </h2>

Â  Â  Â  Â  Â  Â  <div id="client-inbox-list" class="mt-4 max-h-96 overflow-y-auto space-y-3">
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-center text-gray-500 mt-5">Loading messages...</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="full-message-detail" class="mt-6 pt-4"Â 
style="display:none;">
Â Â 
Â  Â  Â  Â  Â  Â  Â  <h3 id="full-message-subject" class="font-bold text-xl mb-1"></h3>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <smallÂ 
Â  Â  Â  Â  Â  Â  Â  Â  id="full-message-date" class="text-gray-500 block mb-4"></small>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â Â 
<div id="full-message-body"Â 
class="p-4 border rounded bg-gray-50 whitespace-pre-wrap text-gray-700 max-h-40 overflow-y-auto"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  </div>

Â  Â  <div id="password-modal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="password-title">
Â  Â Â 
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <span class="modal-close" onclick="closePasswordModal()">&times;</span>
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-4 text-tf-primary" id="password-title">Change Your Password</h2>
Â  Â  Â  Â  Â  Â 
Â  <formÂ 
id="password-update-form" class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-password">New Password</label>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="new-password" name="newPassword" required minlength="6" class="w-full p-3 border rounded input-focus">
Â  Â  Â  Â  Â  Â Â 
Â  Â 
Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="form-group">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="confirm-password">Confirm New Password</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="password" id="confirm-password"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  required minlength="6" class="w-full p-3 border rounded input-focus">
Â  Â  Â  Â 
Â  Â 
Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" id="updatePasswordBtn" class="action-btn w-full bg-red-600 hover:bg-red-700" role="button">Update & Log Out</button>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="password-update-status" class="mt-3 text-sm text-center text-gray-700"></p>
Â  Â  Â  Â  Â  Â  </form>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-center text-gray-500 mt-4">Note: Changing your passwordÂ 
Â  Â  Â  Â  Â  Â Â 
will immediatelyÂ 
log you out of all devices for security.</p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â Â 
Â  Â  </div>


Â  Â  <div id="force-logout-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="force-logout-title">
Â  Â  Â  Â  <div class="modal-content">
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-800 mb-2" id="force-logout-title">Another deviceÂ 
Â  Â  Â  Â  Â  Â  is logged in</h3>
Â  Â  Â  Â  Â  Â Â 
Â <p class="text-gray-700">ItÂ 
looks like your account is currently active on another device.
Â You can force-logout that session and continue here, or cancel to remain logged out.</p>

Â  Â  Â  Â  Â  Â  <div class="modal-actions">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="forceCancelBtn" class="py-2 px-4 bg-gray-200 rounded-lg" onclick="closeForceModal()" role="button">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="forceConfirmBtn" class="py-2 px-4 bg-red-600 text-white rounded-lg" onclick="forceLogoutOtherDevice()" role="button">Logout other device & Continue</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â 
Â </div>

Â  Â  <script src="bulk_verification_logic.js"></script>
Â  Â  <script>
Â  Â  Â  Â  // --- CONSTANTS AND STATE ---
Â  Â  Â  Â  const API_BASE = '/api';
Â  Â  Â  Â  const API_CLIENT = `${API_BASE}/client/index`;
Â  Â  Â  Â  const API_ENDPOINT = "/api/verify-single-address"; // used by single verification
Â  Â  Â  Â  // NOTE: API_BULK_JOBS is defined in bulk_verification_logic.js.
Â  Â  Â  Â  const LOGIN_PAGE = "client-login.html";
Â  Â  Â  Â Â 
Â  Â  Â  Â  let planDetails = JSON.parse(localStorage.getItem('planDetails') || '{}');
Â  Â  Â  Â  const CLIENT_NAME = localStorage.getItem('clientName') || planDetails.clientName || planDetails.username || 'Client';
Â  Â  Â  Â  let isPlanValid = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const initialToken = localStorage.getItem('clientToken');
Â  Â  Â  Â  if (!initialToken) {
Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  }

Â  Â  Â  Â  let activeJobPollInterval;Â 
Â  Â  Â  Â  let globalJobsData = { inProgress: [], completed: [] };
Â  Â  Â  Â  // Storage for filtering (NEW)

Â  Â  Â  Â  // --- GLOBAL MODAL STATE FOR CANCELLATION ---
Â  Â  Â  Â  let jobToCancel = null;
Â  Â  Â  Â  // --- NEW MODAL HELPERS (CREDITS & MAX JOBS & CANCEL) ---

Â  Â  Â  Â  function openCreditsModal(message) {
Â  Â  Â  Â  Â  Â  document.getElementById('credits-required-message').textContent = message;
Â  Â  Â  Â  Â  Â  document.getElementById('insufficient-credits-modal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeCreditsModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('insufficient-credits-modal').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function openMaxJobsModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('max-jobs-modal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeMaxJobsModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('max-jobs-modal').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function openCancelJobModal(jobId) {
Â  Â  Â  Â  Â  Â  jobToCancel = jobId;
Â  Â  Â  Â  Â  Â  document.getElementById('cancel-job-message').textContent = `Are you sure you want to cancel Job ID: ${jobId}? This action cannot be undone.`;
Â  Â  Â  Â  Â  Â  document.getElementById('cancel-job-modal').style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeCancelJobModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('cancel-job-modal').style.display = 'none';
Â  Â  Â  Â  Â  Â  jobToCancel = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  // Function triggered by the modal "Yes, Cancel Job" button
Â  Â  Â  Â  function confirmJobCancellation() {
Â  Â  Â  Â  Â  Â  if (jobToCancel) {
Â  Â  Â  Â  Â  Â  Â  Â  // IMPORTANT: This calls the actual API function defined in bulk_verification_logic.js
Â  Â  Â  Â  Â  Â  Â  Â  window.handleCancelJobConfirmed(jobToCancel);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  closeCancelJobModal();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Expose helpers globally
Â  Â  Â  Â  window.openCreditsModal = openCreditsModal;
Â  Â  Â  Â  window.closeCreditsModal = closeCreditsModal;
Â  Â  Â  Â  window.openMaxJobsModal = openMaxJobsModal;
Â  Â  Â  Â  window.closeMaxJobsModal = closeMaxJobsModal;
Â  Â  Â  Â  window.openCancelJobModal = openCancelJobModal;
Â  Â  Â  Â  // NEW
Â  Â  Â  Â  window.closeCancelJobModal = closeCancelJobModal;
Â  Â  Â  Â  // NEW
Â  Â  Â  Â  window.confirmJobCancellation = confirmJobCancellation;
Â  Â  Â  Â  // NEW


Â  Â  Â  Â  // --- HEARTBEAT FUNCTION (PUBLIC) ---
Â  Â  Â  Â  async function sendHeartbeat() {
Â  Â  Â  Â  Â  Â  const currentToken = localStorage.getItem('clientToken');
Â  Â  Â  Â  Â  Â  if (!currentToken) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await authFetch(`${API_CLIENT}?action=activity`, { method: 'POST' });
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Heartbeat failed, session may be invalid:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- LOGOUT (PUBLIC) ---
Â  Â  Â  Â  async function logout() {
Â  Â  Â  Â  Â  Â  const tokenToNotify = localStorage.getItem('clientToken');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  if (tokenToNotify) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await fetch(`${API_CLIENT}?action=logout`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 'Authorization': `Bearer ${tokenToNotify}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn("Could not notify server of logout:", error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- authFetch (PUBLIC) ---
Â  Â  Â  Â  async function authFetch(url, options = {}) {
Â  Â  Â  Â  Â  Â  const currentToken = localStorage.getItem('clientToken');
Â  Â  Â  Â  Â  Â  if (!currentToken) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Session expired. Please log in again.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const defaultHeaders = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentToken}` };
Â  Â  Â  Â  Â  Â  const resp = await fetch(url, { ...options, headers: { ...defaultHeaders, ...(options.headers || {}) } });
Â  Â  Â  Â  Â  Â  if (resp.status === 401 || resp.status === 403) {
Â  Â  Â  Â  Â  Â  Â  Â  let debugText = '';
Â  Â  Â  Â  Â  Â  Â  Â  try { debugText = await resp.text(); } catch(e){}
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('authFetch got 401/403 from', url, 'server message:', debugText);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Session expired. Please log in again.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return resp;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Profile fetch (PUBLIC) ---
Â  Â  Â  Â  async function fetchProfileData() {
Â  Â  Â  Â  Â  Â  const currentToken = localStorage.getItem('clientToken');
Â  Â  Â  Â  Â  Â  if (!currentToken) {
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const resp = await fetch(`${API_CLIENT}?action=profile`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'GET',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Authorization': `Bearer ${currentToken}`, 'Content-Type': 'application/json' }
Â  Â  Â  Â  Â  Â  Â Â 
Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if (resp.status === 401) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let bodyText = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { bodyText = await resp.text(); } catch(e){}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Profile fetch 401:', bodyText);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL FIX: Handle Session Invalidation (Admin Action)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bodyText && bodyText.toLowerCase().includes('session invalidated')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Session invalidated by server (Admin action or change). Redirecting to login.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 1. Clear local storage to fully break the session
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // 2. Display alert/message and redirect
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Your session has been invalidated by the server (e.g., due to an admin action or password change). Please log in again.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Original logic for 401/403 errors when not due to invalidation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUIFromLocalPlan();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const json = await resp.json().catch(()=>null);
Â  Â  Â  Â  Â  Â  Â  Â  if (!resp.ok || !json || json.status === 'Error') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Profile fetch failed', resp.status, json);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  updateUIFromLocalPlan();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const pd = json.planDetails ||
{};
Â  Â  Â  Â  Â  Â  Â  Â  // Correct assignment of data to planDetails
Â  Â  Â  Â  Â  Â  Â  Â  planDetails = Object.assign({}, planDetails, pd);
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('planDetails', JSON.stringify(planDetails));

Â  Â  Â  Â  Â  Â  Â  Â  const rc = pd.remainingCredits;
Â  Â  Â  Â  Â  Â  Â  Â  const creditsDisplay = rc === 'Unlimited' ?
'Unlimited' : (rc == null ? 'N/A' : Number(rc).toLocaleString());
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('plan-remaining-credits').textContent = creditsDisplay;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('client-name-display').textContent = pd.clientName || CLIENT_NAME;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profile-username').textContent = pd.username || pd.clientName || CLIENT_NAME;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profile-email').textContent = pd.email || 'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profile-mobile').textContent = pd.mobile || 'â€”';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('profile-bulk-code').textContent = pd.bulkAccessCode || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('plan-name').textContent = (pd.planName || 'Not Set').split('_')[0];
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('validity-end').textContent = pd.validityEnd ? new Date(pd.validityEnd).toLocaleDateString() : 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('account-status');
Â  Â  Â  Â  Â  Â  Â  Â  const isActive = (typeof pd.isActive === 'undefined') ? true : pd.isActive;
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = isActive ?
'Enabled' : 'Disabled';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.className = `plan-status-badge ${isActive ? 'status-enabled' : 'status-disabled'}`;

Â  Â  Â  Â  Â  Â  Â  Â  checkPlanValidity();
// --- Enterprise Improvement: Load Chart Data (Placeholder -> REAL API) ---
Â  Â  Â  Â  Â  Â  Â  Â  if (document.getElementById('usage-chart')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fetchUsageData().then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â 
Â  Â renderUsageChart(data);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).catch(console.error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // FIX 1: Initial call to load KPI data after profile fetch
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof loadKpiData === 'function') loadKpiData();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('fetchProfileData error:', e);
Â  Â  Â  Â  Â  Â  Â  Â  updateUIFromLocalPlan();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Enterprise Improvement: Usage Data (Placeholder -> REAL) ---
Â  Â  Â  Â  async function fetchUsageData() {
Â  Â  Â  Â  Â  Â  // NOTE: This now calls the real server endpoint for the last 30 days of deductions
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â 
Â  const resp = await authFetch(`${API_CLIENT}?action=usage-reports`, { method: 'GET' });
Â  Â  Â  Â  Â  Â  Â  Â  const json = await resp.json().catch(() => null);
Â  Â  Â  Â  Â  Â  Â  Â  if (resp.ok && json && json.status === 'Success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Returns { labels: [], creditsUsed: [] } directly from the server
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { labels: json.labels, creditsUsed: json.creditsUsed };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Failed to fetch real usage data, defaulting to empty:', json);
Â  Â  Â  Â  Â  Â  Â  Â  return { labels: [], creditsUsed: [] };
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Network error fetching usage data:', e);
Â  Â  Â  Â  Â  Â  Â  Â  return { labels: [], creditsUsed: [] };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  let usageChartInstance = null;
Â  Â  Â  Â  function renderUsageChart(data) {
Â  Â  Â  Â  Â  Â  if (usageChartInstance) {
Â  Â  Â  Â  Â  Â  Â  Â  usageChartInstance.destroy();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const ctx = document.getElementById('usage-chart').getContext('2d');
Â  Â  Â  Â  Â  Â  usageChartInstance = new Chart(ctx, {
Â  Â  Â  Â  Â  Â  Â  Â  type: 'line',
Â  Â  Â  Â  Â  Â  Â  Â  data: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: data.labels,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  label: 'Credits Used',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: data.creditsUsed,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#A437C1',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: 'rgba(164, 55, 193, 0.1)',
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  tension: 0.3,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fill: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointRadius: 4,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointBackgroundColor: '#5F3DC4'
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  }]
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsive: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  scales:Â 
{
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  y: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  beginAtZero: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: {
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â display: true,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  text: 'Credits'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plugins: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  display: false
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tooltip: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mode: 'index',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  intersect: false,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }


Â  Â  Â  Â  // --- Update UI from Local Plan (PUBLIC) ---
Â  Â  Â  Â  function updateUIFromLocalPlan() {
Â  Â  Â  Â  Â  Â  const rc = planDetails.remainingCredits ??
'N/A';
Â  Â  Â  Â  Â  Â  const creditsDisplay = rc === 'Unlimited' ? 'Unlimited' : (rc === 'N/A' ? 'N/A' : Number(rc).toLocaleString());
Â  Â  Â  Â  Â  Â  document.getElementById('plan-remaining-credits').textContent = creditsDisplay;
Â  Â  Â  Â  Â  Â  document.getElementById('client-name-display').textContent = CLIENT_NAME;
Â  Â  Â  Â  Â  Â  document.getElementById('profile-username').textContent = planDetails.username || CLIENT_NAME;
Â  Â  Â  Â  Â  Â  document.getElementById('profile-email').textContent = planDetails.email || 'â€”';
Â  Â  Â  Â  Â  Â  document.getElementById('profile-mobile').textContent = planDetails.mobile || 'â€”';
Â  Â  Â  Â  Â  Â  document.getElementById('profile-bulk-code').textContent = planDetails.bulkAccessCode || 'N/A';
Â  Â  Â  Â  Â  Â  document.getElementById('plan-name').textContent = (planDetails.planName || 'Not Set').split('_')[0];
Â  Â  Â  Â  Â  Â  document.getElementById('validity-end').textContent = planDetails.validityEnd ? new Date(planDetails.validityEnd).toLocaleDateString() : 'N/A';
Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('account-status');
Â  Â  Â  Â  Â  Â  const isActive = (typeof planDetails.isActive === 'undefined') ? true : planDetails.isActive;Â 
Â  Â  Â  Â  Â  Â  statusEl.textContent = isActive ?
'Enabled' : 'Disabled';
Â  Â  Â  Â  Â  Â  statusEl.className = `plan-status-badge ${isActive ? 'status-enabled' : 'status-disabled'}`;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- CHECK PLAN VALIDITY (PUBLIC) ---
Â  Â  Â  Â  function checkPlanValidity() {
Â  Â  Â  Â  Â  Â  const token = localStorage.getItem('clientToken');
Â  Â  Â  Â  Â  Â  const planDetailsString = localStorage.getItem('planDetails');

Â  Â  Â  Â  Â  Â  if (!token) {
Â  Â  Â  Â  Â  Â  Â  Â  showAccessDenied("Please log in to access Bulk Address Verification.");
Â  Â  Â  Â  Â  Â  Â  Â  isPlanValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const validityEnd = planDetails.validityEnd ?
new Date(planDetails.validityEnd) : null;
Â  Â  Â  Â  Â  Â  Â  Â  const now = new Date();

Â  Â  Â  Â  Â  Â  Â  Â  if (planDetails.isActive === false) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAccessDenied("Your account has been **disabled** by the administrator. Please contact support.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPlanValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (validityEnd && validityEnd < now) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAccessDenied(`Your bulk plan expired on **${validityEnd.toLocaleDateString()}**. Please contact support to renew.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isPlanValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // OK
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('bulkContent').classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  const progressContainer = document.querySelector('#bulk-verification .progress-container');
Â  Â  Â  Â  Â  Â  Â  Â  if (progressContainer) progressContainer.classList.remove('hidden');Â 
Â  Â  Â  Â  Â  Â  Â  Â  isPlanValid = true;
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error parsing plan details:", e);
Â  Â  Â  Â  Â  Â  Â  Â  showAccessDenied("Client authentication data is corrupted. Please log in again.");
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { localStorage.clear(); window.location.href = LOGIN_PAGE; }, 1500);
Â  Â  Â  Â  Â  Â  Â  Â  isPlanValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- SHOW ACCESS DENIED (PUBLIC) ---
Â  Â  Â  Â  function showAccessDenied(message) {
Â  Â  Â  Â  Â  Â  const bulkContent = document.getElementById('bulkContent');
Â  Â  Â  Â  Â  Â  const progressContainer = document.querySelector('#bulk-verification .progress-container');
Â  Â  Â  Â  Â  Â  if (bulkContent) bulkContent.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if (progressContainer) progressContainer.classList.add('hidden');

Â  Â  Â  Â  Â  Â  const existing = document.querySelector('#bulk-verification .access-denied-block');
Â  Â  Â  Â  Â  Â  if (existing) return;
Â  Â  Â  Â  Â  Â  const errorBlock = document.createElement('div');
Â  Â  Â  Â  Â  Â  errorBlock.className = 'access-denied-block space-y-6 mt-6';
Â  Â  Â  Â  Â  Â  errorBlock.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-red-50 p-8 rounded-xl border-l-4 border-alert-dark shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold text-xl text-alert-dark mb-3 flex items-center">ðŸ›‘ Access Denied</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-base text-gray-700 mb-6">${message.replace(/\*\*/g, '<strong>')}</p>
Â  Â  Â  Â  Â  Â  Â  Â 
Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="tel:+919193246219" class="block w-full py-3 bg-tf-secondary text-white text-center font-bold rounded-lg hover:bg-[#86259d] transition">Call Support / Renew Plan</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://wa.me/919193246219" target="_blank" class="block w-full py-3 bg-whatsapp-green text-white text-center font-bold rounded-lg hover:bg-green-600">ðŸŸ¢ WhatsApp Support</a>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  document.getElementById('bulk-verification').appendChild(errorBlock);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- PASSWORD MODAL LOGIC (PUBLIC) ---
Â  Â  Â  Â  function openPasswordModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('password-modal').style.display = 'flex';
Â  Â  Â  Â  Â  Â  document.getElementById('password-update-form').reset();
Â  Â  Â  Â  Â  Â  document.getElementById('password-update-status').textContent = '';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closePasswordModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('password-modal').style.display = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- FORCE-LOGOUT UI / helpers (PUBLIC) ---
Â  Â  Â  Â  function openForceModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('force-logout-modal').style.display = 'flex';
Â  Â  Â  Â  }
Â  Â  Â  Â  function closeForceModal() {
Â  Â  Â  Â  Â  Â  document.getElementById('force-logout-modal').style.display = 'none';
Â  Â  Â  Â  }

Â  Â  Â  Â  function getTokenPayload() {
Â  Â  Â  Â  Â  Â  const token = localStorage.getItem('clientToken');
Â  Â  Â  Â  Â  Â  if (!token) return null;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const payload = JSON.parse(atob(token.split('.')[1]));
Â  Â  Â  Â  Â  Â  Â  Â  return payload;
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function forceLogoutOtherDevice() {
Â  Â  Â  Â  Â  Â  const payload = getTokenPayload();
Â  Â  Â  Â  Â  Â  const clientId = payload && payload.clientId ? payload.clientId : (planDetails.id || planDetails.clientId);
Â  Â  Â  Â  Â  Â  if (!clientId) {
Â  Â  Â  Â  Â  Â  Â  Â  alert('Cannot determine clientId. Please log in again.');
Â  Â  Â  Â  Â  Â  Â  Â  closeForceModal();
Â  Â  Â  Â  Â  Â  Â  Â  localStorage.clear();
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const resp = await fetch(`${API_CLIENT}?action=force-logout`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â body: JSON.stringify({ clientId })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const json = await resp.json().catch(()=>null);
Â  Â  Â  Â  Â  Â  Â  Â  if (resp.ok && json && json.status === 'Success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeForceModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.removeItem('clientToken');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Other device logged out. Please log in again here.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = LOGIN_PAGE;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn('force-logout failed', resp.status, json);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Could not force logout other device. Contact support.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeForceModal();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('force-logout error', e);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Network error. Try again or contact support.');
Â  Â  Â  Â  Â  Â  Â  Â  closeForceModal();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- INBOX FUNCTIONS (PUBLIC) ---
Â  Â  Â  Â  async function loadInboxCounts() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await authFetch(`${API_BASE}/inbox/message`);
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (result.status === "Success" && result.unreadCount > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const badge = document.getElementById('inbox-badge');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  badge.textContent = result.unreadCount;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  badge.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('inbox-badge').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to load client inbox counts:", e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadClientInbox() {
Â  Â  Â  Â  Â  Â  const msgContainer = document.getElementById('client-inbox-list');
Â  Â  Â  Â  Â  Â  const detailView = document.getElementById('full-message-detail');
Â  Â  Â  Â  Â  Â  msgContainer.innerHTML = '<p class="text-center text-gray-500 mt-5">Loading messages...</p>';
Â  Â  Â  Â  Â  Â  detailView.style.display = 'none';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await authFetch(`${API_BASE}/inbox/message`);
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  if (result.status === "Success") {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msgContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!result.messages || result.messages.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msgContainer.innerHTML = '<p class="text-center text-gray-500 mt-5">No messages in your inbox.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  result.messages.forEach(msg => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isUnread = !msg.isRead && msg.senderId === 'admin';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cardClass = isUnread ? 'unread' : '';
Â  Â Â 
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â const icon = isUnread ? 'fa-envelope' : 'fa-envelope-open';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const sender = msg.senderId === 'admin' ? 'Admin' : 'You';
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // FIX: Use encodeURIComponent for robust passing of complex strings
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const subjectEncoded = encodeURIComponent(msg.subject || '(No Subject)');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bodyEncoded = encodeURIComponent(msg.body || '');Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const messageHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â Â 
Â  Â  Â  Â <div id="msg-${msg._id}" class="msg-card ${cardClass}" onclick="viewClientMessage('${msg._id}', '${subjectEncoded}', '${bodyEncoded}', ${isUnread}, '${msg.timestamp}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas ${icon} msg-icon"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="text-md truncate">${msg.subject ||
'(No Subject)'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <small class="text-gray-500 block">From: ${sender} â€¢ ${new Date(msg.timestamp).toLocaleDateString()}</small>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msgContainer.insertAdjacentHTML('beforeend', messageHtml);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  msgContainer.innerHTML = `<p class="text-center text-red-500 mt-5">Failed to load inbox: ${result.message}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  msgContainer.innerHTML = `<p class="text-center text-red-500 mt-5">Network Error: ${error.message}</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function toggleInbox() {
Â  Â  Â  Â  Â  Â  document.getElementById('inbox-modal').style.display = 'flex';
Â  Â  Â  Â  Â  Â  loadClientInbox();
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeInbox() {
Â  Â  Â  Â  Â  Â  document.getElementById('inbox-modal').style.display = 'none';
Â  Â  Â  Â  Â  Â  loadInboxCounts();
Â  Â  Â  Â  }

Â  Â  Â  Â  function viewClientMessage(messageId, subjectEncoded, bodyEncoded, isUnread, timestamp) {
Â  Â  Â  Â  Â  Â  // FIX: Decode the strings back before assigning to textContent/innerText
Â  Â  Â  Â  Â  Â  const subject = decodeURIComponent(subjectEncoded);
Â  Â  Â  Â  Â  Â  const body = decodeURIComponent(bodyEncoded);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const detailView = document.getElementById('full-message-detail');
Â  Â  Â  Â  Â  Â  document.getElementById('full-message-subject').textContent = subject;
Â  Â  Â  Â  Â  Â  document.getElementById('full-message-body').innerText = body;
Â  Â  Â  Â  Â  Â  document.getElementById('full-message-date').textContent = new Date(timestamp).toLocaleString();
Â  Â  Â  Â  Â  Â  detailView.style.display = 'block';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isUnread) {
Â  Â  Â  Â  Â  Â  Â  Â  authFetch(`${API_BASE}/inbox/message?messageId=${messageId}`, { method: 'PUT' }).catch(()=>{});
Â  Â  Â  Â  Â  Â  Â  Â  const card = document.getElementById(`msg-${messageId}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (card) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.classList.remove('unread');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const iconEl = card.querySelector('.msg-icon');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (iconEl) iconEl.classList.replace('fa-envelope', 'fa-envelope-open');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(loadInboxCounts, 500);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- TAB NAVIGATION (UPDATED and PUBLIC) ---
Â  Â  Â  Â  function showTab(tabId, button) {
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
Â  Â  Â  Â  Â  Â  document.getElementById(tabId).style.display = 'block';
Â  Â  Â  Â  Â  Â  if (button) button.classList.add('active');

Â  Â  Â  Â  Â  Â  // Stop polling when leaving job tabs (NEW)
Â  Â  Â  Â  Â  Â  if (activeJobPollInterval) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(activeJobPollInterval);
Â  Â  Â  Â  Â  Â  Â  Â  activeJobPollInterval = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (tabId === 'bulk-verification') {
Â  Â  Â  Â  Â  Â  Â  Â  checkPlanValidity();
Â  Â  Â  Â  Â  Â  Â  Â  // FIX 1: Call function exposed by bulk_verification_logic.js to load KPI data
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof fetchTodayCompletedKpi === 'function') fetchTodayCompletedKpi();
Â  Â  Â  Â  Â  Â  } else if (tabId === 'profile-plan') {
Â  Â  Â  Â  Â  Â  Â  Â  fetchProfileData();
Â  Â  Â  Â  Â  Â  Â  Â  // Ensure fresh data on tab click
Â  Â  Â  Â  Â  Â  } else if (tabId === 'in-progress-jobs' || tabId === 'completed-jobs') {
Â  Â  Â  Â  Â  Â  Â  Â  // Requirements 2, 3, 5: Start polling for status when entering job tabs (NEW)
Â  Â  Â  Â  Â  Â  Â  Â  startJobPolling();
Â  Â  Â  Â  Â  Â  } else if (tabId === 'deduction-history') {
Â  Â  Â  Â  Â  Â  Â  Â  // FIX 2: Call function exposed by bulk_verification_logic.js to load deduction history
Â  Â  Â  Â  Â  Â  Â  Â  // IMPORTANT: Pass page 1 to start the paginated history.
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof fetchDeductionHistory === 'function') fetchDeductionHistory(1);
            } else if (tabId === 'single-verification') {
                 // Clear any previous results when switching to the single lookup tab
                 document.getElementById('single-result-container').style.display = 'none';
                 // Re-fetch profile data to get fresh credit count
                 fetchProfileData(); 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- JOB POLLING LOGIC (PUBLIC) ---
Â  Â  Â  Â  // Enterprise Improvement: Filter search is integrated here
Â  Â  Â  Â  function startJobPolling() {
Â  Â  Â  Â  Â  Â  if (activeJobPollInterval) clearInterval(activeJobPollInterval);
Â  Â  Â  Â  Â  Â  fetchAndUpdateJobStatus(); // Initial fetch
Â  Â  Â  Â  Â  Â  activeJobPollInterval = setInterval(fetchAndUpdateJobStatus, 5000);
Â  Â  Â  Â  Â  Â  // Poll every 5 seconds
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Add listeners for filtering (NEW)
Â  Â  Â  Â  Â  Â  document.getElementById('in-progress-search')?.addEventListener('input', filterJobsList);
Â  Â  Â  Â  Â  Â  document.getElementById('completed-search')?.addEventListener('input', filterJobsList);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Enterprise Improvement: Job Filtering Logic ---
Â  Â  Â  Â  function filterJobsList() {
Â  Â  Â  Â  Â  Â  const activeSearchTerm = document.getElementById('in-progress-search')?.value.toLowerCase() ||
'';
Â  Â  Â  Â  Â  Â  const completedSearchTerm = document.getElementById('completed-search')?.value.toLowerCase() || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Render In Progress list (filtered)
Â  Â  Â  Â  Â  Â  renderJobsList(globalJobsData.inProgress, 'in-progress-list', activeSearchTerm);
Â  Â  Â  Â  Â  Â  // Render Completed list (filtered)
Â  Â  Â  Â  Â  Â  renderJobsList(globalJobsData.completed, 'completed-list', completedSearchTerm);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Reusable function to render job lists (NEW)
Â  Â  Â  Â  function renderJobsList(jobs, containerId, searchTerm) {
Â  Â  Â  Â  Â  Â  const container = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  let filteredJobs = jobs;

Â  Â  Â  Â  Â  Â  if (searchTerm) {
Â  Â  Â  Â  Â  Â  Â  Â  filteredJobs = jobs.filter(job =>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  job.filename.toLowerCase().includes(searchTerm) ||Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  job._id.toLowerCase().includes(searchTerm)
Â  Â  Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let html = '';
Â  Â  Â  Â  Â  Â  let activeCount = 0; // Only count active jobs for the active job counter

Â  Â  Â  Â  Â  Â  for (const job of filteredJobs) {
Â  Â  Â  Â  Â  Â  Â  Â  const progress = job.totalRows > 0 ?
((job.processedCount / job.totalRows) * 100).toFixed(0) : 0;
Â  Â  Â  Â  Â  Â  Â  Â  const isFailed = job.status === 'Failed';
Â  Â  Â  Â  Â  Â  Â  Â  const isCompleted = job.status === 'Completed';
Â  Â  Â  Â  Â  Â  Â  Â  // Show only 10 completed jobs unless filtering is active
Â  Â  Â  Â  Â  Â  Â  Â  if (containerId === 'completed-list' && !searchTerm && html.split('job-card').length > 10) continue;
Â  Â  Â  Â  Â  Â  Â  Â  const completionDisplay = isCompleted ? formatISTTime(job.completedTime) : new Date(job.submittedAt).toLocaleDateString();

Â  Â  Â  Â  Â  Â  Â  Â  if (job.status === 'In Progress' || job.status === 'Queued') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeCount++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Count only for active list
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cardHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="job-card bg-white p-4 rounded-lg shadow-md border-l-4 ${isCompleted ? 'border-green-500' : isFailed || job.status === 'Cancelled' ? 'border-red-500' : 'border-tf-secondary'}">
Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex justify-between items-start mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-lg text-gray-800 truncate">${job.filename}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-semibold text-gray-600">${completionDisplay}</span>
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-600 mb-2 space-y-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p><strong>Status:</strong> <span class="font-bold text-${isCompleted ? 'green' : isFailed || job.status === 'Cancelled' ? 'red' : 'tf-secondary'}-600">${job.status}</span></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â ${job.status !== 'Cancelled' && job.status !== 'Failed' ?
`<p><strong>Rows:</strong> ${job.processedCount} / ${job.totalRows}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${job.status === 'In Progress' ?
`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar w-full bg-gray-300 rounded-full h-2 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-fill h-2 bg-tf-secondary rounded-full" style="width: ${progress}%;"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  ` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-3 flex gap-2 justify-end">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${job.status === 'In Progress' ||
job.status === 'Queued' ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="py-1 px-3 bg-red-500 text-white text-sm rounded hover:bg-red-600" onclick="handleCancelJob('${job._id}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-times"></i> Cancel
Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â </button>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : isCompleted ?
`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-gray-500 mr-2">Ready: ${job.countReady} |
Manual: ${job.countManual}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="py-1 px-3 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition" onclick="handleAuthenticatedDownload('${job._id}', '${job.filename.replace(/'/g, "\\'").replace(/"/g, '')}', 'ready')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-file-download"></i> Ready for Ship (${job.countReady})
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="py-1 px-3 bg-orange-500 text-white text-sm rounded hover:bg-orange-600 transition" onclick="handleAuthenticatedDownload('${job._id}', '${job.filename.replace(/'/g, "\\'").replace(/"/g, '')}', 'manual')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  <i class="fas fa-clipboard-list"></i> Manual Check Needed (${job.countManual})
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : isFailed ?
`<span class="text-red-500 text-sm italic">${job.error || 'Check server logs.'}</span>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : job.status === 'Cancelled' ?
`<span class="text-red-500 text-sm italic">Cancelled by user.</span>`
Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  html += cardHtml;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  container.innerHTML = html ||
`<p class="text-gray-500 text-center mt-5">No jobs found matching the filter.</p>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Only update the active job counter if we are rendering the in-progress list without filtering.
Â  Â  Â  Â  Â  Â  if (containerId === 'in-progress-list' && !document.getElementById('in-progress-search')?.value) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('active-job-count').textContent = activeCount;
Â  Â  Â  Â  Â  Â  Â  Â  // Update bulk button state based on actual total active jobs (NEW)
Â  Â  Â  Â  Â  Â  Â  Â  const processBtn = document.getElementById('processButton');
Â  Â  Â  Â  Â  Â  Â  Â  const bulkTabBtn = document.getElementById('bulk-tab-btn');
Â  Â  Â  Â  Â  Â  Â  Â  const csvFileInput = document.getElementById('csvFileInput');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (activeCount >= 1) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (processBtn) processBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bulkTabBtn) bulkTabBtn.style.borderBottom = '2px solid #EF4444';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // We are NOT showing the old message block, we rely on the modal/notification
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // document.getElementById('max-jobs-message').style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (processBtn && csvFileInput) processBtn.disabled = !csvFileInput.files.length;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (bulkTabBtn) bulkTabBtn.style.borderBottom = '2px solid #5F3DC4';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // document.getElementById('max-jobs-message').style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Update refresh timestamp (NEW)
Â  Â  Â  Â  Â  Â  document.getElementById(containerId.replace('-list', '-status-timestamp')).textContent = `Last refreshed: ${new Date().toLocaleTimeString()}`;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  async function fetchAndUpdateJobStatus() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const resp = await authFetch(API_BULK_JOBS, { method: 'GET' });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await resp.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (result.status !== 'Success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Failed to fetch job status:', result.message);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Sort by submitted time descending
Â  Â  Â  Â  Â  Â  Â  Â  result.jobs.sort((a, b) => new Date(b.submittedAt) - new Date(a.submittedAt));
Â  Â  Â  Â  Â  Â  Â  Â  globalJobsData.inProgress = result.jobs.filter(j => j.status === 'Queued' || j.status === 'In Progress');
Â  Â  Â  Â  Â  Â  Â  Â  globalJobsData.completed = result.jobs.filter(j => j.status === 'Completed' || j.status === 'Failed' || j.status === 'Cancelled');
Â  Â  Â  Â  Â  Â  Â  Â  // Re-render based on current filter state
Â  Â  Â  Â  Â  Â  Â  Â  filterJobsList();
Â  Â  Â  Â  Â  Â  Â  Â  // Update remaining credits UI (post-completion check)
Â  Â  Â  Â  Â  Â  Â  Â  const afterCreditsResp = await getRemainingCredits();
Â  Â  Â  Â  Â  Â  Â  Â  if (afterCreditsResp.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rc = afterCreditsResp.remainingCredits;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const remEl = document.getElementById('plan-remaining-credits');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (remEl) remEl.textContent = rc === 'Unlimited' ? 'Unlimited' : Number(rc).toLocaleString();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL FIX: Ensure KPI is updated after polling is complete
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof loadKpiData === 'function') loadKpiData();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Job polling failed:', e);
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('in-progress-list').innerHTML = '<p class="text-red-500 text-center mt-5">Failed to load status. Network error.</p>';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Enterprise Improvement: KPI Data Logic (UPDATED WITH LOGIC FIX) ---
Â  Â  Â  Â  // FIX 1: This function is used by the poller to update the Today's Completed KPI
Â  Â  Â  Â  async function loadKpiData() {
Â  Â  Â  Â  Â  Â  // Get today's completed rows from the global job data
Â  Â  Â  Â  Â  Â  constÂ 
today = new Date();
Â  Â  Â  Â  Â  Â  today.setHours(0, 0, 0, 0);

Â  Â  Â  Â  Â  Â  let completedToday = 0;
Â  Â  Â  Â  Â  Â  // Check if globalJobsData has been populated by the poller
Â  Â  Â  Â  Â  Â  if (globalJobsData.completed) {
Â  Â  Â  Â  Â  Â  Â  Â  globalJobsData.completed.forEach(job => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL FIX: Only check jobs that are marked 'Completed' and have a timestamp.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const completedTime = job.completedTime;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (job.status === 'Completed' && completedTime) {
Â  Â Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const completedDate = new Date(completedTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (completedDate >= today) { // Check if time is >= midnight today
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  completedToday += job.totalRows;
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('today-completed-kpi').textContent = completedToday.toLocaleString();
Â  Â  Â  Â  }
        
        // --- SINGLE ADDRESS VERIFICATION FUNCTION (NEW) ---
        async function handleSingleVerification() {
            const addressInput = document.getElementById('single-address-input');
            const nameInput = document.getElementById('single-name-input');
            const resultContainer = document.getElementById('single-result-container');
            const statusMessage = document.getElementById('single-result-status');
            const verifyBtn = document.getElementById('singleVerifyBtn');

            if (!addressInput.value.trim()) {
                statusMessage.textContent = 'Please enter an address to verify.';
                statusMessage.classList.add('text-red-600');
                resultContainer.style.display = 'block';
                return;
            }

            // Disable button and reset display
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Verifying...';
            resultContainer.style.display = 'none';
            statusMessage.className = 'font-semibold text-sm mb-3 text-gray-600';
            statusMessage.textContent = 'Awaiting response...';

            const payload = {
                address: addressInput.value.trim(),
                customerName: nameInput.value.trim()
            };

            try {
                const resp = await authFetch(API_ENDPOINT, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();
                
                // Refresh credits UI (regardless of success/failure)
                const afterCreditsResp = await getRemainingCredits();
                if (afterCreditsResp.ok) {
                    const rc = afterCreditsResp.remainingCredits;
                    document.getElementById('plan-remaining-credits').textContent = rc === 'Unlimited' ? 'Unlimited' : Number(rc).toLocaleString();
                }

                if (result.status === 'Success') {
                    const qualityClass = result.addressQuality === 'Very Good' || result.addressQuality === 'Good' ? 'text-green-600' : 
                                         result.addressQuality === 'Medium' ? 'text-orange-500' : 'text-red-600';
                    const qualityColor = result.addressQuality === 'Very Good' || result.addressQuality === 'Good' ? 'text-green-600' : 
                                         result.addressQuality === 'Medium' ? 'text-orange-500' : 'text-red-600';


                    statusMessage.textContent = `Verification Successful! Quality: ${result.addressQuality}. Location Suitability: ${result.locationSuitability}.`;
                    statusMessage.className = `font-bold text-base mb-3 ${qualityClass}`;
                    
                    // Populate Results
                    document.getElementById('clean-address-line1').textContent = result.addressLine1 || 'N/A';
                    document.getElementById('clean-address-line2').textContent = result.landmark || result.postOffice || 'â€”';
                    document.getElementById('clean-pin').textContent = result.pin || 'N/A';
                    document.getElementById('clean-district').textContent = result.district || 'N/A';
                    document.getElementById('clean-state').textContent = result.state || 'N/A';
                    document.getElementById('clean-quality').textContent = result.addressQuality || 'Unknown';
                    document.getElementById('clean-quality').className = qualityColor; // Apply color to quality text

                    // Display remarks, handling the CRITICAL_ALERT prefix by just showing the message
                    document.getElementById('single-remarks').textContent = `Remarks: ${result.remarks.replace(/CRITICAL_ALERT: /g, 'Warning: ')}`;

                } else {
                    statusMessage.textContent = `Verification Failed: ${result.error || result.message || 'Unknown Server Error'}`;
                    statusMessage.classList.add('text-red-600');
                    
                    // Fallback display
                    document.getElementById('clean-address-line1').textContent = payload.address;
                    document.getElementById('clean-address-line2').textContent = 'â€”';
                    document.getElementById('clean-pin').textContent = 'N/A';
                    document.getElementById('clean-district').textContent = 'N/A';
                    document.getElementById('clean-state').textContent = 'N/A';
                    document.getElementById('clean-quality').textContent = 'Very Bad';
                    document.getElementById('clean-quality').classList.add('text-red-600');
                    document.getElementById('single-remarks').textContent = `Error: ${result.error || result.message || 'Could not process address.'}`;
                }
            } catch (error) {
                statusMessage.textContent = `Network Error: ${error.message}`;
                statusMessage.classList.add('text-red-600');
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-magic mr-2"></i> Verify Address';
                resultContainer.style.display = 'block';
            }
        }
        // Expose the function globally
        window.handleSingleVerification = handleSingleVerification;
Â  Â  Â  Â  // --- AUTHENTICATED DOWNLOAD FUNCTION ---
Â  Â  Â  Â  async function handleAuthenticatedDownload(jobId, jobFilename, fileType) {
Â  Â  Â  Â  Â  Â  const suffix = (fileType === 'ready' ? '_READY_FOR_SHIPMENT' : '_MANUAL_CHECK_NEEDED');
Â  Â  Â  Â  Â  Â  const safeFilename = `${jobFilename.replace('.csv', '').replace(/'/g, '').replace(/"/g, '')}${suffix}.csv`;
Â  Â  Â  Â  Â  Â  // FIX: Pass the fileType parameter to the API
Â  Â  Â  Â  Â  Â  const downloadUrl = `${API_BULK_JOBS}?action=download&jobId=${jobId}&type=${fileType}`;Â 

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const resp = await authFetch(downloadUrl, { method: 'GET' });

Â  Â Â 
Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  const contentType = (resp.headers.get && resp.headers.get('content-type') || '').toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  if (contentType.includes('application/json')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let json = null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try { json = await resp.json();Â 
} catch (e) { /* ignore parse error */ }
Â  Â Â 
Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const msg = (json && (json.message || json.error)) ? (json.message || json.error) : 'Server returned JSON instead of CSV.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Download failed: ' + msg);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
}

Â  Â  Â  Â  Â  Â  Â  Â  ifÂ 
(!resp.ok) {
Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorText = await resp.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorJson = JSON.parse(errorText);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Download failed: ' + (errorJson.message || errorJson.error || 'File unavailable.'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('Download failed. Please try again later.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
}

Â  Â  Â  Â  Â  Â  Â  Â  const blob = await resp.blob();
Â  Â  Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  a.style.display = 'none';
Â  Â  Â  Â  Â  Â  Â  Â  a.href = window.URL.createObjectURL(blob);
Â  Â  Â  Â  Â  Â  Â  Â  a.download = safeFilename;Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.body.appendChild(a);
Â  Â  Â  Â  Â  Â  Â  Â  a.click();
Â  Â  Â  Â  Â  Â  Â  Â  window.URL.revokeObjectURL(a.href);
Â  Â  Â  Â  Â  Â  Â  Â  a.remove();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Authenticated Download Failed:", e);
Â  Â  Â  Â  Â  Â  Â  Â  alert('Download failed due to a network or authentication error.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Make core functions available globally for HTML onclick events
Â  Â  Â  Â  window.showTab = showTab;
Â  Â  Â  Â  window.logout = logout;Â 
Â  Â  Â  Â  window.openPasswordModal = openPasswordModal;
Â  Â  Â  Â  window.closePasswordModal = closePasswordModal;
Â  Â  Â  Â  window.closeForceModal = closeForceModal;
Â  Â  Â  Â  window.forceLogoutOtherDevice = forceLogoutOtherDevice;
Â  Â  Â  Â  window.toggleInbox = toggleInbox;
Â  Â  Â  Â  window.closeInbox = closeInbox;
Â  Â  Â  Â  window.viewClientMessage = viewClientMessage;
Â  Â  Â  Â  window.handleAuthenticatedDownload = handleAuthenticatedDownload;
Â  Â  Â  Â  window.filterJobsList = filterJobsList;
Â  Â  Â  Â  // Expose filter function (NEW)
Â  Â  Â  Â  window.loadKpiData = loadKpiData;
Â  Â  Â  Â  // Expose KPI function (FIX 1)
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- PASSWORD UPDATE LISTENER (PUBLIC) ---
Â  Â  Â  Â  document.getElementById('password-update-form').addEventListener('submit', async (e) => {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  const newPassword = document.getElementById('new-password').value;
Â  Â  Â  Â  Â  Â  const confirmPassword = document.getElementById('confirm-password').value;
Â  Â  Â  Â  Â  Â  const statusEl = document.getElementById('password-update-status');
Â  Â Â 
Â  Â  Â  Â  Â  Â  constÂ 
Â  Â  Â  Â  Â  Â  updateBtn = document.getElementById('updatePasswordBtn');

Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (newPassword !== confirmPassword) {
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'Passwords do not match.';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.className = 'text-red-600 mt-3';
Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (newPassword.lengthÂ 
< 6) {
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'Password must be at least 6 characters.';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.className = 'text-red-600 mt-3';
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  updateBtn.disabled = true;
Â  Â  Â  Â  Â  Â  updateBtn.textContent = 'Processing...';
Â  Â  Â  Â  Â  Â  statusEl.textContent = 'Sending request to server...';
Â  Â  Â  Â  Â  Â  statusEl.className = 'text-tf-primary mt-3';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const resp = await authFetch(`${API_CLIENT}?action=update-password`, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'PUT',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ newPassword })
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await resp.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (resp.ok && result.status === 'Success') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // CRITICAL FIX: Ensure string is on one line to prevent Unterminated string literal error
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'Password changed successfully! Redirecting to login...';Â 

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.className = 'text-green-600 mt-3';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(logout, 1500);Â 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = result.message ||
'Update failed.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  statusEl.className = 'text-red-600 mt-3';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.textContent = 'Network error or session expired.';
Â  Â  Â  Â  Â  Â  Â  Â  statusEl.className = 'text-red-600 mt-3';
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Password Update Error:', error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  updateBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  updateBtn.textContent = 'Update & Log Out';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  window.onload = () => {
Â  Â  Â  Â  Â  Â  // Try to fetch profile and then init bulk listeners (external)
Â  Â  Â  Â  Â  Â  fetchProfileData().then(()=> {
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof initBulkListeners === 'function') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initBulkListeners();
Â  Â  Â  Â  Â 
Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Bulk listeners function not found. Make sure bulk_verification_logic.js is loaded.");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }).catch((e)=> {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error during profile init:', e);
Â  Â  Â  Â  Â  Â  Â 
Â  Â if (typeof initBulkListeners === 'function') initBulkListeners();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  loadInboxCounts();

Â  Â  Â  Â  Â  Â  setInterval(sendHeartbeat, 60000);
Â  Â  Â  Â  Â  Â  setInterval(loadInboxCounts, 60000);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Start in bulk tab
Â  Â  Â  Â  Â  Â  showTab('bulk-verification', document.getElementById('bulk-tab-btn'));
Â  Â  Â  Â  Â  Â  /* --- SMALL SAFE FALLBACK (non-invasive) ---
Â  Â  Â  Â  Â  Â  If the external bulk_verification_logic.js did not attach listeners
Â  Â  Â  Â  Â  Â  (missing or errored), make sure the process button enables when a file
Â  Â  Â  Â  Â  Â  is selected and disables otherwise.
Â  Â  Â  Â  Â  Â  This does NOT change logic.
Â  Â  Â  Â  Â  Â  */
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  ensureProcessButtonFallback();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.warn('Fallback init failed', e);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- Time Formatting Helper (NEW) ---
Â  Â  Â  Â  function formatISTTime(utcTimestamp) {
Â  Â  Â  Â  Â  Â  if (!utcTimestamp) return 'N/A';
Â  Â  Â  Â  Â  Â  const date = new Date(utcTimestamp);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const options = {
Â  Â  Â  Â  Â  Â  Â  Â  year: 'numeric',
Â  Â  Â  Â  Â  Â  Â  Â  month: 'short',
Â  Â  Â  Â  Â  Â  Â  Â  day: '2-digit',
Â  Â  Â  Â  Â  Â  Â  Â  hour: '2-digit',
Â  Â  Â  Â  Â  Â  Â  Â  minute: '2-digit',
Â  Â  Â  Â 
Â  Â  Â  Â  Â hour12: true,
Â  Â  Â  Â  Â  Â  Â  Â  timeZone: 'Asia/Kolkata'
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  return date.toLocaleDateString('en-IN', options);
Â  Â  Â  Â  }

Â  Â  Â  Â  // placeholder for getRemainingCredits used in polling (assumes it's defined elsewhere)
Â  Â  Â  Â  async function getRemainingCredits() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const resp = await authFetch(`${API_CLIENT}?action=remaining-credits`);
Â  Â  Â  Â  Â  Â  Â  Â  const json = await resp.json().catch(()=>null);
Â  Â  Â  Â  Â  Â  Â  Â  return json || { ok: false };
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  return { ok: false };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /* -------------------------
Â  Â  Â  Â  Â  Â  Fallback helper (tiny)
Â  Â  Â  Â  Â  Â  Enables/disables Start Verification button based on:
Â  Â  Â  Â  Â  Â  - a) whether a file is selected
Â  Â  Â  Â  Â  Â  - b) whether there is currently an active job (uses active job count element)
Â  Â  Â  Â  Â 
Â  Â This is safe â€” it only manipulates the button UI state and does not change any process logic.
------------------------- */
Â  Â  Â  Â  function ensureProcessButtonFallback() {
Â  Â  Â  Â  Â  Â  const fileInput = document.getElementById('csvFileInput');
Â  Â  Â  Â  Â  Â  const processBtn = document.getElementById('processButton');
Â  Â  Â  Â  Â  Â  const activeJobCountEl = document.getElementById('active-job-count');
Â  Â  Â  Â  Â  Â  const MAX_ACTIVE = 1;
Â  Â  Â  Â  Â  Â  // consistency with your logic

Â  Â  Â  Â  Â  Â  if (!fileInput || !processBtn) return;
Â  Â  Â  Â  Â  Â  function updateButtonState() {
Â  Â  Â  Â  Â  Â  Â  Â  // read active job count (fallback to 0)
Â  Â  Â  Â  Â  Â  Â  Â  const active = Number(activeJobCountEl?.textContent || 0);
Â  Â  Â  Â  Â  Â  Â  Â  // enable only if file selected AND no active jobs
Â  Â  Â  Â  Â  Â  Â  Â  const hasFile = fileInput.files && fileInput.files.length > 0;
Â  Â  Â  Â  Â  Â  Â  Â  processBtn.disabled = !(hasFile && active < MAX_ACTIVE);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // attach listener (safe, won't conflict if external script also uses this input)
Â  Â  Â  Â  Â  Â  fileInput.addEventListener('change', updateButtonState, { passive: true });
Â  Â  Â  Â  Â  Â  // also observe changes to active job count (in case polling updates it later)
Â  Â  Â  Â  Â  Â  const observerTarget = activeJobCountEl;
Â  Â  Â  Â  Â  Â  if (observerTarget) {
Â  Â  Â  Â  Â  Â  Â  Â  const mo = new MutationObserver(updateButtonState);
Â  Â  Â  Â  Â  Â  Â  Â  mo.observe(observerTarget, { childList: true, subtree: true, characterData: true });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // initial sync (in case file was preselected)
Â  Â  Â  Â  Â  Â  updateButtonState();
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>