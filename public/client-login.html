<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Login — AI VERIFY</title>

  <!-- Tailwind CDN (keeps markup simple) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* Small local polish to match your site's look */
    body {
      background: #F8FAFC;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card {
      max-width: 420px;
      width: 100%;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.08);
      padding: 28px;
      border-top: 6px solid #6366F1;
    }
    .btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      font-weight: 700;
    }
    .btn[disabled] { opacity: 0.7; cursor: not-allowed; }
  </style>
</head>

<body>
  <main class="card">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-11 h-11 rounded-md" style="background: linear-gradient(135deg,#6366F1,#06B6D4)"></div>
      <div>
        <h1 class="text-xl font-extrabold">Client Portal</h1>
        <p class="text-sm text-gray-500">Sign in to access address verification</p>
      </div>
    </div>

    <form id="loginForm" class="space-y-4" autocomplete="on" novalidate>
      <div>
        <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
        <input id="username" name="username" type="text" required
               class="mt-1 block w-full rounded-md border border-gray-200 shadow-sm p-3"
               autocomplete="username" />
      </div>

      <div>
        <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
        <input id="password" name="password" type="password" required
               class="mt-1 block w-full rounded-md border border-gray-200 shadow-sm p-3"
               autocomplete="current-password" />
      </div>

      <button type="submit" id="loginBtn" class="btn bg-cyan-500 text-white hover:bg-cyan-600">Secure Login</button>

      <p id="status" class="text-center text-sm mt-2 text-gray-600" aria-live="polite"></p>

      <div id="forceArea" class="mt-3 hidden" aria-hidden="true">
        <div class="bg-red-50 border border-red-100 p-3 rounded-md text-center">
          <p class="font-semibold text-red-700">User already logged in on another device.</p>
          <p class="text-xs text-gray-600 mt-1">If this is you, log the other device out and continue here.</p>
          <div class="mt-3">
            <button id="forceBtn" type="button" class="btn bg-red-600 text-white hover:bg-red-700">Logout other device &amp; login here</button>
          </div>
        </div>
      </div>

      <div class="mt-4 text-center">
        <a href="index.html" class="text-xs text-indigo-600 hover:underline">← Back to main site</a>
      </div>
    </form>
  </main>

  <script>
    // Endpoint — uses consolidated client router as in your code
    const API_LOGIN = '/api/client/index?action=login';
    const DASHBOARD = 'client-dashboard.html';

    const loginForm = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const statusEl = document.getElementById('status');
    const forceArea = document.getElementById('forceArea');
    const forceBtn = document.getElementById('forceBtn');

    let lastActionToken = null;
    let lastCredentials = null;

    function setStatus(msg = '', type = '') {
      // type: '' | 'error' | 'ok'
      statusEl.textContent = msg;
      statusEl.className = `text-center text-sm mt-2 ${
        type === 'error' ? 'text-red-600' : type === 'ok' ? 'text-cyan-600' : 'text-gray-600'
      }`;
    }

    function setButtonsDisabled(state) {
      loginBtn.disabled = state;
      if (state) loginBtn.classList.add('opacity-70', 'cursor-not-allowed');
      else loginBtn.classList.remove('opacity-70', 'cursor-not-allowed');
    }

    async function fetchJSON(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const text = await res.text();
      try {
        return { ok: res.ok, status: res.status, json: text ? JSON.parse(text) : null };
      } catch (e) {
        return { ok: res.ok, status: res.status, text };
      }
    }

    async function attemptLogin({ username, password, force = false, actionToken = null }) {
      setButtonsDisabled(true);
      setStatus('Authenticating...', 'ok');

      try {
        const payload = { username, password };
        if (force) payload.force = true;
        if (actionToken) payload.actionToken = actionToken;

        const r = await fetchJSON(API_LOGIN, payload);

        if (!r.ok && !r.json) {
          console.error('Non-JSON response', r.text);
          setStatus('Server error. Contact support.', 'error');
          setButtonsDisabled(false);
          return null;
        }

        const j = r.json;

        // If server reports already logged in
        if (r.ok && j && j.alreadyLoggedIn) {
          lastActionToken = j.actionToken || null;
          lastCredentials = { username, password };
          forceArea.classList.remove('hidden');
          forceArea.setAttribute('aria-hidden', 'false');
          setStatus('User already logged in on another device.', 'error');
          setButtonsDisabled(false);
          return j;
        }

        // Successful login
        if (r.ok && j && (j.status === 'Success' || j.status === 'OK')) {
          if (j.token) localStorage.setItem('clientToken', j.token);
          if (j.planDetails) localStorage.setItem('planDetails', JSON.stringify(j.planDetails));
          localStorage.setItem('clientName', (j.planDetails && j.planDetails.clientName) || username);
          setStatus('Login successful — redirecting...', 'ok');
          // short delay to show message then redirect
          setTimeout(() => window.location.href = DASHBOARD, 350);
          return j;
        }

        // Generic failure
        const msg = (j && (j.message || j.error)) || `Login failed (status ${r.status})`;
        setStatus(msg, 'error');
        setButtonsDisabled(false);
        return j;

      } catch (err) {
        console.error('Login error', err);
        setStatus('Network error. Check connection.', 'error');
        setButtonsDisabled(false);
        return null;
      }
    }

    // Form submit: normal login attempt
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      forceArea.classList.add('hidden');
      forceArea.setAttribute('aria-hidden', 'true');
      lastActionToken = null;
      lastCredentials = null;

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) { setStatus('Enter username and password.', 'error'); return; }

      await attemptLogin({ username, password });
    });

    // Force logout other device and complete login
    forceBtn.addEventListener('click', async () => {
      setStatus('Logging out other device and finishing login...', 'ok');
      if (!lastCredentials) { setStatus('Missing credentials. Enter them and try again.', 'error'); return; }

      if (lastActionToken) {
        await attemptLogin({ username: lastCredentials.username, password: lastCredentials.password, force: true, actionToken: lastActionToken });
        return;
      }

      await attemptLogin({ username: lastCredentials.username, password: lastCredentials.password, force: true });
    });

    // If already logged in, redirect to dashboard
    if (localStorage.getItem('clientToken')) {
      try { window.location.href = DASHBOARD; } catch (e) { /* ignore */ }
    }
  </script>
</body>
</html>
