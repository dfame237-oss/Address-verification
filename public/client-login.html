<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Minimal custom overrides for a clean card look */
    body { @apply bg-gray-50 font-sans antialiased; }
    .card { max-width:420px; margin:48px auto; background:white; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.08); padding:28px; border-top:6px solid #6366F1; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand h1 { font-weight:800; font-size:1.35rem; color:#0F172A; }
    .subtitle { color:#475569; }
    .btn { @apply w-full py-3 rounded-lg font-semibold; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <main class="card">
    <div class="brand mb-4">
      <div style="width:44px;height:44px;background:linear-gradient(135deg,#6366F1,#06B6D4);border-radius:8px;box-shadow:0 6px 18px rgba(99,102,241,0.12)"></div>
      <div>
        <h1>Client Portal</h1>
        <div class="subtitle text-sm">Sign in to access address verification</div>
      </div>
    </div>

    <form id="loginForm" class="space-y-4" autocomplete="on" novalidate>
      <div>
        <label class="block text-sm font-medium text-gray-700">Username</label>
        <input id="username" type="text" required class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-3" />
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Password</label>
        <input id="password" type="password" required class="mt-1 block w-full rounded-md border-gray-200 shadow-sm p-3" />
      </div>

      <button id="loginBtn" type="submit" class="btn bg-cyan-500 text-white hover:bg-cyan-600 transition">Secure Login</button>

      <p id="status" class="text-center text-sm mt-2"></p>

      <div id="forceArea" class="mt-3 hidden">
        <div class="bg-red-50 border border-red-100 p-3 rounded-md text-center">
          <p class="font-semibold text-red-700">User already logged in on another device.</p>
          <p class="text-xs text-gray-600 mt-1">If this is you, log the other device out and continue here.</p>
          <div class="mt-3">
            <button id="forceBtn" type="button" class="btn bg-red-600 text-white hover:bg-red-700">Logout other device & login here</button>
          </div>
        </div>
      </div>

      <div class="mt-4 text-center">
        <a href="index.html" class="text-xs text-indigo-600 hover:underline">← Back to main site</a>
      </div>
    </form>
  </main>

  <script>
    // CONFIG
    const API_LOGIN = '/api/client/login';
    const DASHBOARD = 'client-dashboard.html';

    // ELEMENTS
    const form = document.getElementById('loginForm');
    const loginBtn = document.getElementById('loginBtn');
    const statusEl = document.getElementById('status');
    const forceArea = document.getElementById('forceArea');
    const forceBtn = document.getElementById('forceBtn');

    // STATE
    let lastActionToken = null;
    let lastClientId = null;
    let lastCredentials = null;

    function showStatus(msg = '', type = '') {
      statusEl.textContent = msg;
      statusEl.className = `text-center text-sm mt-2 ${type === 'error' ? 'text-red-600' : type === 'ok' ? 'text-cyan-600' : 'text-gray-600'}`;
    }

    function setButtonsDisabled(state) {
      loginBtn.disabled = state;
      if (state) {
        loginBtn.classList.add('opacity-70', 'cursor-not-allowed');
      } else {
        loginBtn.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    }

    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      // get text then parse to handle non-json gracefully
      const text = await res.text();
      try { return { ok: res.ok, status: res.status, json: text ? JSON.parse(text) : null }; }
      catch (e) { return { ok: res.ok, status: res.status, text }; }
    }

    async function attemptLogin({ username, password, force = false, actionToken = null }) {
      setButtonsDisabled(true);
      showStatus('Authenticating...', 'ok');

      const payload = { username, password };
      if (force) payload.force = true;
      if (actionToken) payload.actionToken = actionToken;

      try {
        const r = await postJSON(API_LOGIN, payload);

        if (!r.ok && !r.json) {
          // non-json server error
          console.error('Server returned non-JSON:', r.text || r);
          showStatus('Server error. Please contact support.', 'error');
          setButtonsDisabled(false);
          return null;
        }

        const j = r.json;

        // 1) Already logged in response handling
        if (r.ok && j && j.alreadyLoggedIn) {
          // Save for future retry
          lastActionToken = j.actionToken || null;
          lastClientId = j.clientId || null;
          lastCredentials = { username, password };
          forceArea.classList.remove('hidden');
          showStatus('User already logged in on another device.', 'error');
          setButtonsDisabled(false);
          return j;
        }

        // 2) Successful login
        if (r.ok && j && (j.status === 'Success' || j.status === 'OK')) {
          // Save token & plan details locally
          if (j.token) localStorage.setItem('clientToken', j.token);
          if (j.planDetails) localStorage.setItem('planDetails', JSON.stringify(j.planDetails));
          localStorage.setItem('clientName', (j.planDetails && j.planDetails.clientName) || username);
          showStatus('Login successful — redirecting...', 'ok');
          setTimeout(() => { window.location.href = DASHBOARD; }, 450);
          return j;
        }

        // 3) Known error
        const msg = (j && (j.message || j.error)) || `Login failed (status ${r.status})`;
        showStatus(msg, 'error');
        setButtonsDisabled(false);
        return j;

      } catch (err) {
        console.error('Network/login error', err);
        showStatus('Network error. Check your connection.', 'error');
        setButtonsDisabled(false);
        return null;
      }
    }

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      forceArea.classList.add('hidden');
      lastActionToken = null;
      lastClientId = null;
      lastCredentials = null;

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      if (!username || !password) { showStatus('Please enter username and password.', 'error'); return; }

      await attemptLogin({ username, password });
    });

    forceBtn.addEventListener('click', async () => {
      showStatus('Logging out other device and finishing login...', 'ok');
      if (!lastCredentials) {
        showStatus('Missing credentials. Please enter username & password and try again.', 'error');
        return;
      }
      // Preferred: send the actionToken the server provided
      if (lastActionToken) {
        await attemptLogin({ username: lastCredentials.username, password: lastCredentials.password, force: true, actionToken: lastActionToken });
        return;
      }
      // Fallback: try force=true without actionToken (server may refuse), still safe
      await attemptLogin({ username: lastCredentials.username, password: lastCredentials.password, force: true });
    });

    // redirect if already logged in locally
    if (localStorage.getItem('clientToken')) {
      try { window.location.href = DASHBOARD; } catch (e) {}
    }
  </script>
</body>
</html>
