<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Client Login</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, sans-serif; display:flex; align-items:center; justify-content:center; min-height:100vh; background:#F8FAFC; }
    .login-container { background:#fff; padding:40px; border-radius:14px; box-shadow:0 12px 30px rgba(0,0,0,0.06); width:100%; max-width:420px; border-top:5px solid #6366F1; }
    .form-group { margin-bottom:16px; }
    .btn { width:100%; padding:12px; border-radius:8px; border:none; font-weight:700; cursor:pointer; }
    .btn-primary { background:#06B6D4; color:#fff; }
    .btn-disabled { opacity:.7; cursor:not-allowed; }
    #status { text-align:center; margin-top:12px; min-height:1.1em; font-weight:600; }
    #status.error { color:#DC2626; }
    #status.ok { color:#06B6D4; }
    #force-login-wrap { margin-top:12px; text-align:center; display:none; }
    #force-login-btn { margin-top:8px; padding:10px 14px; border-radius:8px; background:#EF4444; color:#fff; border:none; cursor:pointer; font-weight:700; }
    a.small { display:block; margin-top:12px; text-decoration:underline; color:#6366F1; }
  </style>
</head>
<body>
  <div class="login-container">
    <h1 style="text-align:center; font-size:28px; margin-bottom:18px;"><span style="color:#6366F1">Client</span> Portal</h1>

    <form id="login-form" autocomplete="on" novalidate>
      <div class="form-group">
        <label>Username</label>
        <input id="username" name="username" type="text" required style="width:100%; padding:10px; border-radius:8px; border:1px solid #CBD5E1;">
      </div>

      <div class="form-group">
        <label>Password</label>
        <input id="password" name="password" type="password" required style="width:100%; padding:10px; border-radius:8px; border:1px solid #CBD5E1;">
      </div>

      <button id="login-btn" class="btn btn-primary" type="submit">Secure Login</button>

      <div id="status" aria-live="polite"></div>

      <div id="force-login-wrap" role="region" aria-live="polite">
        <div id="force-msg" style="color:#DC2626; font-weight:700;">User already logged in on another device.</div>
        <button id="force-login-btn">Logout other device & login here</button>
      </div>

      <a href="index.html" class="small">← Back to Main Site</a>
    </form>
  </div>

  <script>
    const API_LOGIN_URL = '/api/client/login';
    const DASHBOARD_URL = 'client-dashboard.html';

    const form = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const statusEl = document.getElementById('status');
    const forceWrap = document.getElementById('force-login-wrap');
    const forceBtn = document.getElementById('force-login-btn');
    const forceMsg = document.getElementById('force-msg');

    // Keep last actionToken returned by server when alreadyLoggedIn
    let lastActionToken = null;
    let lastCredentials = null; // store username/password to retry when forcing (in-memory only)

    function setStatus(text = '', type = '') {
      statusEl.textContent = text;
      statusEl.className = (type === 'error') ? 'error' : (type === 'ok') ? 'ok' : '';
    }

    async function doLogin({ username, password, force = false, actionToken = null }) {
      // Validate
      if (!username || !password) { setStatus('Please enter username and password.', 'error'); return null; }

      loginBtn.disabled = true;
      loginBtn.classList.add('btn-disabled');
      loginBtn.textContent = 'Authenticating...';
      setStatus('Authenticating...', 'ok');

      try {
        const payload = { username, password };
        if (force) payload.force = true;
        if (actionToken) payload.actionToken = actionToken;

        const resp = await fetch(API_LOGIN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await resp.text().catch(()=>null);
        let json = null;
        try { json = text ? JSON.parse(text) : null; } catch(e) {
          // Non-JSON (server crash)
          setStatus('Server error: please contact support.', 'error');
          console.error('Non-JSON server response:', text);
          return null;
        }

        // If server returned OK or Success
        if (resp.ok && json && (json.status === 'Success' || json.status === 'OK' || json.status === 'Success')) {
          // Clean up force UI if present
          forceWrap.style.display = 'none';
          lastActionToken = null;
          localStorage.setItem('clientToken', json.token || '');
          if (json.planDetails) localStorage.setItem('planDetails', JSON.stringify(json.planDetails));
          localStorage.setItem('clientName', (json.planDetails && json.planDetails.clientName) || username);
          setStatus('Login successful — redirecting...', 'ok');
          setTimeout(()=> window.location.href = DASHBOARD_URL, 350);
          return json;
        }

        // Special: server told us user already logged in
        if (json && json.alreadyLoggedIn) {
          lastActionToken = json.actionToken || null;
          lastCredentials = { username, password };
          forceWrap.style.display = 'block';
          setStatus('User already logged in on another device.', 'error');
          return json;
        }

        // Known error cases returned from server (401, 403, etc)
        const msg = (json && (json.message || json.error)) || `Login failed (status ${resp.status})`;
        setStatus(msg, 'error');
        return json;

      } catch (err) {
        console.error('Login fetch error:', err);
        setStatus('Network error. Check your connection.', 'error');
        return null;
      } finally {
        loginBtn.disabled = false;
        loginBtn.classList.remove('btn-disabled');
        loginBtn.textContent = 'Secure Login';
      }
    }

    // Form submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setStatus('', '');
      forceWrap.style.display = 'none';
      lastActionToken = null;
      lastCredentials = null;

      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      await doLogin({ username, password });
    });

    // Force-login button handler
    forceBtn.addEventListener('click', async () => {
      setStatus('', '');
      if (!lastCredentials) {
        setStatus('Credentials missing for forced login. Please enter them again.', 'error');
        return;
      }

      // If server gave an actionToken, send it - otherwise send force=true (server may accept either)
      const actionToken = lastActionToken;
      const { username, password } = lastCredentials;

      if (!actionToken) {
        // fallback: try request with force=true (server might allow)
        setStatus('Attempting to logout other device and login here...', 'ok');
        await doLogin({ username, password, force: true, actionToken: null });
        return;
      }

      // Preferred: send actionToken (safe)
      setStatus('Confirming operation and logging in...', 'ok');
      await doLogin({ username, password, force: true, actionToken });
    });

    // If user is already logged in locally, redirect
    if (localStorage.getItem('clientToken')) {
      try { window.location.href = DASHBOARD_URL; } catch(e){ /* ignore */ }
    }
  </script>
</body>
</html>
